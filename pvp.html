<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PvP Arena â€” Idle Verse</title>
    <meta name="theme-color" content="#ff003c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit,
               getDocs, onSnapshot, updateDoc, serverTimestamp, where, Timestamp }
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import { getAuth, signInAnonymously, onAuthStateChanged }
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBoLEmaS9b00IiJBqOpsz0JJWHNvyTpQwk",
        authDomain: "idle-verse.firebaseapp.com",
        projectId: "idle-verse",
        storageBucket: "idle-verse.firebasestorage.app",
        messagingSenderId: "620608218292",
        appId: "1:620608218292:web:aca8885dfb78852d17e3e1"
      };

      const fbApp = initializeApp(firebaseConfig);
      const db    = getFirestore(fbApp);
      const auth  = getAuth(fbApp);
      let fbUid   = null;

      signInAnonymously(auth).catch(console.error);
      onAuthStateChanged(auth, user => {
        if (user) {
          fbUid = user.uid;
          window.fbUid = fbUid;
          window.pvpReady = true;
          if (window.onPvpReady) window.onPvpReady();
        }
      });

      // â”€â”€ Player lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbGetProfile = async function(username) {
        const q = query(collection(db,'players'), where('username','==',username), limit(1));
        const snap = await getDocs(q).catch(() => null);
        if (!snap || snap.empty) return null;
        return { uid: snap.docs[0].id, ...snap.docs[0].data() };
      };

      // â”€â”€ CHILL DUEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Send a duel challenge
      window.fbSendDuel = async function(toUid, toName, wager, myCPS, myUsername) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        const duelId = fbUid + '_duel_' + Date.now();
        const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 min to accept
        await setDoc(doc(db,'duels', duelId), {
          challengerUid: fbUid,    challengerName: myUsername,
          challengerCPS: myCPS,    challengerChillsStart: 0,
          defenderUid: toUid,      defenderName: toName,
          defenderCPS: 0,          defenderChillsStart: 0,
          wager,
          status: 'pending',       // pending | active | complete | declined | expired
          startTime: null,
          endTime: null,
          expiresAt: Timestamp.fromDate(expiresAt),
          createdAt: serverTimestamp(),
          winnerId: null,
          result: null,
        });
        return { ok: true, duelId };
      };

      // Accept a duel
      window.fbAcceptDuel = async function(duelId, myCPS) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        const duelRef = doc(db,'duels', duelId);
        const snap = await getDoc(duelRef).catch(() => null);
        if (!snap?.exists()) return { ok: false, msg: 'Duel not found' };
        const d = snap.data();
        if (d.status !== 'pending') return { ok: false, msg: 'Duel no longer pending' };
        if (d.defenderUid !== fbUid) return { ok: false, msg: 'Not your duel' };
        const now = Date.now();
        const endTime = new Date(now + 60 * 60 * 1000); // 1 hour battle
        await updateDoc(duelRef, {
          status: 'active',
          defenderCPS: myCPS,
          startTime: serverTimestamp(),
          endTime: Timestamp.fromDate(endTime),
        });
        return { ok: true };
      };

      // Decline a duel
      window.fbDeclineDuel = async function(duelId) {
        if (!fbUid) return;
        await updateDoc(doc(db,'duels', duelId), { status: 'declined' }).catch(() => {});
      };

      // Get active/pending duels for this player
      window.fbGetMyDuels = async function() {
        if (!fbUid) return [];
        const asChallenger = await getDocs(
          query(collection(db,'duels'), where('challengerUid','==',fbUid), limit(10))
        ).catch(() => null);
        const asDefender = await getDocs(
          query(collection(db,'duels'), where('defenderUid','==',fbUid), limit(10))
        ).catch(() => null);
        const all = [];
        if (asChallenger) asChallenger.docs.forEach(d => all.push({ id: d.id, ...d.data() }));
        if (asDefender) asDefender.docs.forEach(d => {
          if (!all.find(x => x.id === d.id)) all.push({ id: d.id, ...d.data() });
        });
        all.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        return all.slice(0,20);
      };

      // Settle an active duel â€” called by both players when timer ends
      window.fbSettleDuel = async function(duelId, myChillsEarned) {
        if (!fbUid) return { ok: false };
        const duelRef = doc(db,'duels', duelId);
        const snap = await getDoc(duelRef).catch(() => null);
        if (!snap?.exists()) return { ok: false };
        const d = snap.data();
        if (d.status !== 'active') return { ok: false, msg: 'Not active' };
        // Check if timer expired
        const endMs = d.endTime?.toMillis?.() || 0;
        if (Date.now() < endMs - 5000) return { ok: false, msg: 'Still running' };

        // Write our earned chills
        const isChallenger = d.challengerUid === fbUid;
        const update = isChallenger
          ? { challengerChillsStart: myChillsEarned }
          : { defenderChillsStart:   myChillsEarned };

        // If both are in â€” determine winner
        const otherEarned = isChallenger ? d.defenderChillsStart : d.challengerChillsStart;
        if (otherEarned > 0) {
          const challTotal = isChallenger ? myChillsEarned : d.challengerChillsStart;
          const defTotal   = isChallenger ? d.defenderChillsStart : myChillsEarned;
          const winnerId   = challTotal >= defTotal ? d.challengerUid : d.defenderUid;
          const winnerName = challTotal >= defTotal ? d.challengerName : d.defenderName;
          await updateDoc(duelRef, {
            ...update,
            status: 'complete',
            winnerId,
            result: { challengerEarned: challTotal, defenderEarned: defTotal, winnerName }
          });
          return { ok: true, settled: true, winnerId, challTotal, defTotal };
        }

        await updateDoc(duelRef, update);
        return { ok: true, settled: false };
      };

      // â”€â”€ HQ SIEGE (3-round raid) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbCanSiege = async function(targetUid) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        const today = new Date().toDateString();
        const siegeRef = doc(db,'sieges', fbUid + '_' + targetUid + '_' + today.replace(/ /g,'_'));
        const existing = await getDoc(siegeRef).catch(() => null);
        if (existing?.exists()) return { ok: false, msg: 'Already sieged this player today' };
        const shieldRef = doc(db,'hqShields', targetUid);
        const shield = await getDoc(shieldRef).catch(() => null);
        if (shield?.exists()) {
          const expiry = shield.data().expiry?.toMillis?.() || 0;
          if (expiry > Date.now()) return { ok: false, msg: 'ğŸ›¡ï¸ Target HQ is shielded!' };
        }
        return { ok: true };
      };

      window.fbLogSiege = async function(targetUid, rounds, won, chillReward, diamondReward, targetName, targetHqRank) {
        if (!fbUid) return;
        const today = new Date().toDateString();
        const siegeRef = doc(db,'sieges', fbUid + '_' + targetUid + '_' + today.replace(/ /g,'_'));
        await setDoc(siegeRef, {
          attackerUid: fbUid, attackerName: window.pvpState?.username || 'Anon',
          defenderUid: targetUid, defenderName: targetName, defenderHqRank: targetHqRank,
          rounds, won, chillReward, diamondReward,
          timestamp: serverTimestamp()
        });
      };

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&display=swap');

        :root {
            --c:  #00f5ff;
            --r:  #ff003c;
            --g:  #39ff14;
            --m:  #ffd700;
            --p:  #9d00ff;
            --bg: #020812;
            --panel: rgba(3,6,20,0.88);
        }

        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: #c8e8f0;
            overflow-x: hidden;
        }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-mono     { font-family: 'Share Tech Mono', monospace; }

        /* â”€â”€ BACKGROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #bg-grid {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background-color: var(--bg);
            overflow: hidden;
        }
        #bg-grid::before {
            content: '';
            position: absolute; inset: -50%;
            background-image:
                linear-gradient(rgba(255,0,60,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,0,60,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridDrift 20s linear infinite;
        }
        #bg-grid::after {
            content: '';
            position: absolute; inset: 0;
            background:
                radial-gradient(ellipse 60% 40% at 10% 20%, rgba(150,0,60,0.25) 0%, transparent 70%),
                radial-gradient(ellipse 50% 40% at 90% 80%, rgba(0,60,150,0.2) 0%, transparent 70%),
                radial-gradient(ellipse 80% 80% at 50% 50%, rgba(2,2,20,0.6) 0%, transparent 100%);
        }
        @keyframes gridDrift {
            0%   { transform: perspective(600px) rotateX(8deg) translateY(0); }
            100% { transform: perspective(600px) rotateX(8deg) translateY(40px); }
        }

        /* â”€â”€ SCANLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #scanlines {
            position: fixed; inset: 0; z-index: 9000; pointer-events: none;
            background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.1) 2px,rgba(0,0,0,0.1) 4px);
        }
        .red-scan {
            position: fixed; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, var(--r), transparent);
            opacity: 0.6;
            animation: scanDown 6s linear infinite;
            pointer-events: none; z-index: 8999;
        }
        @keyframes scanDown {
            0%   { top: -2px; opacity: 0; }
            5%   { opacity: 0.6; }
            95%  { opacity: 0.6; }
            100% { top: 100vh; opacity: 0; }
        }

        /* â”€â”€ GLASS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .glass {
            background: rgba(3,6,20,0.82);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(0,245,255,0.18);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .glass::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0,245,255,0.5), transparent);
            opacity: 0.5; pointer-events: none;
        }
        .glass-red {
            background: rgba(10,2,6,0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,0,60,0.25);
            border-radius: 4px;
            position: relative; overflow: hidden;
        }
        .glass-red::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--r), transparent);
            opacity: 0.6; pointer-events: none;
        }
        .glass-gold {
            background: rgba(8,6,2,0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 4px;
            position: relative; overflow: hidden;
        }
        .glass-gold::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--m), transparent);
            opacity: 0.6; pointer-events: none;
        }

        /* â”€â”€ NEON TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .neon-red  { color: var(--r); text-shadow: 0 0 8px rgba(255,0,60,0.9), 0 0 20px rgba(255,0,60,0.5); }
        .neon-cyan { color: var(--c); text-shadow: 0 0 8px rgba(0,245,255,0.9), 0 0 20px rgba(0,245,255,0.5); }
        .neon-gold { color: var(--m); text-shadow: 0 0 8px rgba(255,215,0,0.9), 0 0 20px rgba(255,215,0,0.5); }
        .neon-green { color: var(--g); text-shadow: 0 0 8px rgba(57,255,20,0.9), 0 0 20px rgba(57,255,20,0.5); }

        /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .top-bar {
            background: rgba(3,2,10,0.94);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,0,60,0.2);
            position: relative;
        }
        .top-bar::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--r), var(--c), var(--r), transparent);
            animation: barFlow 3s linear infinite;
        }
        @keyframes barFlow { 0%,100%{opacity:.3} 50%{opacity:.9} }

        /* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pvp-tab {
            transition: all 0.25s ease;
            border-bottom: 2px solid transparent;
        }
        .pvp-tab.active {
            border-bottom-color: var(--r);
            color: var(--r);
            text-shadow: 0 0 8px rgba(255,0,60,0.6);
        }

        /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-red {
            background: linear-gradient(135deg, rgba(255,0,60,0.2), rgba(157,0,0,0.15));
            border: 1px solid rgba(255,0,60,0.5);
            color: var(--r);
            transition: all 0.2s ease;
            font-family: 'Orbitron', sans-serif;
        }
        .btn-red:hover, .btn-red:active {
            box-shadow: 0 0 16px rgba(255,0,60,0.6), 0 0 32px rgba(255,0,60,0.2);
            border-color: rgba(255,0,60,0.9);
        }
        .btn-cyan {
            background: linear-gradient(135deg, rgba(0,245,255,0.15), rgba(0,100,200,0.1));
            border: 1px solid rgba(0,245,255,0.4);
            color: var(--c);
            transition: all 0.2s ease;
            font-family: 'Orbitron', sans-serif;
        }
        .btn-cyan:hover { box-shadow: 0 0 16px rgba(0,245,255,0.5); }
        .btn-gold {
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(200,100,0,0.1));
            border: 1px solid rgba(255,215,0,0.4);
            color: var(--m);
            transition: all 0.2s ease;
            font-family: 'Orbitron', sans-serif;
        }
        .btn-gold:hover { box-shadow: 0 0 16px rgba(255,215,0,0.5); }

        /* â”€â”€ STATUS DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--r);
            box-shadow: 0 0 6px var(--r);
            animation: blink 1.5s ease-in-out infinite;
            flex-shrink: 0;
        }
        .status-dot.online { background: var(--g); box-shadow: 0 0 6px var(--g); }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* â”€â”€ CLIP CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .clip-card {
            clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 12px, 100% 100%, 12px 100%, 0 calc(100% - 12px));
        }

        /* â”€â”€ VS DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .vs-divider {
            position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .vs-divider::before, .vs-divider::after {
            content: '';
            flex: 1; height: 1px;
        }
        .vs-divider::before { background: linear-gradient(90deg, transparent, var(--r)); }
        .vs-divider::after  { background: linear-gradient(90deg, var(--r), transparent); }

        /* â”€â”€ ROUND BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .round-badge {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 0.8rem;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.5s ease;
        }
        .round-badge.win  { background: rgba(57,255,20,0.2); border-color: var(--g); color: var(--g); box-shadow: 0 0 10px rgba(57,255,20,0.5); }
        .round-badge.loss { background: rgba(255,0,60,0.2);  border-color: var(--r); color: var(--r); box-shadow: 0 0 10px rgba(255,0,60,0.5); }
        .round-badge.draw { background: rgba(255,215,0,0.2); border-color: var(--m); color: var(--m); box-shadow: 0 0 10px rgba(255,215,0,0.5); }

        /* â”€â”€ SIEGE ARENA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .siege-arena {
            position: relative;
            min-height: 200px;
        }
        .combatant-card {
            transition: all 0.3s ease;
        }
        .combatant-card.attacking {
            animation: attackPulse 0.6s ease-out;
        }
        @keyframes attackPulse {
            0%   { transform: scale(1); }
            30%  { transform: scale(1.05); box-shadow: 0 0 30px rgba(255,0,60,0.6); }
            100% { transform: scale(1); }
        }

        /* â”€â”€ SIEGE ROUND ANIMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .round-clash {
            animation: clash 0.4s ease-out;
        }
        @keyframes clash {
            0%   { opacity: 0; transform: scale(0.5); }
            60%  { transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .prog-bar {
            height: 6px; border-radius: 3px;
            background: rgba(255,255,255,0.05);
            overflow: hidden;
        }
        .prog-fill {
            height: 100%; border-radius: 3px;
            transition: width 0.8s ease;
        }

        /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pvp-toast {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            z-index: 9999; min-width: 280px; max-width: 340px;
            animation: toastIn 0.3s ease-out;
        }
        .pvp-toast.out { animation: toastOut 0.4s ease-in forwards; }
        @keyframes toastIn  { from { opacity:0; transform: translateX(-50%) translateY(20px); } }
        @keyframes toastOut { to   { opacity:0; transform: translateX(-50%) translateY(-20px); } }

        /* â”€â”€ DUEL TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .duel-timer {
            font-variant-numeric: tabular-nums;
            font-family: 'Share Tech Mono', monospace;
            font-size: 2rem;
            color: var(--r);
            text-shadow: 0 0 12px rgba(255,0,60,0.8);
            animation: timerPulse 1s ease-in-out infinite;
        }
        @keyframes timerPulse { 0%,100%{opacity:1} 50%{opacity:0.7} }

        /* â”€â”€ HISTORY ITEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .history-item {
            border-left: 3px solid;
            transition: all 0.2s ease;
        }
        .history-item:hover { transform: translateX(3px); }

        /* â”€â”€ BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .bottom-nav {
            background: rgba(3,2,10,0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,0,60,0.15);
        }

        /* â”€â”€ RESULT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #resultOverlay {
            backdrop-filter: blur(20px);
        }
        .result-win  { border-color: rgba(57,255,20,0.5) !important; box-shadow: 0 0 40px rgba(57,255,20,0.3); }
        .result-loss { border-color: rgba(255,0,60,0.5) !important;  box-shadow: 0 0 40px rgba(255,0,60,0.3); }
        .result-draw { border-color: rgba(255,215,0,0.5) !important; box-shadow: 0 0 40px rgba(255,215,0,0.3); }

        /* â”€â”€ GLITCH TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .glitch { position: relative; }
        .glitch::before, .glitch::after {
            content: attr(data-text); position: absolute; inset: 0;
            font-family: inherit; font-size: inherit; font-weight: inherit;
        }
        .glitch::before { color: var(--r); animation: gT 5s steps(1) infinite; clip-path: polygon(0 0,100% 0,100% 35%,0 35%); }
        .glitch::after  { color: var(--c); animation: gB 5s steps(1) infinite; clip-path: polygon(0 65%,100% 65%,100% 100%,0 100%); }
        @keyframes gT { 0%,90%,100%{transform:translate(0);opacity:0} 92%{transform:translate(-3px,-1px);opacity:1} 94%{transform:translate(3px,0);opacity:1} 96%{opacity:0} }
        @keyframes gB { 0%,92%,100%{transform:translate(0);opacity:0} 93%{transform:translate(2px,1px);opacity:1} 95%{transform:translate(-2px,0);opacity:1} 97%{opacity:0} }

        /* â”€â”€ SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .spinner {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid rgba(255,0,60,0.2);
            border-top-color: var(--r);
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ DUEL WAGER INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        input[type=number], input[type=text] {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,0,60,0.2);
            color: white;
            outline: none;
        }
        input[type=number]:focus, input[type=text]:focus {
            border-color: rgba(255,0,60,0.5);
            box-shadow: 0 0 8px rgba(255,0,60,0.2);
        }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }

        /* scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,0,60,0.3); border-radius: 2px; }
    </style>
</head>
<body class="text-white">
    <!-- Background -->
    <div id="bg-grid"></div>
    <div id="scanlines"></div>
    <div class="red-scan"></div>

    <!-- ===== TOP BAR ===== -->
    <div class="top-bar px-4 py-3 sticky top-0 z-40">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <div class="flex items-center gap-3">
                <a href="index-4-1.html" class="text-white/50 hover:text-white transition-colors p-1" title="Back to Idle Verse">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div>
                    <p class="font-mono text-xs tracking-widest" style="color:rgba(255,0,60,0.5);">IDLE VERSE // PVP</p>
                    <h1 class="font-orbitron font-black text-base neon-red glitch" data-text="COMBAT ZONE">COMBAT ZONE</h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="playerStatBar" class="hidden flex items-center gap-2 px-3 py-1 rounded-full" style="background:rgba(255,0,60,0.08);border:1px solid rgba(255,0,60,0.2);">
                    <div class="status-dot online"></div>
                    <span id="topBarName" class="font-mono text-xs" style="color:rgba(0,245,255,0.8);">---</span>
                </div>
                <div class="flex items-center gap-1 px-2 py-1 rounded" style="border:1px solid rgba(255,215,0,0.3);background:rgba(255,215,0,0.05);">
                    <span class="font-mono text-xs" style="color:#ffd700;">â—†</span>
                    <span id="topBarDia" class="font-mono font-bold text-xs" style="color:#ffd700;">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MAIN CONTENT ===== -->
    <div class="max-w-lg mx-auto px-4 pb-28 pt-4 relative z-10">

        <!-- Player not loaded warning -->
        <div id="noPlayerWarning" class="glass-red rounded-2xl p-4 mb-4 text-center">
            <div class="flex items-center justify-center gap-2 mb-1">
                <div class="spinner"></div>
                <p class="font-orbitron text-sm text-red-400">SYNCING WITH VERSE...</p>
            </div>
            <p class="text-white/40 text-xs">Loading your profile from Idle Verse</p>
        </div>

        <!-- TAB SELECTOR -->
        <div class="flex gap-1 mb-5 p-1 rounded-xl" style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,0,60,0.1);">
            <button onclick="switchPvpTab('duel')" id="tabBtnDuel"
                class="pvp-tab flex-1 py-2.5 rounded-lg font-orbitron text-xs font-bold tracking-widest transition-all active"
                style="background:rgba(255,0,60,0.1);">
                âš¡ CHILL DUEL
            </button>
            <button onclick="switchPvpTab('siege')" id="tabBtnSiege"
                class="pvp-tab flex-1 py-2.5 rounded-lg font-orbitron text-xs font-bold tracking-widest transition-all text-white/40"
                style="background:transparent;">
                ğŸ° HQ SIEGE
            </button>
        </div>

        <!-- ==================== CHILL DUEL TAB ==================== -->
        <div id="tabDuel">

            <!-- Header info card -->
            <div class="glass rounded-2xl p-4 mb-4 flex items-start gap-3">
                <div class="text-3xl flex-shrink-0">âš¡</div>
                <div>
                    <p class="font-orbitron font-bold text-sm neon-red">CHILL DUEL</p>
                    <p class="text-white/50 text-xs mt-1 leading-relaxed">Challenge a player to a 1-hour CPS battle. Whoever earns more Chills during the window wins the wager. Loser's Chills transfer to the winner.</p>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="font-mono text-xs px-2 py-0.5 rounded" style="background:rgba(255,0,60,0.1);color:rgba(255,0,60,0.7);border:1px solid rgba(255,0,60,0.2);">1-HOUR BATTLE</span>
                        <span class="font-mono text-xs px-2 py-0.5 rounded" style="background:rgba(0,245,255,0.1);color:rgba(0,245,255,0.7);border:1px solid rgba(0,245,255,0.2);">CPS-BASED WIN</span>
                        <span class="font-mono text-xs px-2 py-0.5 rounded" style="background:rgba(255,215,0,0.1);color:rgba(255,215,0,0.7);border:1px solid rgba(255,215,0,0.2);">WAGER CHILLS</span>
                    </div>
                </div>
            </div>

            <!-- Active Duel Panel (shown when in a duel) -->
            <div id="activeDuelPanel" class="hidden glass-red rounded-2xl p-5 mb-4">
                <div class="flex items-center gap-2 mb-3">
                    <div class="status-dot"></div>
                    <p class="font-orbitron text-xs tracking-widest neon-red">ACTIVE DUEL</p>
                </div>
                <div class="vs-divider mb-4">
                    <div class="mx-3 font-orbitron font-black text-xl neon-red">VS</div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="glass rounded-xl p-3 text-center">
                        <p class="font-mono text-xs text-white/40 mb-1">YOU</p>
                        <p id="duelMyName" class="font-orbitron font-bold text-sm neon-cyan truncate">---</p>
                        <p id="duelMyCPS" class="font-mono text-xs mt-1" style="color:rgba(0,245,255,0.6);">0 CPS</p>
                        <p id="duelMyEarned" class="font-orbitron font-bold text-lg neon-cyan mt-1">0</p>
                        <p class="text-white/30 text-xs">Chills earned</p>
                    </div>
                    <div class="glass rounded-xl p-3 text-center">
                        <p class="font-mono text-xs text-white/40 mb-1">OPPONENT</p>
                        <p id="duelOppName" class="font-orbitron font-bold text-sm neon-red truncate">---</p>
                        <p id="duelOppCPS" class="font-mono text-xs mt-1" style="color:rgba(255,0,60,0.6);">0 CPS</p>
                        <p id="duelOppEarned" class="font-orbitron font-bold text-lg neon-red mt-1">?</p>
                        <p class="text-white/30 text-xs">Chills earned</p>
                    </div>
                </div>
                <div class="text-center mb-3">
                    <p class="font-mono text-xs text-white/40 mb-1">TIME REMAINING</p>
                    <div id="duelTimerDisplay" class="duel-timer">--:--</div>
                </div>
                <div class="prog-bar mb-3">
                    <div id="duelProgressFill" class="prog-fill" style="width:0%;background:linear-gradient(90deg,var(--r),var(--c));"></div>
                </div>
                <div class="text-center">
                    <p class="font-mono text-xs text-white/30">WAGER: <span id="duelWagerDisplay" class="text-white/60">0</span> CHILLS</p>
                </div>
            </div>

            <!-- Pending Duel Panel (challenger waiting / defender needs to accept) -->
            <div id="pendingDuelPanel" class="hidden glass-gold rounded-2xl p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <div class="status-dot" style="background:var(--m);box-shadow:0 0 6px var(--m);"></div>
                    <p class="font-orbitron text-xs tracking-widest neon-gold">PENDING DUEL</p>
                </div>
                <p id="pendingDuelInfo" class="text-white/60 text-sm mb-3">Waiting for opponent to accept...</p>
                <div class="flex gap-2" id="pendingDuelActions"></div>
            </div>

            <!-- Challenge Form -->
            <div id="challengeForm" class="glass rounded-2xl p-5 mb-4">
                <p class="font-orbitron text-sm neon-cyan mb-4 tracking-widest">âš¡ ISSUE CHALLENGE</p>
                <div class="space-y-3">
                    <div>
                        <label class="font-mono text-xs text-white/40 block mb-1 tracking-widest">TARGET PLAYER</label>
                        <input type="text" id="duelTarget" placeholder="Enter username..."
                            class="w-full rounded-xl px-4 py-3 text-sm font-orbitron"
                            style="border:1px solid rgba(255,0,60,0.2);border-radius:12px;">
                    </div>
                    <div>
                        <label class="font-mono text-xs text-white/40 block mb-1 tracking-widest">WAGER (CHILLS)</label>
                        <div class="flex gap-2 flex-wrap mb-2">
                            <button onclick="setWager(100e6)" class="btn-red px-3 py-1 rounded-lg text-xs font-bold">100M</button>
                            <button onclick="setWager(500e6)" class="btn-red px-3 py-1 rounded-lg text-xs font-bold">500M</button>
                            <button onclick="setWager(1e9)"   class="btn-red px-3 py-1 rounded-lg text-xs font-bold">1B</button>
                            <button onclick="setWager(5e9)"   class="btn-red px-3 py-1 rounded-lg text-xs font-bold">5B</button>
                            <button onclick="setWager(10e9)"  class="btn-gold px-3 py-1 rounded-lg text-xs font-bold">10B</button>
                        </div>
                        <input type="number" id="duelWager" placeholder="Amount in Chills..."
                            class="w-full rounded-xl px-4 py-3 text-sm font-orbitron"
                            style="border:1px solid rgba(255,0,60,0.2);border-radius:12px;">
                        <p class="font-mono text-xs mt-1" style="color:rgba(255,0,60,0.4);">Min: 100M Chills</p>
                    </div>
                    <button onclick="sendDuelChallenge()" class="btn-red w-full py-3 rounded-xl font-bold text-sm tracking-widest">
                        âš¡ SEND CHALLENGE
                    </button>
                </div>
            </div>

            <!-- Duel History -->
            <div class="glass rounded-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="font-orbitron text-xs neon-cyan tracking-widest">DUEL HISTORY</p>
                    <button onclick="refreshDuels()" class="font-mono text-xs text-white/30 hover:text-white transition-colors">â†» Refresh</button>
                </div>
                <div id="duelHistoryList" class="space-y-2">
                    <p class="text-white/30 text-xs text-center py-4">No duels yet</p>
                </div>
            </div>
        </div>

        <!-- ==================== HQ SIEGE TAB ==================== -->
        <div id="tabSiege" class="hidden">

            <!-- Header info card -->
            <div class="glass rounded-2xl p-4 mb-4 flex items-start gap-3">
                <div class="text-3xl flex-shrink-0">ğŸ°</div>
                <div>
                    <p class="font-orbitron font-bold text-sm neon-red">HQ SIEGE</p>
                    <p class="text-white/50 text-xs mt-1 leading-relaxed">A 3-round tactical assault on another player's HQ. Win 2 of 3 rounds to claim loot. Your equipped HQ items activate per round â€” Chill Trap, Neon Armor, and Shields all matter here.</p>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="font-mono text-xs px-2 py-0.5 rounded" style="background:rgba(255,0,60,0.1);color:rgba(255,0,60,0.7);border:1px solid rgba(255,0,60,0.2);">3 ROUNDS</span>
                        <span class="font-mono text-xs px-2 py-0.5 rounded" style="background:rgba(0,245,255,0.1);color:rgba(0,245,255,0.7);border:1px solid rgba(0,245,255,0.2);">ITEMS MATTER</span>
                        <span class="font-mono text-xs px-2 py-0.5 rounded" style="background:rgba(255,215,0,0.1);color:rgba(255,215,0,0.7);border:1px solid rgba(255,215,0,0.2);">WIN 2/3 ROUNDS</span>
                    </div>
                </div>
            </div>

            <!-- Your Combat Stats -->
            <div id="myItemsDisplay" class="glass-gold rounded-2xl p-4 mb-4">
                <p class="font-orbitron text-xs neon-gold tracking-widest mb-3">YOUR COMBAT LOADOUT</p>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="glass rounded-xl p-2">
                        <p class="text-xl mb-1">ğŸª¤</p>
                        <p class="font-orbitron text-xs text-white/60">Chill Trap</p>
                        <p id="itemChillTrap" class="font-bold text-xs mt-1 text-white/40">â€”</p>
                    </div>
                    <div class="glass rounded-xl p-2">
                        <p class="text-xl mb-1">ğŸ›¡ï¸</p>
                        <p class="font-orbitron text-xs text-white/60">Neon Armor</p>
                        <p id="itemNeonArmor" class="font-bold text-xs mt-1 text-white/40">â€”</p>
                    </div>
                    <div class="glass rounded-xl p-2">
                        <p class="text-xl mb-1">ğŸ”°</p>
                        <p class="font-orbitron text-xs text-white/60">Shield</p>
                        <p id="itemShield" class="font-bold text-xs mt-1 text-white/40">â€”</p>
                    </div>
                </div>
                <p class="text-white/30 text-xs text-center mt-2">Items are consumed automatically during the siege</p>
            </div>

            <!-- Target Selection -->
            <div id="siegeTargetForm" class="glass rounded-2xl p-5 mb-4">
                <p class="font-orbitron text-sm neon-red mb-4 tracking-widest">ğŸ¯ SELECT TARGET</p>
                <div class="space-y-3">
                    <div>
                        <label class="font-mono text-xs text-white/40 block mb-1 tracking-widest">TARGET PLAYER USERNAME</label>
                        <input type="text" id="siegeTarget" placeholder="Enter username..."
                            class="w-full rounded-xl px-4 py-3 text-sm font-orbitron"
                            style="border:1px solid rgba(255,0,60,0.2);border-radius:12px;">
                    </div>
                    <button onclick="lookupSiegeTarget()" class="btn-cyan w-full py-3 rounded-xl font-bold text-sm tracking-widest">
                        ğŸ” RECON TARGET
                    </button>
                </div>
            </div>

            <!-- Target Profile Card (shown after lookup) -->
            <div id="siegeTargetCard" class="hidden glass-red rounded-2xl p-5 mb-4">
                <div class="flex items-center gap-2 mb-3">
                    <div class="status-dot"></div>
                    <p class="font-mono text-xs tracking-widest" style="color:rgba(255,0,60,0.6);">TARGET IDENTIFIED</p>
                </div>
                <div class="space-y-2 text-sm mb-4">
                    <div class="flex justify-between">
                        <span class="text-white/40">Designation</span>
                        <span id="tgtName" class="font-orbitron font-bold neon-red">---</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white/40">HQ Rank</span>
                        <span id="tgtHQRank" class="font-bold" style="color:rgba(157,0,255,0.9);">---</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white/40">Total Chills</span>
                        <span id="tgtChills" class="text-white/70">---</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white/40">Diamonds</span>
                        <span id="tgtDia" class="neon-gold font-bold">---</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white/40">Est. Win Chance</span>
                        <span id="tgtWinChance" class="font-bold font-orbitron neon-green">---</span>
                    </div>
                </div>
                <div class="glass rounded-xl p-3 mb-4">
                    <p class="font-mono text-xs text-white/40 mb-1">SIEGE COST</p>
                    <p class="font-orbitron font-bold text-white">500M Chills + 10 â—†</p>
                    <p class="text-white/30 text-xs mt-1">One siege per target per day</p>
                </div>
                <button onclick="launchSiege()" id="siegeLaunchBtn" class="btn-red w-full py-3 rounded-xl font-bold text-sm tracking-widest">
                    âš”ï¸ LAUNCH SIEGE
                </button>
            </div>

            <!-- Siege Arena (shown during siege animation) -->
            <div id="siegeArena" class="hidden glass-red rounded-2xl p-5 mb-4">
                <div class="flex items-center gap-2 mb-4">
                    <div class="status-dot"></div>
                    <p class="font-orbitron text-xs neon-red tracking-widest">SIEGE IN PROGRESS</p>
                </div>

                <!-- Round indicators -->
                <div class="flex justify-center gap-4 mb-6" id="roundBadges">
                    <div class="round-badge" id="round1Badge">1</div>
                    <div class="round-badge" id="round2Badge">2</div>
                    <div class="round-badge" id="round3Badge">3</div>
                </div>

                <!-- Combatants -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="combatant-card glass rounded-xl p-3 text-center" id="attackerCard">
                        <p class="text-2xl mb-1">âš”ï¸</p>
                        <p id="arenaMyName" class="font-orbitron font-bold text-xs neon-cyan truncate">YOU</p>
                        <p class="font-mono text-xs mt-1" style="color:rgba(0,245,255,0.4);">ATTACKER</p>
                        <div id="attackerItems" class="flex justify-center gap-1 mt-2"></div>
                    </div>
                    <div class="combatant-card glass-red rounded-xl p-3 text-center" id="defenderCard">
                        <p class="text-2xl mb-1">ğŸ°</p>
                        <p id="arenaOppName" class="font-orbitron font-bold text-xs neon-red truncate">TARGET</p>
                        <p class="font-mono text-xs mt-1" style="color:rgba(255,0,60,0.4);">DEFENDER</p>
                        <div id="defenderItems" class="flex justify-center gap-1 mt-2"></div>
                    </div>
                </div>

                <!-- Round log -->
                <div id="roundLog" class="glass rounded-xl p-3 space-y-2 min-h-16">
                    <p class="text-white/30 text-xs text-center">Siege commencing...</p>
                </div>
            </div>

            <!-- Siege History -->
            <div class="glass rounded-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="font-orbitron text-xs neon-cyan tracking-widest">SIEGE HISTORY</p>
                    <button onclick="loadSiegeHistory()" class="font-mono text-xs text-white/30 hover:text-white transition-colors">â†» Refresh</button>
                </div>
                <div id="siegeHistoryList" class="space-y-2">
                    <p class="text-white/30 text-xs text-center py-4">No sieges yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== RESULT OVERLAY ===== -->
    <div id="resultOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background:rgba(0,0,0,0.85);">
        <div id="resultCard" class="glass-red rounded-2xl p-6 w-full max-w-sm text-center border-2">
            <div id="resultIcon" class="text-5xl mb-3">âš”ï¸</div>
            <p id="resultTitle" class="font-orbitron font-black text-2xl mb-2">---</p>
            <p id="resultSubtitle" class="text-white/60 text-sm mb-4">---</p>
            <div id="resultDetails" class="glass rounded-xl p-3 mb-4 space-y-1 text-sm"></div>
            <button onclick="closeResult()" class="btn-red w-full py-3 rounded-xl font-bold tracking-widest">
                CONTINUE
            </button>
        </div>
    </div>

    <!-- ===== BOTTOM NAV ===== -->
    <div class="bottom-nav fixed bottom-0 left-0 right-0 z-40 px-4 py-3">
        <div class="max-w-lg mx-auto flex items-center justify-between">
            <a href="index-4-1.html" class="flex flex-col items-center gap-1 text-white/40 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span class="font-orbitron text-xs">HOME</span>
            </a>
            <div class="flex flex-col items-center gap-1">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background:rgba(255,0,60,0.15);border:1px solid rgba(255,0,60,0.4);">
                    <span class="text-lg">âš”ï¸</span>
                </div>
                <span class="font-orbitron text-xs neon-red">PVP</span>
            </div>
            <button onclick="refreshDuels();loadSiegeHistory();" class="flex flex-col items-center gap-1 text-white/40 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span class="font-orbitron text-xs">REFRESH</span>
            </button>
        </div>
    </div>

    <script>
    // ============================================================
    //  PVP PAGE â€” MAIN JAVASCRIPT
    // ============================================================

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let pvpState = null;      // loaded from localStorage
    let activeDuel = null;    // current active duel doc
    let duelTimer  = null;    // interval for duel countdown
    let siegeTargetData = null; // looked-up siege target

    // â”€â”€ Load gameState from localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadPvpState() {
        try {
            const raw = localStorage.getItem('idleVerseState') || localStorage.getItem('chillVerseState');
            if (raw) pvpState = JSON.parse(raw);
        } catch(e) {}
        window.pvpState = pvpState;
    }

    function formatNum(n) {
        if (!n || isNaN(n)) return '0';
        if (n >= 1e12) return (n/1e12).toFixed(2) + 'T';
        if (n >= 1e9)  return (n/1e9).toFixed(2) + 'B';
        if (n >= 1e6)  return (n/1e6).toFixed(2) + 'M';
        if (n >= 1e3)  return (n/1e3).toFixed(1) + 'K';
        return Math.floor(n).toLocaleString();
    }

    // â”€â”€ Compute local CPS from pvpState â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getLocalCPS() {
        if (!pvpState) return 0;
        let cps = 0;
        const gs = pvpState;
        const globalMult = 1 + (gs.diamondUpgrades?.find(u=>u.id==='globalMult')?.level||0)*0.1;
        const walletBonus = gs.walletConnected ? 1.25 : 1;
        const achMult = gs.achievementCpsMult || 1;
        (gs.producers||[]).forEach((p,i) => {
            const pMult = (gs.producerMults||{})['p'+i] || 1;
            cps += (p.owned||0) * (p.baseProduction||0) * pMult;
        });
        // HQ CPS bonus
        const HQ_ROOMS_IDS = ['lounge','studio','warroom','tower','archive','throne'];
        let hqCpsMult = 1;
        if (gs.hqRooms) {
            const roomBonuses = {lounge:[0.02,0.04,0.07],studio:[0.03,0.06,0.10],warroom:[0.03,0.06,0.10],tower:[0.04,0.08,0.12],archive:[0.06,0.12,0.20],throne:[0.08,0.15,0.25]};
            HQ_ROOMS_IDS.forEach(id => {
                const tier = gs.hqRooms[id]||0;
                const bonuses = roomBonuses[id]||[];
                for (let t=0;t<tier;t++) hqCpsMult += bonuses[t]||0;
            });
        }
        return cps * globalMult * walletBonus * achMult * hqCpsMult;
    }

    // â”€â”€ Update top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateTopBar() {
        if (!pvpState) return;
        document.getElementById('topBarName').textContent = pvpState.username || 'ANON';
        document.getElementById('topBarDia').textContent  = Math.floor(pvpState.diamonds||0);
        document.getElementById('playerStatBar').classList.remove('hidden');
        document.getElementById('noPlayerWarning').classList.add('hidden');
    }

    // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchPvpTab(tab) {
        document.getElementById('tabDuel').classList.toggle('hidden', tab !== 'duel');
        document.getElementById('tabSiege').classList.toggle('hidden', tab !== 'siege');
        const btnD = document.getElementById('tabBtnDuel');
        const btnS = document.getElementById('tabBtnSiege');
        if (tab === 'duel') {
            btnD.classList.add('active');     btnD.classList.remove('text-white/40'); btnD.style.background='rgba(255,0,60,0.1)';
            btnS.classList.remove('active');  btnS.classList.add('text-white/40');    btnS.style.background='transparent';
        } else {
            btnS.classList.add('active');     btnS.classList.remove('text-white/40'); btnS.style.background='rgba(255,0,60,0.1)';
            btnD.classList.remove('active');  btnD.classList.add('text-white/40');    btnD.style.background='transparent';
            updateLoadout();
        }
    }

    // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(html) {
        const t = document.createElement('div');
        t.className = 'pvp-toast';
        t.innerHTML = html;
        document.body.appendChild(t);
        setTimeout(() => {
            t.classList.add('out');
            setTimeout(() => t.remove(), 400);
        }, 4000);
    }

    // â”€â”€ Result overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showResult(icon, title, subtitle, details, type) {
        document.getElementById('resultIcon').textContent = icon;
        document.getElementById('resultTitle').textContent = title;
        document.getElementById('resultTitle').className = `font-orbitron font-black text-2xl mb-2 ${type==='win'?'neon-green':type==='loss'?'neon-red':'neon-gold'}`;
        document.getElementById('resultSubtitle').textContent = subtitle;
        document.getElementById('resultDetails').innerHTML = details;
        const card = document.getElementById('resultCard');
        card.className = `glass rounded-2xl p-6 w-full max-w-sm text-center border-2 ${type==='win'?'result-win':type==='loss'?'result-loss':'result-draw'}`;
        document.getElementById('resultOverlay').classList.remove('hidden');
    }

    function closeResult() {
        document.getElementById('resultOverlay').classList.add('hidden');
        refreshDuels();
    }

    // ================================================================
    //  CHILL DUEL
    // ================================================================

    function setWager(amount) {
        document.getElementById('duelWager').value = amount;
    }

    async function sendDuelChallenge() {
        if (!pvpState) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Load Idle Verse first!</p></div>'); return; }
        if (!window.pvpReady) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Not connected yet. Wait a moment.</p></div>'); return; }

        const target = document.getElementById('duelTarget').value.trim();
        const wager  = Math.floor(parseFloat(document.getElementById('duelWager').value)||0);

        if (!target) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Enter a username!</p></div>'); return; }
        if (target === pvpState.username) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Can\'t duel yourself!</p></div>'); return; }
        if (wager < 100e6) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Minimum wager: 100M Chills</p></div>'); return; }
        if ((pvpState.chills||0) < wager) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Not enough Chills! Need '+formatNum(wager)+'</p></div>'); return; }

        // Look up target
        const profile = await window.fbGetProfile(target);
        if (!profile) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Player not found</p></div>'); return; }

        const myCPS = getLocalCPS();
        const result = await window.fbSendDuel(profile.uid, target, wager, myCPS, pvpState.username);
        if (!result.ok) {
            showToast(`<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">${result.msg}</p></div>`);
            return;
        }

        // Deduct wager from local state
        pvpState.chills = (pvpState.chills||0) - wager;
        try { localStorage.setItem('idleVerseState', JSON.stringify(pvpState)); } catch(e) {}

        showToast(`<div class="glass rounded-xl p-3 text-center" style="border:1px solid rgba(0,245,255,0.4);"><p class="font-orbitron text-xs neon-cyan">âš¡ Challenge sent to ${target}!</p><p class="text-white/40 text-xs mt-1">Waiting for them to accept (10 min)</p></div>`);
        document.getElementById('duelTarget').value = '';
        document.getElementById('duelWager').value = '';
        refreshDuels();
    }

    async function acceptDuel(duelId) {
        if (!pvpState || !window.pvpReady) return;
        const myCPS = getLocalCPS();

        // Look up wager from stored duels
        const allDuels = await window.fbGetMyDuels();
        const duel = allDuels.find(d => d.id === duelId);
        if (!duel) return;

        if ((pvpState.chills||0) < duel.wager) {
            showToast(`<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Not enough Chills! Need ${formatNum(duel.wager)}</p></div>`);
            return;
        }

        const result = await window.fbAcceptDuel(duelId, myCPS);
        if (!result.ok) {
            showToast(`<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">${result.msg}</p></div>`);
            return;
        }

        // Deduct wager
        pvpState.chills = (pvpState.chills||0) - duel.wager;
        try { localStorage.setItem('idleVerseState', JSON.stringify(pvpState)); } catch(e) {}

        showToast(`<div class="glass rounded-xl p-3 text-center" style="border:1px solid rgba(57,255,20,0.4);"><p class="font-orbitron text-xs neon-green">âœ… Duel accepted! 1-hour battle started!</p></div>`);
        refreshDuels();
    }

    async function declineDuel(duelId) {
        if (!window.pvpReady) return;
        await window.fbDeclineDuel(duelId);
        showToast(`<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs text-white/60">Duel declined</p></div>`);
        refreshDuels();
    }

    // â”€â”€ Duel countdown & settlement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startDuelCountdown(duel) {
        activeDuel = duel;
        if (duelTimer) clearInterval(duelTimer);

        const amChallenger = duel.challengerUid === window.fbUid;
        const myName  = amChallenger ? duel.challengerName : duel.defenderName;
        const oppName = amChallenger ? duel.defenderName   : duel.challengerName;
        const myCPS   = amChallenger ? (duel.challengerCPS||0) : (duel.defenderCPS||0);
        const oppCPS  = amChallenger ? (duel.defenderCPS||0)   : (duel.challengerCPS||0);

        document.getElementById('activeDuelPanel').classList.remove('hidden');
        document.getElementById('duelMyName').textContent  = myName;
        document.getElementById('duelOppName').textContent = oppName;
        document.getElementById('duelMyCPS').textContent   = formatNum(myCPS) + ' CPS';
        document.getElementById('duelOppCPS').textContent  = formatNum(oppCPS) + ' CPS';
        document.getElementById('duelWagerDisplay').textContent = formatNum(duel.wager);

        const startMs = duel.startTime?.toMillis?.() || Date.now();
        const endMs   = duel.endTime?.toMillis?.()   || (startMs + 3600000);
        const duration = endMs - startMs;

        duelTimer = setInterval(async () => {
            const now       = Date.now();
            const remaining = Math.max(0, endMs - now);
            const elapsed   = now - startMs;
            const pct       = Math.min(100, (elapsed / duration) * 100);

            const m  = Math.floor(remaining / 60000);
            const s  = Math.floor((remaining % 60000) / 1000);
            document.getElementById('duelTimerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            document.getElementById('duelProgressFill').style.width = pct + '%';

            // Estimate my earned chills = myCPS * elapsed
            const myEarned = Math.floor(myCPS * elapsed / 1000);
            document.getElementById('duelMyEarned').textContent = formatNum(myEarned);

            if (remaining <= 0) {
                clearInterval(duelTimer);
                duelTimer = null;
                document.getElementById('duelTimerDisplay').textContent = '00:00';
                document.getElementById('duelTimerDisplay').style.color = '#39ff14';

                // Settle
                await settleDuelNow(duel, myCPS, startMs, endMs, amChallenger, oppCPS, oppName, myName);
            }
        }, 1000);
    }

    async function settleDuelNow(duel, myCPS, startMs, endMs, amChallenger, oppCPS, oppName, myName) {
        const elapsed = endMs - startMs;
        const myEarned  = Math.floor(myCPS  * elapsed / 1000);
        const oppEarned = Math.floor(oppCPS * elapsed / 1000);

        const result = await window.fbSettleDuel(duel.id, myEarned);
        const iWon = myEarned >= oppEarned;

        // Award/deduct
        if (iWon) {
            pvpState.chills = (pvpState.chills||0) + (duel.wager * 2); // get back own + opponent's
            pvpState.totalChills = (pvpState.totalChills||0) + duel.wager;
        }
        // (if lost, wager was already deducted on accept)
        try { localStorage.setItem('idleVerseState', JSON.stringify(pvpState)); } catch(e) {}

        document.getElementById('activeDuelPanel').classList.add('hidden');
        activeDuel = null;

        showResult(
            iWon ? 'âš¡' : 'ğŸ’€',
            iWon ? 'DUEL WON!' : 'DUEL LOST',
            iWon ? `You outproduced ${oppName}!` : `${oppName} outproduced you`,
            `<div class="flex justify-between text-xs"><span class="text-white/50">Your Chills earned</span><span class="neon-cyan font-bold">${formatNum(myEarned)}</span></div>
             <div class="flex justify-between text-xs mt-1"><span class="text-white/50">Opponent earned</span><span class="neon-red font-bold">${formatNum(oppEarned)}</span></div>
             <div class="flex justify-between text-xs mt-1"><span class="text-white/50">Wager</span><span class="${iWon?'neon-green':'neon-red'} font-bold">${iWon?'+':'-'}${formatNum(duel.wager)} Chills</span></div>`,
            iWon ? 'win' : 'loss'
        );
        refreshDuels();
    }

    // â”€â”€ Render duel history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshDuels() {
        if (!window.pvpReady || !window.fbGetMyDuels) return;
        const duels = await window.fbGetMyDuels();
        const list  = document.getElementById('duelHistoryList');

        // Check for active duels first
        const active  = duels.find(d => d.status === 'active');
        const pending = duels.find(d => d.status === 'pending');

        // Active duel
        if (active && !activeDuel) {
            startDuelCountdown(active);
        } else if (!active) {
            document.getElementById('activeDuelPanel').classList.add('hidden');
        }

        // Pending duels
        const myUid = window.fbUid;
        const pendingAsDefender = duels.find(d => d.status === 'pending' && d.defenderUid === myUid);
        const pendingAsChallenger = duels.find(d => d.status === 'pending' && d.challengerUid === myUid);

        if (pendingAsDefender) {
            document.getElementById('pendingDuelPanel').classList.remove('hidden');
            document.getElementById('pendingDuelInfo').textContent = `âš¡ ${pendingAsDefender.challengerName} challenges you! Wager: ${formatNum(pendingAsDefender.wager)} Chills`;
            document.getElementById('pendingDuelActions').innerHTML = `
                <button onclick="acceptDuel('${pendingAsDefender.id}')" class="btn-cyan flex-1 py-2 rounded-xl text-xs font-bold">âœ… ACCEPT</button>
                <button onclick="declineDuel('${pendingAsDefender.id}')" class="btn-red flex-1 py-2 rounded-xl text-xs font-bold">âŒ DECLINE</button>`;
        } else if (pendingAsChallenger) {
            document.getElementById('pendingDuelPanel').classList.remove('hidden');
            document.getElementById('pendingDuelInfo').textContent = `â³ Waiting for ${pendingAsChallenger.defenderName} to accept... Wager: ${formatNum(pendingAsChallenger.wager)} Chills`;
            document.getElementById('pendingDuelActions').innerHTML = `<button onclick="declineDuel('${pendingAsChallenger.id}')" class="btn-red flex-1 py-2 rounded-xl text-xs font-bold">CANCEL CHALLENGE</button>`;
        } else {
            document.getElementById('pendingDuelPanel').classList.add('hidden');
        }

        // History
        const history = duels.filter(d => ['complete','declined','expired'].includes(d.status));
        if (!history.length) {
            list.innerHTML = '<p class="text-white/30 text-xs text-center py-4">No completed duels yet</p>';
            return;
        }
        list.innerHTML = history.slice(0,10).map(d => {
            const isCh = d.challengerUid === myUid;
            const opp  = isCh ? d.defenderName : d.challengerName;
            const iWon = d.winnerId === myUid;
            const color = d.status==='complete' ? (iWon?'var(--g)':'var(--r)') : 'rgba(255,255,255,0.2)';
            const label = d.status==='complete' ? (iWon?'WIN':'LOSS') : d.status.toUpperCase();
            const icon  = d.status==='complete' ? (iWon?'âš¡':'ğŸ’€') : (d.status==='declined'?'âŒ':'â³');
            const res   = d.result ? `${formatNum(d.result.challengerEarned)} vs ${formatNum(d.result.defenderEarned)}` : 'â€”';
            return `<div class="history-item glass rounded-xl p-3 flex items-center justify-between gap-2" style="border-left-color:${color};">
                <span class="text-lg">${icon}</span>
                <div class="flex-1 min-w-0">
                    <p class="font-orbitron text-xs font-bold text-white truncate">vs ${opp}</p>
                    <p class="font-mono text-xs mt-0.5" style="color:rgba(255,255,255,0.3);">${res}</p>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="font-orbitron font-bold text-xs" style="color:${color};">${label}</p>
                    <p class="font-mono text-xs" style="color:rgba(255,255,255,0.3);">${formatNum(d.wager)}C</p>
                </div>
            </div>`;
        }).join('');
    }

    // ================================================================
    //  HQ SIEGE
    // ================================================================

    function updateLoadout() {
        if (!pvpState) return;
        const hasTrap   = pvpState.chillTrapActive;
        const hasArmor  = pvpState.neonArmorActive;
        const shield    = pvpState.hqShieldExpiry && pvpState.hqShieldExpiry > Date.now();

        const trapEl  = document.getElementById('itemChillTrap');
        const armEl   = document.getElementById('itemNeonArmor');
        const shdEl   = document.getElementById('itemShield');

        if (trapEl)  { trapEl.textContent  = hasTrap  ? 'âœ… READY' : 'Not equipped'; trapEl.style.color = hasTrap  ? 'var(--g)' : 'rgba(255,255,255,0.25)'; }
        if (armEl)   { armEl.textContent   = hasArmor ? 'âœ… READY' : 'Not equipped'; armEl.style.color  = hasArmor ? 'var(--g)' : 'rgba(255,255,255,0.25)'; }
        if (shdEl)   { shdEl.textContent   = shield   ? 'ğŸ›¡ï¸ ACTIVE' : 'Inactive';    shdEl.style.color  = shield   ? 'var(--m)' : 'rgba(255,255,255,0.25)'; }
    }

    async function lookupSiegeTarget() {
        if (!window.pvpReady || !window.fbGetProfile) {
            showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Not connected yet</p></div>');
            return;
        }
        const username = document.getElementById('siegeTarget').value.trim();
        if (!username) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Enter a username!</p></div>'); return; }
        if (pvpState && username === pvpState.username) { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Can\'t siege yourself!</p></div>'); return; }

        document.getElementById('siegeTargetCard').classList.add('hidden');
        showToast('<div class="glass rounded-xl p-3 text-center" style="border:1px solid rgba(0,245,255,0.3)"><p class="font-orbitron text-xs neon-cyan">ğŸ” Scanning target...</p></div>');

        const profile = await window.fbGetProfile(username);
        if (!profile) {
            showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Player not found</p></div>');
            return;
        }

        siegeTargetData = profile;

        // Calculate win chance
        const rankToTier = {'Empty Lot':0,'Starter Pad':1,'Chill Den':5,'Gang HQ':10,'Verse Fortress':15,'Diamond Empire':20,'Chill Legion':25,'ğŸ‘‘ THE VERSE THRONE':30};
        const myHQTiers = pvpState ? Object.values(pvpState.hqRooms||{}).reduce((a,b)=>a+(b||0),0) : 0;
        const tgtTiers  = rankToTier[profile.hqRank] || 5;
        let winChance   = Math.min(0.85, Math.max(0.15, 0.5 + (myHQTiers - tgtTiers) * 0.025));
        // NFT raid bonus
        const nftCount  = (pvpState?.ownedNfts||[]).length;
        winChance = Math.min(0.85, winChance + nftCount * 0.01);

        document.getElementById('tgtName').textContent     = profile.username;
        document.getElementById('tgtHQRank').textContent   = profile.hqRank || 'Empty Lot';
        document.getElementById('tgtChills').textContent   = formatNum(profile.totalChills||0);
        document.getElementById('tgtDia').textContent      = (profile.diamonds||0) + ' â—†';
        document.getElementById('tgtWinChance').textContent = Math.round(winChance*100) + '%';
        document.getElementById('tgtWinChance').style.color = winChance > 0.6 ? 'var(--g)' : winChance > 0.4 ? 'var(--m)' : 'var(--r)';
        document.getElementById('siegeTargetCard').classList.remove('hidden');
    }

    async function launchSiege() {
        if (!pvpState || !window.pvpReady || !siegeTargetData) return;

        const SIEGE_COST_CHILLS   = 500e6;
        const SIEGE_COST_DIAMONDS = 10;

        if ((pvpState.chills||0) < SIEGE_COST_CHILLS)   { showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Need 500M Chills to siege!</p></div>'); return; }
        if ((pvpState.diamonds||0) < SIEGE_COST_DIAMONDS){ showToast('<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">Need 10 â—† to siege!</p></div>'); return; }

        const tgt = siegeTargetData;

        // Check if can siege
        const canSiege = await window.fbCanSiege(tgt.uid);
        if (!canSiege.ok) { showToast(`<div class="glass-red rounded-xl p-3 text-center"><p class="font-orbitron text-xs neon-red">${canSiege.msg}</p></div>`); return; }

        // Deduct cost
        pvpState.chills   -= SIEGE_COST_CHILLS;
        pvpState.diamonds -= SIEGE_COST_DIAMONDS;
        try { localStorage.setItem('idleVerseState', JSON.stringify(pvpState)); } catch(e) {}
        document.getElementById('topBarDia').textContent = Math.floor(pvpState.diamonds||0);

        // Hide target card, show arena
        document.getElementById('siegeTargetCard').classList.add('hidden');
        document.getElementById('siegeTargetForm').classList.add('hidden');
        document.getElementById('siegeArena').classList.remove('hidden');

        // Set combatant names
        document.getElementById('arenaMyName').textContent  = pvpState.username || 'YOU';
        document.getElementById('arenaOppName').textContent = tgt.username;

        // Calculate fight
        await runSiegeAnimation(tgt);
    }

    async function runSiegeAnimation(tgt) {
        const rankToTier = {'Empty Lot':0,'Starter Pad':1,'Chill Den':5,'Gang HQ':10,'Verse Fortress':15,'Diamond Empire':20,'Chill Legion':25,'ğŸ‘‘ THE VERSE THRONE':30};
        const myHQTiers = pvpState ? Object.values(pvpState.hqRooms||{}).reduce((a,b)=>a+(b||0),0) : 0;
        const tgtTiers  = rankToTier[tgt.hqRank] || 5;
        const nftRaidBonus = (pvpState?.ownedNfts||[]).reduce((sum,n) => sum + (n.rarity==='legend'?0.08:n.rarity==='rare'?0.04:0.01), 0);
        const baseWin = Math.min(0.85, Math.max(0.15, 0.5 + (myHQTiers - tgtTiers) * 0.025 + nftRaidBonus));

        // HQ Items
        let hasTrap  = pvpState.chillTrapActive  || false;
        let hasArmor = pvpState.neonArmorActive  || false;

        // 3 rounds
        const roundResults = [];
        const roundLog = document.getElementById('roundLog');
        roundLog.innerHTML = '';

        for (let r = 0; r < 3; r++) {
            await sleep(800);

            // Apply item effects per round
            let roundWinBonus = 0;
            let defenseBonus  = 0;
            const itemsUsed = [];

            if (hasTrap && r === 0) {
                roundWinBonus += 0.08;
                itemsUsed.push('ğŸª¤ Chill Trap active (+8% win)');
                hasTrap = false;
                pvpState.chillTrapActive = false;
            }
            if (hasArmor && r === 1 && roundResults.filter(x=>!x).length >= 1) {
                defenseBonus += 0.15;
                itemsUsed.push('ğŸ›¡ï¸ Neon Armor active (+15% defense)');
                hasArmor = false;
                pvpState.neonArmorActive = false;
            }

            // Random factor per round
            const roundChance = Math.min(0.90, Math.max(0.10, baseWin + roundWinBonus - defenseBonus + (Math.random()*0.2 - 0.1)));
            const won = Math.random() < roundChance;
            roundResults.push(won);

            // Animate badge
            const badge = document.getElementById(`round${r+1}Badge`);
            badge.classList.add('round-clash');
            badge.classList.add(won ? 'win' : 'loss');
            badge.textContent = won ? 'âœ“' : 'âœ—';

            // Animate attacker/defender
            if (won) {
                document.getElementById('attackerCard').classList.add('attacking');
                setTimeout(() => document.getElementById('attackerCard').classList.remove('attacking'), 700);
            }

            // Log entry
            const logEntry = document.createElement('div');
            logEntry.className = `text-xs font-mono py-1 px-2 rounded flex items-center gap-2 round-clash`;
            logEntry.style.background = won ? 'rgba(57,255,20,0.08)' : 'rgba(255,0,60,0.08)';
            logEntry.style.borderLeft = `2px solid ${won ? 'var(--g)' : 'var(--r)'}`;
            logEntry.innerHTML = `<span>${won ? 'âš”ï¸' : 'ğŸ’€'}</span> <span style="color:${won?'var(--g)':'var(--r)'}">Round ${r+1}: ${won ? 'BREAKTHROUGH' : 'REPELLED'}</span>${itemsUsed.length ? `<span class="text-white/30 ml-auto">${itemsUsed[0]}</span>` : ''}`;
            roundLog.appendChild(logEntry);

            await sleep(600);
        }

        // Determine siege winner (win 2/3)
        const roundsWon = roundResults.filter(Boolean).length;
        const siegeWon  = roundsWon >= 2;

        await sleep(600);

        // Calculate loot
        let chillReward   = 0;
        let diamondReward = 0;

        if (siegeWon) {
            const nftLootBonus = (pvpState?.ownedNfts||[]).reduce((sum,n)=>sum+(n.rarity==='legend'?0.15:n.rarity==='rare'?0.08:0.02),0);
            const maxChillLoot = Math.floor((tgt.totalChills||50e6) * (0.25 + nftLootBonus));
            chillReward = Math.floor(maxChillLoot * (0.4 + Math.random() * 0.4));
            const maxDia = Math.min(20, Math.floor((tgt.diamonds||0) * 0.2));
            diamondReward = maxDia > 0 ? Math.floor(Math.random() * (maxDia + 1)) : 0;

            pvpState.chills = (pvpState.chills||0) + chillReward;
            pvpState.totalChills = (pvpState.totalChills||0) + chillReward;
            if (diamondReward > 0) {
                pvpState.diamonds = (pvpState.diamonds||0) + diamondReward;
                pvpState.totalDiamonds = (pvpState.totalDiamonds||0) + diamondReward;
            }
        } else if (hasArmor) {
            // Neon armor triggers on full siege loss
            pvpState.neonArmorActive = false;
        }

        // Save
        try { localStorage.setItem('idleVerseState', JSON.stringify(pvpState)); } catch(e) {}
        document.getElementById('topBarDia').textContent = Math.floor(pvpState.diamonds||0);

        // Log to Firestore
        await window.fbLogSiege(tgt.uid, roundResults, siegeWon, chillReward, diamondReward, tgt.username, tgt.hqRank);

        // Show result
        await sleep(800);
        document.getElementById('siegeArena').classList.add('hidden');
        document.getElementById('siegeTargetForm').classList.remove('hidden');

        showResult(
            siegeWon ? 'ğŸ†' : 'ğŸ’€',
            siegeWon ? 'SIEGE SUCCESSFUL!' : 'SIEGE FAILED',
            siegeWon ? `Rounds won: ${roundsWon}/3` : `Only won ${roundsWon}/3 rounds`,
            `<div class="flex justify-between text-xs"><span class="text-white/50">Rounds won</span><span class="font-bold" style="color:${siegeWon?'var(--g)':'var(--r)'};">${roundsWon} / 3</span></div>
             ${siegeWon ? `<div class="flex justify-between text-xs mt-1"><span class="text-white/50">Chills looted</span><span class="neon-cyan font-bold">+${formatNum(chillReward)}</span></div>` : ''}
             ${siegeWon && diamondReward > 0 ? `<div class="flex justify-between text-xs mt-1"><span class="text-white/50">Diamonds looted</span><span class="neon-gold font-bold">+${diamondReward} â—†</span></div>` : ''}
             <div class="flex justify-between text-xs mt-1"><span class="text-white/50">Siege cost</span><span class="text-red-400 font-bold">-500M Chills, -10 â—†</span></div>
             <div class="flex justify-between text-xs mt-1"><span class="text-white/50">vs</span><span class="text-white/60">${tgt.username} (${tgt.hqRank||'Empty Lot'})</span></div>`,
            siegeWon ? 'win' : 'loss'
        );

        loadSiegeHistory();
    }

    // â”€â”€ Load siege history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadSiegeHistory() {
        if (!window.pvpReady || !window.fbUid) return;
        const { getFirestore, collection, query, where, orderBy, limit, getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
        // We read from the same firebase app â€” use global db via window reference
        // Instead we'll use fbGetMyDuels pattern â€” stored sieges
        // For siege history, we look at local pvpState.siegeHistory
        const hist = pvpState?.siegeHistory || [];
        const el   = document.getElementById('siegeHistoryList');
        if (!hist.length) {
            el.innerHTML = '<p class="text-white/30 text-xs text-center py-4">No sieges yet</p>';
            return;
        }
        el.innerHTML = hist.slice(0,10).map(s => {
            const color = s.won ? 'var(--g)' : 'var(--r)';
            return `<div class="history-item glass rounded-xl p-3 flex items-center justify-between gap-2" style="border-left-color:${color};">
                <span class="text-lg">${s.won ? 'ğŸ†' : 'ğŸ’€'}</span>
                <div class="flex-1 min-w-0">
                    <p class="font-orbitron text-xs font-bold text-white truncate">vs ${s.defenderName||'Unknown'}</p>
                    <p class="font-mono text-xs mt-0.5" style="color:rgba(255,255,255,0.3);">Rounds: ${s.roundsWon||0}/3</p>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="font-orbitron font-bold text-xs" style="color:${color};">${s.won?'WIN':'LOSS'}</p>
                    ${s.chillReward ? `<p class="font-mono text-xs neon-cyan">+${formatNum(s.chillReward)}</p>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // â”€â”€ Initialize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.onPvpReady = function() {
        loadPvpState();
        updateTopBar();
        updateLoadout();
        refreshDuels();
        loadSiegeHistory();
        if (lucide) lucide.createIcons();
    };

    // Also try immediately in case auth resolved before this ran
    document.addEventListener('DOMContentLoaded', () => {
        loadPvpState();
        updateTopBar();
        if (window.pvpReady) {
            refreshDuels();
            loadSiegeHistory();
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    </script>
</body>
</html>
