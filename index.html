<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Idle Verse - Chill Verse Presents</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f3ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Idle Verse">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs, onSnapshot, updateDoc, increment, serverTimestamp, where, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBoLEmaS9b00IiJBqOpsz0JJWHNvyTpQwk",
        authDomain: "idle-verse.firebaseapp.com",
        projectId: "idle-verse",
        storageBucket: "idle-verse.firebasestorage.app",
        messagingSenderId: "620608218292",
        appId: "1:620608218292:web:aca8885dfb78852d17e3e1"
      };

      const fbApp  = initializeApp(firebaseConfig);
      const db     = getFirestore(fbApp);
      const auth   = getAuth(fbApp);
      let   fbUid  = null;
      let   fbServerTimeOffset = 0;

      // â”€â”€ Auth: silent anonymous sign-in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      signInAnonymously(auth).catch(console.error);
      onAuthStateChanged(auth, user => {
        if (user) {
          fbUid = user.uid;
          window.fbUid = fbUid;
          // Sync server time offset using a tiny Firestore write
          const ref = doc(db, '_time', 'ping');
          setDoc(ref, { t: serverTimestamp() }).then(() =>
            getDoc(ref).then(snap => {
              if (snap.exists()) {
                const srv = snap.data().t?.toMillis?.() || Date.now();
                fbServerTimeOffset = srv - Date.now();
                window.fbServerTimeOffset = fbServerTimeOffset;
              }
            })
          ).catch(() => {});
          // Load incoming gifts
          loadIncomingGifts();
          // Subscribe to leaderboard
          subscribeLeaderboard();
          // Subscribe to community pot
          subscribePot();
          // Check for expired market listings (return unsold items)
          setTimeout(() => { if (window.fbExpireListings) window.fbExpireListings(); }, 2000);
        }
      });

      // â”€â”€ Server time helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.getServerNow = () => Date.now() + (window.fbServerTimeOffset || 0);

      // â”€â”€ Push player stats to Firestore (called on saveGame) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbSyncPlayer = async function(state) {
        if (!fbUid) return;
        const data = {
          username:    state.username || 'Anonymous',
          totalChills: state.totalChills || 0,
          diamonds:    state.diamonds || 0,
          hqRank:      window.getHQRankForSync ? window.getHQRankForSync() : 'Empty Lot',
          nftCount:    (state.ownedNfts || []).length,
          achCount:    Object.keys(state.achievements || {}).length,
          lastSeen:    serverTimestamp(),
        };
        try {
          await setDoc(doc(db, 'players', fbUid), data, { merge: true });
          await setDoc(doc(db, 'leaderboard', fbUid), {
            username:    data.username,
            totalChills: data.totalChills,
            diamonds:    data.diamonds,
            hqRank:      data.hqRank,
            achCount:    data.achCount,
            lastUpdated: serverTimestamp(),
          }, { merge: true });
        } catch(e) {}
      };

      // â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbLeaderboardData = { chills: [], diamonds: [], hq: [] };

      function subscribeLeaderboard() {
        // Top 50 by totalChills
        const qC = query(collection(db,'leaderboard'), orderBy('totalChills','desc'), limit(50));
        onSnapshot(qC, snap => {
          window.fbLeaderboardData.chills = snap.docs.map((d,i) => ({ rank: i+1, ...d.data(), uid: d.id }));
          if (window.renderLeaderboard) window.renderLeaderboard();
        });
        // Top 50 by diamonds
        const qD = query(collection(db,'leaderboard'), orderBy('diamonds','desc'), limit(50));
        onSnapshot(qD, snap => {
          window.fbLeaderboardData.diamonds = snap.docs.map((d,i) => ({ rank: i+1, ...d.data(), uid: d.id }));
        });
        // Top 50 by achCount
        const qH = query(collection(db,'leaderboard'), orderBy('achCount','desc'), limit(50));
        onSnapshot(qH, snap => {
          window.fbLeaderboardData.hq = snap.docs.map((d,i) => ({ rank: i+1, ...d.data(), uid: d.id }));
        });
      }

      // â”€â”€ GIFTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbSendGift = async function(toUsername, amount, currency) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        // Find recipient by username
        const q = query(collection(db,'players'), where('username','==', toUsername), limit(1));
        const snap = await getDocs(q).catch(() => null);
        if (!snap || snap.empty) return { ok: false, msg: 'Player not found' };
        const toUid = snap.docs[0].id;
        if (toUid === fbUid) return { ok: false, msg: "Can't gift yourself!" };
        // Write gift doc
        await setDoc(doc(db, 'gifts', fbUid + '_' + Date.now()), {
          from:      fbUid,
          fromName:  window.gameState?.username || 'Anonymous',
          toUid,
          toName:    toUsername,
          amount,
          currency,
          timestamp: serverTimestamp(),
          claimed:   false,
        });
        return { ok: true };
      };

      window.loadIncomingGifts = loadIncomingGifts;
      async function loadIncomingGifts() {
        if (!fbUid) return;
        const q = query(collection(db,'gifts'), where('toUid','==',fbUid), where('claimed','==',false), limit(20));
        const snap = await getDocs(q).catch(() => null);
        if (!snap || snap.empty) return;
        let totalChills = 0, totalDiamonds = 0, msgs = [];
        for (const d of snap.docs) {
          const g = d.data();
          // Handle returned marketplace items
          if (g.returnedItem) {
            if (window.gameState) {
              if (!window.gameState.ownedNfts) window.gameState.ownedNfts = [];
              // Only add if not already added by fbExpireListings
              const alreadyBack = window.gameState.ownedNfts.some(n => n.name === g.returnedItem.name && n.returnedAt);
              if (!alreadyBack) {
                window.gameState.ownedNfts.push({ ...g.returnedItem, returnedAt: Date.now() });
                window.gameState.nftCount = (window.gameState.nftCount || 0) + 1;
              }
            }
            msgs.push(`ðŸª ${g.message || g.returnedItem.name + ' returned from Black Market'}`);
            await updateDoc(doc(db,'gifts', d.id), { claimed: true });
            continue;
          }
          if (g.currency === 'chills')   totalChills   += g.amount;
          if (g.currency === 'diamonds') totalDiamonds += g.amount;
          msgs.push(`${g.fromName} sent you ${g.amount?.toLocaleString()} ${g.currency === 'chills' ? 'Chills' : "â—†"}`);
          await updateDoc(doc(db,'gifts', d.id), { claimed: true });
        }
        if (totalChills > 0 || totalDiamonds > 0 || msgs.length > 0) {
          window.applyGiftReward(totalChills, totalDiamonds, msgs);
        }
      }

      // â”€â”€ PLAYER PROFILE LOOKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbGetProfile = async function(username) {
        const q = query(collection(db,'players'), where('username','==',username), limit(1));
        const snap = await getDocs(q).catch(() => null);
        if (!snap || snap.empty) return null;
        return { uid: snap.docs[0].id, ...snap.docs[0].data() };
      };

      // â”€â”€ FRIENDS SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbSendFriendRequest = async function(toUsername) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        const q = query(collection(db,'players'), where('username','==',toUsername), limit(1));
        const snap = await getDocs(q).catch(() => null);
        if (!snap || snap.empty) return { ok: false, msg: 'Player not found' };
        const toUid = snap.docs[0].id;
        if (toUid === fbUid) return { ok: false, msg: "Can't add yourself!" };
        // Check existing
        const existing = await getDoc(doc(db, 'friendRequests', fbUid + '_' + toUid)).catch(() => null);
        if (existing?.exists()) return { ok: false, msg: 'Request already sent' };
        // Check if already friends
        const fr = await getDoc(doc(db, 'friends', fbUid, 'list', toUid)).catch(() => null);
        if (fr?.exists()) return { ok: false, msg: 'Already friends!' };
        await setDoc(doc(db, 'friendRequests', fbUid + '_' + toUid), {
          fromUid: fbUid, fromName: window.gameState?.username || 'Anonymous',
          toUid, toName: toUsername, status: 'pending', timestamp: serverTimestamp()
        });
        return { ok: true };
      };

      window.fbGetIncomingRequests = async function() {
        if (!fbUid) return [];
        const q = query(collection(db,'friendRequests'), where('toUid','==',fbUid), where('status','==','pending'));
        const snap = await getDocs(q).catch(() => null);
        return snap ? snap.docs.map(d => ({ id: d.id, ...d.data() })) : [];
      };

      window.fbAcceptFriendRequest = async function(reqId, fromUid, fromName) {
        if (!fbUid) return;
        const myName = window.gameState?.username || 'Anonymous';
        await setDoc(doc(db,'friends',fbUid,'list',fromUid), { username: fromName, since: serverTimestamp() });
        await setDoc(doc(db,'friends',fromUid,'list',fbUid), { username: myName, since: serverTimestamp() });
        await updateDoc(doc(db,'friendRequests', reqId), { status: 'accepted' });
      };

      window.fbDeclineFriendRequest = async function(reqId) {
        await updateDoc(doc(db,'friendRequests', reqId), { status: 'declined' }).catch(() => {});
      };

      window.fbGetFriends = async function() {
        if (!fbUid) return [];
        const snap = await getDocs(collection(db,'friends',fbUid,'list')).catch(() => null);
        return snap ? snap.docs.map(d => ({ uid: d.id, ...d.data() })) : [];
      };

      window.fbRemoveFriend = async function(friendUid) {
        if (!fbUid) return;
        await setDoc(doc(db,'friends',fbUid,'list',friendUid), { removed: true }, { merge: true });
      };

      // â”€â”€ RAID SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbCanRaid = async function(targetUid) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        const today = new Date().toDateString();
        // Check if target was raided today by this player
        const raidRef = doc(db,'raids', fbUid + '_' + targetUid + '_' + today.replace(/ /g,'_'));
        const existing = await getDoc(raidRef).catch(() => null);
        if (existing?.exists()) return { ok: false, msg: 'Already raided this player today' };
        // Check if target has shield
        const shieldRef = doc(db,'hqShields', targetUid);
        const shield = await getDoc(shieldRef).catch(() => null);
        if (shield?.exists()) {
          const expiry = shield.data().expiry?.toMillis?.() || 0;
          if (expiry > Date.now()) return { ok: false, msg: 'Target HQ is shielded! ðŸ›¡ï¸' };
        }
        return { ok: true };
      };

      window.fbLogRaid = async function(targetUid, won, reward, defenderName, defenderHqRank, diamondReward) {
        if (!fbUid) return;
        const today = new Date().toDateString();
        const raidRef = doc(db,'raids', fbUid + '_' + targetUid + '_' + today.replace(/ /g,'_'));
        await setDoc(raidRef, {
          attackerUid: fbUid, attackerName: window.gameState?.username || 'Anon',
          defenderUid: targetUid,
          defenderName: defenderName || targetUid.slice(0,8),
          defenderHqRank: defenderHqRank || 'Unknown',
          won, reward, diamondReward: diamondReward || 0,
          timestamp: serverTimestamp()
        });
      };

      window.fbActivateShield = async function() {
        if (!fbUid) return;
        const expiry = new Date(Date.now() + 24 * 60 * 60 * 1000);
        await setDoc(doc(db,'hqShields',fbUid), { expiry: Timestamp.fromDate(expiry), uid: fbUid });
      };

      window.fbGetRaidHistory = async function() {
        if (!fbUid) return [];
        const q = query(collection(db,'raids'), where('attackerUid','==',fbUid), orderBy('timestamp','desc'), limit(10));
        const snap = await getDocs(q).catch(() => null);
        return snap ? snap.docs.map(d => d.data()) : [];
      };

      // â”€â”€ COMMUNITY POT v2 (3 winners) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbPotData = { pot: 0, totalStaked: 0, top3: [], weekEnd: 0, recentStakes: [] };

      function subscribePot() {
        onSnapshot(doc(db,'communityPot','week'), snap => {
          if (snap.exists()) {
            const d = snap.data();
            window.fbPotData = {
              pot:         d.pot || 0,
              totalStaked: d.totalStaked || 0,
              top3:        d.top3 || [],
              weekEnd:     d.weekEnd?.toMillis?.() || 0,
              recentStakes: d.recentStakes || [],
            };
            if (window.renderPotUI) window.renderPotUI();
          }
        });
      }

      window.fbContributePot = async function(stakeAmount, username) {
        if (!fbUid) return;
        const contribution = Math.floor(stakeAmount * 0.30); // 30% contribution
        const potRef  = doc(db, 'communityPot', 'week');
        const potSnap = await getDoc(potRef).catch(() => null);
        const now     = Date.now() + (window.fbServerTimeOffset || 0);
        const d = new Date(now);
        const daysUntilSun = (7 - d.getUTCDay()) % 7 || 7;
        const weekEnd = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate() + daysUntilSun));

        // Player's weekly stake entry
        const entryRef = doc(db, 'stakeEntries', fbUid);
        const entrySnap = await getDoc(entryRef).catch(() => null);
        const weekStart = new Date(weekEnd); weekStart.setUTCDate(weekEnd.getUTCDate() - 7);
        let weeklyTotal = stakeAmount;
        if (entrySnap?.exists()) {
          const e = entrySnap.data();
          const entryWeekStart = e.weekStart?.toMillis?.() || 0;
          if (entryWeekStart >= weekStart.getTime()) weeklyTotal += (e.weeklyStakeTotal || 0);
        }
        await setDoc(entryRef, { username, weeklyStakeTotal: weeklyTotal, weekStart: Timestamp.fromDate(weekStart), uid: fbUid }, { merge: true });

        // Recent stake entry
        const recentEntry = { name: username, amount: stakeAmount, time: now };

        // Update pot
        if (!potSnap?.exists()) {
          const top3 = [{ uid: fbUid, name: username, amount: weeklyTotal }];
          await setDoc(potRef, { pot: contribution, totalStaked: stakeAmount, top3, weekEnd: Timestamp.fromDate(weekEnd), recentStakes: [recentEntry] });
        } else {
          const p = potSnap.data();
          let top3 = p.top3 || [];
          // Update or insert this player
          const idx = top3.findIndex(x => x.uid === fbUid);
          if (idx >= 0) { top3[idx] = { uid: fbUid, name: username, amount: weeklyTotal }; }
          else { top3.push({ uid: fbUid, name: username, amount: weeklyTotal }); }
          top3.sort((a,b) => b.amount - a.amount);
          top3 = top3.slice(0, 3);
          let recentStakes = [recentEntry, ...(p.recentStakes || [])].slice(0, 10);
          const updates = {
            pot: increment(contribution),
            totalStaked: increment(stakeAmount),
            top3,
            recentStakes,
          };
          if (!p.weekEnd) updates.weekEnd = Timestamp.fromDate(weekEnd);
          await updateDoc(potRef, updates);
        }
      };

      window.fbClaimPotWin = async function(position) {
        if (!fbUid) return { ok: false };
        const potRef  = doc(db,'communityPot','week');
        const potSnap = await getDoc(potRef).catch(() => null);
        if (!potSnap?.exists()) return { ok: false };
        const p = potSnap.data();
        const now = Date.now() + (window.fbServerTimeOffset || 0);
        if ((p.weekEnd?.toMillis?.() || 0) > now) return { ok: false, msg: 'Week not over yet' };
        const top3 = p.top3 || [];
        const myPos = top3.findIndex(x => x.uid === fbUid);
        if (myPos !== position) return { ok: false, msg: 'Not your position' };
        // Check claim record
        const claimRef = doc(db,'potClaims', fbUid + '_' + (p.weekEnd?.toMillis?.() || 0));
        const claimSnap = await getDoc(claimRef).catch(() => null);
        if (claimSnap?.exists()) return { ok: false, msg: 'Already claimed' };
        await setDoc(claimRef, { claimed: true, position, timestamp: serverTimestamp() });
        const pot = p.pot || 0;
        const diamondRewards = [700, 500, 200];
        const chillPcts = [0.5, 0.3, 0.2];
        return { ok: true, diamonds: diamondRewards[position], chills: Math.floor(pot * chillPcts[position]) };
      };

      // â”€â”€ DAILY LEADERBOARD REWARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbCheckDailyLeaderboardReward = async function() {
        if (!fbUid) return;
        const today = new Date().toDateString();
        const rewardRef = doc(db,'dailyLbRewards', fbUid + '_' + today.replace(/ /g,'_'));
        const existing = await getDoc(rewardRef).catch(() => null);
        if (existing?.exists()) return; // already rewarded today
        // Check top 3 chills leaderboard
        const q = query(collection(db,'leaderboard'), orderBy('totalChills','desc'), limit(3));
        const snap = await getDocs(q).catch(() => null);
        if (!snap) return;
        const top3 = snap.docs.map((d,i) => ({ rank: i, uid: d.id }));
        const myRank = top3.findIndex(x => x.uid === fbUid);
        if (myRank < 0) return;
        const diamondReward = [3,2,1][myRank];
        // Mark as rewarded
        await setDoc(rewardRef, { uid: fbUid, rank: myRank, diamonds: diamondReward, date: today, timestamp: serverTimestamp() });
        // Send as gift
        await setDoc(doc(db,'gifts', fbUid + '_dailylb_' + Date.now()), {
          from: 'SYSTEM', fromName: 'ðŸ… Daily Leaderboard',
          toUid: fbUid, toName: window.gameState?.username || 'Player',
          amount: diamondReward, currency: 'diamonds',
          timestamp: serverTimestamp(), claimed: false,
        });
        if (window.loadIncomingGifts) window.loadIncomingGifts();
      };

      // â”€â”€ BLACK MARKET LISTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fbListNFT = async function(nft, priceChills, priceDiamonds) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        const listingId = fbUid + '_' + Date.now();
        const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24h from now
        await setDoc(doc(db,'marketplace', listingId), {
          sellerUid: fbUid, sellerName: window.gameState?.username || 'Anonymous',
          type: 'nft', item: nft, priceChills: priceChills || 0, priceDiamonds: priceDiamonds || 0,
          listed: true, timestamp: serverTimestamp(),
          expiresAt: Timestamp.fromDate(expiresAt),
          listedAt: Date.now(),
        });
        return { ok: true, id: listingId };
      };

      window.fbGetMarketListings = async function() {
        // Simple query â€” no orderBy to avoid needing composite index
        const q = query(collection(db,'marketplace'), where('listed','==',true), limit(50));
        const snap = await getDocs(q).catch(() => null);
        if (!snap) return [];
        const now = Date.now();
        const listings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // Sort by listedAt descending client-side
        listings.sort((a, b) => (b.listedAt || 0) - (a.listedAt || 0));
        return listings.slice(0, 30);
      };

      // Check for expired listings â€” called on login â€” returns items to seller via gift
      window.fbExpireListings = async function() {
        if (!fbUid) return;
        const now = Date.now();
        // Only check this player's own expired listings
        const q = query(
          collection(db,'marketplace'),
          where('sellerUid','==',fbUid),
          where('listed','==',true),
          limit(20)
        );
        const snap = await getDocs(q).catch(() => null);
        if (!snap) return;
        for (const d of snap.docs) {
          const data = d.data();
          const expiresAt = data.expiresAt?.toMillis?.() || (data.listedAt || 0) + 24 * 60 * 60 * 1000;
          if (now >= expiresAt) {
            // Mark expired
            await updateDoc(doc(db,'marketplace', d.id), { listed: false, expired: true }).catch(() => {});
            // Return item to seller as a gift notification
            await setDoc(doc(db,'gifts', fbUid + '_return_' + d.id), {
              from: 'SYSTEM', fromName: 'ðŸª Black Market',
              toUid: fbUid, toName: data.sellerName || '',
              amount: 0, currency: 'chills',
              returnedItem: data.item || null,
              message: (data.item?.name || 'Item') + ' was not sold and has been returned to you.',
              timestamp: serverTimestamp(), claimed: false,
            }).catch(() => {});
            // Return NFT directly to local game state
            if (window.gameState && data.item) {
              if (!window.gameState.ownedNfts) window.gameState.ownedNfts = [];
              window.gameState.ownedNfts.push({ ...data.item, returnedAt: now });
              window.gameState.nftCount = (window.gameState.nftCount || 0) + 1;
              if (window.saveGame) window.saveGame();
              if (window.updateUI) window.updateUI();
            }
          }
        }
      };

      window.fbBuyMarketItem = async function(listingId, currency) {
        if (!fbUid) return { ok: false, msg: 'Not connected' };
        const listRef = doc(db,'marketplace', listingId);
        const listSnap = await getDoc(listRef).catch(() => null);
        if (!listSnap?.exists()) return { ok: false, msg: 'Listing not found' };
        const listing = listSnap.data();
        if (!listing.listed) return { ok: false, msg: 'Already sold' };
        if (listing.sellerUid === fbUid) return { ok: false, msg: "Can't buy your own listing" };
        await updateDoc(listRef, { listed: false, buyerUid: fbUid, buyerName: window.gameState?.username, soldAt: serverTimestamp() });
        // Send payment to seller
        const amount = currency === 'diamonds' ? listing.priceDiamonds : listing.priceChills;
        if (amount > 0) {
          await setDoc(doc(db,'gifts', fbUid + '_mktpay_' + Date.now()), {
            from: fbUid, fromName: window.gameState?.username || 'Buyer',
            toUid: listing.sellerUid, toName: listing.sellerName,
            amount, currency, timestamp: serverTimestamp(), claimed: false,
          });
        }
        return { ok: true, item: listing };
      };

      window.fbCancelListing = async function(listingId) {
        if (!fbUid) return;
        await updateDoc(doc(db,'marketplace', listingId), { listed: false }).catch(() => {});
      };

    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'verse-dark': '#0a0a1f',
                        'verse-darker': '#050510',
                        'neon-cyan': '#00f3ff',
                        'neon-magenta': '#ffd700',
                        'neon-purple': '#9d00ff',
                        'neon-green': '#00ff88',
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'spin-slow': 'spin 8s linear infinite',
                    },
                    keyframes: {
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 20px rgba(0, 243, 255, 0.5), 0 0 40px rgba(0, 243, 255, 0.3)' },
                            '50%': { boxShadow: '0 0 40px rgba(0, 243, 255, 0.8), 0 0 80px rgba(0, 243, 255, 0.5)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        },
                    },
                },
            },
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&display=swap');

        :root {
            --c: #00f5ff;
            --m: #ffd700;
            --p: #9d00ff;
            --g: #39ff14;
            --bg: #020812;
            --bg2: #031226;
            --panel: rgba(3,18,45,0.75);
            --gold: #ffd700;
            --gold-dim: rgba(255,215,0,0.15);
            --gold-glow: rgba(255,215,0,0.4);
            --cyan-glow: rgba(0,245,255,0.4);
            --border-cyan: rgba(0,245,255,0.25);
            --border-gold: rgba(255,215,0,0.25);
        }

        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }

        /* â”€â”€ SCANLINE OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #scanlines {
            position: fixed; inset: 0; z-index: 9998; pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.1) 2px,
                rgba(0,0,0,0.1) 4px
            );
        }

        /* â”€â”€ ANIMATED SCAN LINE (Aureus Vault style) â”€ */
        .aureus-scan {
            position: fixed; top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--c), transparent);
            opacity: 0.5;
            animation: aureusScan 8s linear infinite;
            pointer-events: none; z-index: 9997;
        }
        @keyframes aureusScan {
            0%   { top: -2px; opacity: 0; }
            5%   { opacity: 0.5; }
            95%  { opacity: 0.5; }
            100% { top: 100vh; opacity: 0; }
        }

        /* â”€â”€ GRID BACKGROUND (perspective skewed) â”€â”€â”€â”€â”€ */
        #hud-grid {
            position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden;
            background-color: var(--bg);
        }
        #hud-grid::before {
            content: '';
            position: absolute; inset: -50%;
            background-image:
                linear-gradient(rgba(0,245,255,0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,245,255,0.04) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridDrift 25s linear infinite;
        }
        #hud-grid::after {
            content: '';
            position: absolute; inset: 0;
            background:
                radial-gradient(ellipse 60% 50% at 20% 30%, rgba(0,80,150,0.3) 0%, transparent 70%),
                radial-gradient(ellipse 50% 40% at 80% 70%, rgba(0,60,120,0.2) 0%, transparent 70%),
                radial-gradient(ellipse 80% 80% at 50% 50%, rgba(1,10,30,0.5) 0%, transparent 100%);
        }
        @keyframes gridDrift {
            0%   { transform: perspective(600px) rotateX(8deg) translateY(0); }
            100% { transform: perspective(600px) rotateX(8deg) translateY(40px); }
        }

        /* â”€â”€ ACCENT SWEEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sweep-line {
            position: fixed; top: 0; left: -100%; width: 60%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,243,255,0.03), transparent);
            animation: sweep 8s linear infinite;
            pointer-events: none; z-index: 1;
        }
        @keyframes sweep { 0% { left: -60%; } 100% { left: 140%; } }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            overflow-x: hidden;
            color: #c8e8f0;
        }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-mono     { font-family: 'Share Tech Mono', monospace; }

        /* â”€â”€ GLASS PANELS (Aureus Vault style) â”€â”€â”€â”€â”€â”€â”€â”€ */
        .glass {
            background: rgba(3, 18, 45, 0.72);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-cyan);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            transition: all 0.35s ease;
        }
        .glass::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--c), transparent);
            opacity: 0.5;
            pointer-events: none;
        }
        .glass::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 30% 0%, rgba(0,245,255,0.04) 0%, transparent 70%);
            pointer-events: none;
        }
        .glass:hover {
            border-color: rgba(0,245,255,0.5);
            box-shadow: 0 0 24px rgba(0,245,255,0.12), inset 0 0 24px rgba(0,245,255,0.03);
        }

        /* Corner brackets on glass panels */
        .glass-corner::before, .glass-corner::after {
            content: '';
            position: absolute;
            width: 10px; height: 10px;
            pointer-events: none;
            z-index: 2;
        }
        .glass-corner::before {
            top: -1px; left: -1px;
            border-top: 2px solid var(--c);
            border-left: 2px solid var(--c);
        }
        .glass-corner::after {
            bottom: -1px; right: -1px;
            border-bottom: 2px solid var(--c);
            border-right: 2px solid var(--c);
        }

        .glass-strong {
            background: rgba(2, 10, 30, 0.94);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(0, 245, 255, 0.28);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        .glass-strong::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--c), var(--gold), var(--c), transparent);
            opacity: 0.6;
            animation: borderFlow 4s linear infinite;
            pointer-events: none;
        }
        .glass-strong::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 50% 0%, rgba(0,245,255,0.06) 0%, transparent 60%);
            pointer-events: none;
        }
        @keyframes borderFlow {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* Gold accent panels (diamond-related) */
        .glass-gold {
            background: rgba(3, 18, 45, 0.72);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-gold);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            transition: all 0.35s ease;
        }
        .glass-gold::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            opacity: 0.6;
            pointer-events: none;
        }
        .glass-gold:hover {
            border-color: rgba(255,215,0,0.5);
            box-shadow: 0 0 24px rgba(255,215,0,0.15), inset 0 0 24px rgba(255,215,0,0.03);
        }

        /* â”€â”€ NEON TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .neon-text-cyan    { color: var(--c); text-shadow: 0 0 8px rgba(0,245,255,0.9), 0 0 20px rgba(0,245,255,0.5), 0 0 40px rgba(0,245,255,0.3); }
        .neon-text-gold    { color: var(--gold); text-shadow: 0 0 8px rgba(255,215,0,0.9), 0 0 20px rgba(255,215,0,0.5), 0 0 40px rgba(255,215,0,0.3); }
        .neon-text-magenta { color: var(--gold); text-shadow: 0 0 8px rgba(255,215,0,0.9), 0 0 20px rgba(255,215,0,0.5), 0 0 40px rgba(255,215,0,0.3); }
        .neon-text-purple  { color: var(--p); text-shadow: 0 0 8px rgba(157,0,255,0.9), 0 0 20px rgba(157,0,255,0.5), 0 0 40px rgba(157,0,255,0.3); }

        .neon-border-cyan    { box-shadow: 0 0 12px rgba(0,245,255,0.5), inset 0 0 12px rgba(0,245,255,0.08); }
        .neon-border-gold    { box-shadow: 0 0 12px rgba(255,215,0,0.5), inset 0 0 12px rgba(255,215,0,0.08); }
        .neon-border-magenta { box-shadow: 0 0 12px rgba(255,215,0,0.5), inset 0 0 12px rgba(255,215,0,0.08); }

        /* â”€â”€ ORB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .orb-glow {
            box-shadow:
                0 0 0 1px rgba(0,243,255,0.3),
                0 0 0 3px rgba(0,243,255,0.1),
                0 0 40px rgba(0,243,255,0.6),
                0 0 80px rgba(0,243,255,0.3),
                0 0 120px rgba(157,0,255,0.2),
                inset 0 0 40px rgba(0,243,255,0.15);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
            transition: transform 0.06s ease, box-shadow 0.06s ease;
            clip-path: circle(50%);
        }
        .orb-glow:active {
            box-shadow:
                0 0 0 1px rgba(0,243,255,0.6),
                0 0 60px rgba(0,243,255,1),
                0 0 120px rgba(0,243,255,0.7),
                0 0 200px rgba(255,215,0,0.4),
                inset 0 0 60px rgba(0,243,255,0.5);
            transform: scale(0.91);
        }

        /* rotating rings around orb */
        .orb-ring {
            position: absolute; border-radius: 50%; border: 1px solid;
            pointer-events: none;
        }
        .orb-ring-1 { inset: -14px; border-color: rgba(0,243,255,0.25); animation: spinRing 6s linear infinite; }
        .orb-ring-2 { inset: -26px; border-color: rgba(157,0,255,0.2); border-style: dashed; animation: spinRing 10s linear infinite reverse; }
        .orb-ring-3 { inset: -40px; border-color: rgba(255,215,0,0.12); animation: spinRing 16s linear infinite; }
        @keyframes spinRing { to { transform: rotate(360deg); } }

        /* target crosshair lines */
        .orb-crosshair {
            position: absolute; pointer-events: none;
        }
        .orb-crosshair::before, .orb-crosshair::after {
            content: ''; position: absolute; background: rgba(0,243,255,0.3);
        }
        .orb-crosshair::before { width: 1px; height: 18px; left: 50%; top: -30px; transform: translateX(-50%); }
        .orb-crosshair::after  { height: 1px; width: 18px; top: 50%; left: -30px; transform: translateY(-50%); }

        /* radar sweep inside orb */
        .orb-radar {
            position: absolute; inset: 0; border-radius: 50%; overflow: hidden; pointer-events: none;
        }
        .orb-radar::after {
            content: '';
            position: absolute; inset: 0;
            background: conic-gradient(from 0deg, transparent 340deg, rgba(0,243,255,0.25) 360deg);
            animation: radarSweep 3s linear infinite;
        }
        @keyframes radarSweep { to { transform: rotate(360deg); } }

        /* â”€â”€ PARTICLES & FLOATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .particle {
            position: absolute; width: 4px; height: 4px; border-radius: 1px;
            pointer-events: none; animation: particleFly 0.8s ease-out forwards;
        }
        @keyframes particleFly {
            0%   { transform: translate(0,0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx),var(--ty)) scale(0) rotate(180deg); opacity: 0; }
        }

        .chill-number { font-variant-numeric: tabular-nums; }

        /* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tab-active {
            background: linear-gradient(135deg, rgba(0,245,255,0.12), rgba(255,215,0,0.08));
            border-color: rgba(0,245,255,0.6) !important;
            box-shadow: inset 0 0 12px rgba(0,245,255,0.05), 0 0 8px rgba(0,245,255,0.2);
            position: relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            box-shadow: 0 0 6px var(--gold-glow);
        }

        /* â”€â”€ PRODUCER CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .producer-card {
            transition: all 0.25s ease;
            clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 10px 100%, 0 calc(100% - 10px));
        }
        .producer-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(0,243,255,0.2), 0 0 40px rgba(0,243,255,0.1);
            border-color: rgba(0,243,255,0.4) !important;
        }

        /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-glow { transition: all 0.2s ease; }
        .btn-glow:hover {
            box-shadow: 0 0 16px rgba(0,245,255,0.7), 0 0 32px rgba(0,245,255,0.3);
            border-color: rgba(0,245,255,0.8) !important;
        }
        .btn-gold-glow { transition: all 0.2s ease; }
        .btn-gold-glow:hover {
            box-shadow: 0 0 16px rgba(255,215,0,0.7), 0 0 32px rgba(255,215,0,0.3);
            border-color: rgba(255,215,0,0.9) !important;
            transform: translateY(-1px);
        }
        .btn-magenta-glow:hover {
            box-shadow: 0 0 16px rgba(255,215,0,0.7), 0 0 32px rgba(255,215,0,0.3);
        }

        /* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .progress-bar {
            background: linear-gradient(90deg, #00f3ff, #9d00ff, #ffd700);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
            box-shadow: 0 0 8px var(--c);
        }

        /* â”€â”€ DATA LABEL STYLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .data-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: rgba(0,243,255,0.5);
        }

        /* â”€â”€ STATUS DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--g);
            box-shadow: 0 0 6px var(--g);
            animation: statusBlink 2s ease-in-out infinite;
        }
        @keyframes statusBlink { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* â”€â”€ GLITCH ON TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .glitch {
            position: relative;
        }
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute; inset: 0;
            font-family: inherit; font-size: inherit; font-weight: inherit;
            color: inherit;
        }
        .glitch::before {
            color: var(--m);
            text-shadow: none;
            animation: glitchTop 4s steps(1) infinite;
            clip-path: polygon(0 0, 100% 0, 100% 35%, 0 35%);
        }
        .glitch::after {
            color: var(--c);
            text-shadow: none;
            animation: glitchBot 4s steps(1) infinite;
            clip-path: polygon(0 65%, 100% 65%, 100% 100%, 0 100%);
        }
        @keyframes glitchTop {
            0%,90%,100% { transform: translate(0,0); opacity: 0; }
            92% { transform: translate(-3px, -1px); opacity: 1; }
            94% { transform: translate(3px, 0); opacity: 1; }
            96% { transform: translate(0, 0); opacity: 0; }
        }
        @keyframes glitchBot {
            0%,92%,100% { transform: translate(0,0); opacity: 0; }
            94% { transform: translate(3px, 2px); opacity: 1; }
            96% { transform: translate(-2px, 0); opacity: 1; }
            98% { transform: translate(0,0); opacity: 0; }
        }

        /* â”€â”€ STARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stars {
            position: fixed; inset: 0; pointer-events: none; z-index: 0;
        }
        .star {
            position: absolute; width: 1px; height: 1px;
            background: var(--c); border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        @keyframes twinkle { 0%,100%{opacity:.2} 50%{opacity:.8} }

        /* â”€â”€ FLOATING CHILL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .floating-chill {
            position: absolute;
            color: var(--c);
            font-weight: bold;
            font-size: 13px;
            font-family: 'Share Tech Mono', monospace;
            letter-spacing: 0.05em;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 8px rgba(0,243,255,0.9);
        }
        @keyframes floatUp {
            0%   { transform: translateY(0) scale(1);    opacity: 1; }
            100% { transform: translateY(-70px) scale(0.4); opacity: 0; }
        }

        /* â”€â”€ MODAL OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(12px);
        }

        /* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        ::-webkit-scrollbar       { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,243,255,0.03); }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--c), var(--p));
            border-radius: 2px;
            box-shadow: 0 0 6px var(--c);
        }

        /* â”€â”€ WALLET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .connected-wallet {
            background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,255,136,0.05));
            border-color: rgba(0,255,136,0.4);
        }

        .achievement-card-locked { filter: grayscale(80%); opacity: 0.45; }

        /* â”€â”€ HQ ROOM TIERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .hq-room-locked  { filter: grayscale(90%); opacity: 0.35; }
        .hq-room-building {
            border-color: rgba(255,180,0,0.5) !important;
            box-shadow: 0 0 20px rgba(255,180,0,0.3), inset 0 0 10px rgba(255,180,0,0.05);
        }
        @keyframes buildingPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .hq-building-icon { animation: buildingPulse 1.5s ease-in-out infinite; }

        .hq-tier-basic {
            box-shadow: 0 0 14px rgba(0,243,255,0.3), inset 0 0 8px rgba(0,243,255,0.05);
            border-color: rgba(0,243,255,0.5);
        }
        .hq-tier-enhanced {
            box-shadow: 0 0 18px rgba(157,0,255,0.5), inset 0 0 10px rgba(157,0,255,0.08);
            border-color: rgba(157,0,255,0.7);
        }
        .hq-tier-legendary {
            box-shadow: 0 0 28px rgba(255,180,0,0.6), inset 0 0 14px rgba(255,180,0,0.1);
            border-color: rgba(255,180,0,0.8);
            animation: legendaryPulse 2s ease-in-out infinite;
        }
        @keyframes legendaryPulse {
            0%,100% { box-shadow: 0 0 28px rgba(255,180,0,0.6), inset 0 0 14px rgba(255,180,0,0.1); }
            50%      { box-shadow: 0 0 50px rgba(255,180,0,0.9), inset 0 0 22px rgba(255,180,0,0.2); }
        }
        .hq-mine-ready { animation: mineReady 1s ease-in-out infinite; }
        @keyframes mineReady { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* â”€â”€ ACHIEVEMENT TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .achievement-toast {
            position: fixed; top: 80px; left: 50%;
            transform: translateX(-50%) translateY(-20px);
            z-index: 9999; animation: toastIn 0.4s ease forwards;
            max-width: 320px; width: 90%;
        }
        @keyframes toastIn {
            0%   { transform: translateX(-50%) translateY(-30px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0);     opacity: 1; }
        }
        .achievement-toast.toast-out { animation: toastOut 0.4s ease forwards; }
        @keyframes toastOut {
            0%   { transform: translateX(-50%) translateY(0);     opacity: 1; }
            100% { transform: translateX(-50%) translateY(-30px); opacity: 0; }
        }

        /* â”€â”€ SHIMMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes shimmer {
            0%   { background-position: -200% 0; }
            100% { background-position:  200% 0; }
        }
        @keyframes float {
            0%,100% { transform: translateY(0); }
            50%      { transform: translateY(-10px); }
        }
        @keyframes pulseGlow {
            0%,100% { box-shadow: 0 0 20px rgba(0,243,255,0.5), 0 0 40px rgba(0,243,255,0.3); }
            50%      { box-shadow: 0 0 40px rgba(0,243,255,0.8), 0 0 80px rgba(0,243,255,0.5); }
        }

        /* â”€â”€ DIAGONAL CLIP CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .clip-card {
            clip-path: polygon(0 0, calc(100% - 16px) 0, 100% 16px, 100% 100%, 16px 100%, 0 calc(100% - 16px));
        }

        /* â”€â”€ PANEL HEADER (Aureus Vault style) â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.7rem;
            border-bottom: 1px solid rgba(0,245,255,0.1);
        }
        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--c);
            text-shadow: 0 0 8px var(--cyan-glow);
        }
        .panel-title-gold {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--gold);
            text-shadow: 0 0 8px var(--gold-glow);
        }
        .panel-badge {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6rem;
            padding: 2px 8px;
            border: 1px solid var(--g);
            color: var(--g);
            border-radius: 2px;
            letter-spacing: 1px;
            text-shadow: 0 0 6px var(--g);
        }
        .panel-badge-gold {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6rem;
            padding: 2px 8px;
            border: 1px solid var(--gold);
            color: var(--gold);
            border-radius: 2px;
            letter-spacing: 1px;
            text-shadow: 0 0 6px var(--gold-glow);
        }

        /* â”€â”€ HUD READOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .hud-value {
            font-family: 'Share Tech Mono', monospace;
            letter-spacing: 0.04em;
        }

        /* â”€â”€ INPUT FIELDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        input[type="text"], input[type="email"], input[type="number"] {
            background: rgba(0,15,30,0.8) !important;
            border: 1px solid rgba(0,243,255,0.2) !important;
            color: var(--c) !important;
            font-family: 'Share Tech Mono', monospace;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
        }
        input:focus {
            border-color: rgba(0,243,255,0.7) !important;
            box-shadow: 0 0 12px rgba(0,243,255,0.3), inset 0 0 8px rgba(0,243,255,0.05) !important;
            outline: none;
        }
        input::placeholder { color: rgba(0,243,255,0.3) !important; font-family: 'Share Tech Mono', monospace; }

        /* â”€â”€ LOADING SCREEN SPECIFIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #loadingScreen { background: var(--bg); }

        .enter-btn-shimmer {
            position: relative; overflow: hidden;
        }
        .enter-btn-shimmer::after {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(0,243,255,0.15) 50%, transparent 100%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        /* â”€â”€ SIDE MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #sideMenu { background: rgba(2,4,16,0.97); border-right: 1px solid rgba(0,243,255,0.2); }

        /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .top-bar-aureus {
            background: rgba(2, 10, 25, 0.88);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-cyan);
            position: relative;
        }
        .top-bar-aureus::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--c), var(--gold), var(--c), transparent);
            animation: borderFlow 4s linear infinite;
        }
            display: flex; align-items: center; gap: 6px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem; color: rgba(0,243,255,0.4);
            letter-spacing: 0.1em;
        }
        .stat-line::before { content: 'â–ˆ'; font-size: 0.4rem; color: var(--c); animation: statusBlink 2s infinite; }
    </style>
</head>
<body class="text-white">
    <!-- HUD Grid Background -->
    <div id="hud-grid"></div>
    <!-- Scanline Overlay -->
    <div id="scanlines"></div>
    <!-- Aureus Vault scan line -->
    <div class="aureus-scan"></div>
    <!-- Sweep light -->
    <div class="sweep-line"></div>
    <!-- Stars Background -->
    <div class="stars" id="stars"></div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6" style="background:rgba(2,2,9,0.97);backdrop-filter:blur(20px);">
        <div class="text-center max-w-md w-full">
            <!-- Header label -->
            <div class="flex items-center justify-center gap-2 mb-3">
                <div class="status-dot"></div>
                <span class="font-mono text-xs tracking-widest" style="color:rgba(0,243,255,0.5);">SYS::BOOT // CHILL_VERSE_OS v1.1</span>
            </div>
            <!-- Title with glitch -->
            <div class="relative mb-1">
                <p class="font-orbitron text-xs tracking-widest neon-text-magenta mb-2">â—ˆ CHILL VERSE PRESENTS â—ˆ</p>
                <h1 class="text-6xl md:text-8xl font-black font-orbitron neon-text-cyan tracking-tighter glitch" data-text="IDLE VERSE">IDLE VERSE</h1>
            </div>
            <!-- Decorative data line -->
            <div class="flex items-center gap-2 justify-center mb-6">
                <div style="height:1px;flex:1;background:linear-gradient(90deg,transparent,rgba(0,243,255,0.5))"></div>
                <span class="font-mono text-xs" style="color:rgba(0,243,255,0.4);">â—†</span>
                <div style="height:1px;flex:1;background:linear-gradient(90deg,rgba(0,243,255,0.5),transparent)"></div>
            </div>
            <!-- Login panel -->
            <div class="glass clip-card p-6 space-y-4">
                <div class="stat-line mb-4">INPUT REQUIRED // IDENTITY MODULE</div>
                <div>
                    <label class="block font-mono text-xs mb-2 tracking-widest" style="color:rgba(0,243,255,0.6);">â–¸ CHILL HANDLE</label>
                    <input type="text" id="usernameInput" placeholder="ENTER DESIGNATION..."
                        class="w-full rounded-none px-4 py-3 text-sm placeholder-white/40 focus:outline-none transition-all text-center font-orbitron"
                        style="clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px))">
                </div>
                <div>
                    <label class="block font-mono text-xs mb-2 tracking-widest" style="color:rgba(157,0,255,0.6);">â–¸ COMM LINK // EMAIL</label>
                    <input type="email" id="emailInput" placeholder="ADDRESS@NETWORK.COM"
                        class="w-full rounded-none px-4 py-3 text-sm placeholder-white/40 focus:outline-none transition-all text-center"
                        style="clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));border-color:rgba(157,0,255,0.2)!important;">
                </div>
                <button id="enterBtn" class="enter-btn-shimmer w-full btn-glow mt-2 font-orbitron font-bold text-lg tracking-widest py-4 transition-all"
                    style="background:linear-gradient(135deg,rgba(0,243,255,0.1),rgba(157,0,255,0.1));border:1px solid rgba(0,243,255,0.4);clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,12px 100%,0 calc(100% - 12px));color:var(--c);">
                    â¬¡ ENTER THE VERSE â¬¡
                </button>
            </div>
        </div>
    </div>

    <!-- Main Game -->
    <div id="mainGame" class="hidden min-h-screen flex flex-col relative z-10">

        <!-- ===== TOP BAR ===== -->
        <div class="glass-strong top-bar-aureus px-4 py-3 sticky top-0 z-40">
            <div class="flex items-center justify-between max-w-lg mx-auto">
                <!-- Left: Hamburger + Username -->
                <div class="flex items-center gap-3">
                    <button id="menuToggleBtn" class="text-neon-cyan hover:text-white transition-colors p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <button id="editNameBtn" class="flex items-center gap-2 text-neon-cyan hover:text-white transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        <span id="displayUsername" class="font-mono text-xs tracking-wider" style="color:rgba(0,243,255,0.8);">CHILLER</span>
                    </button>
                </div>
                <!-- Right: Diamond counter + Settings gear -->
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1 px-2 py-1" style="border:1px solid rgba(255,215,0,0.35);background:rgba(255,215,0,0.07);">
                        <i data-lucide="gem" style="width:12px;height:12px;color:#ffd700;"></i>
                        <span id="diamondCount" class="font-mono font-bold text-xs" style="color:#ffd700">0</span>
                    </div>
                    <button id="settingsToggleBtn" class="text-white/50 hover:text-neon-cyan transition-colors p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Chills counter row -->
            <div class="text-center mt-2">
                <div class="flex items-center justify-center gap-3">
                    <span id="chillCount" class="text-4xl md:text-5xl font-black font-orbitron neon-text-cyan chill-number hud-value">0</span>
                    <div class="flex flex-col items-start">
                        <span class="font-mono text-xs" style="color:rgba(0,243,255,0.5);letter-spacing:0.1em;">CHILLS</span>
                        <span class="font-mono text-xs" style="color:rgba(157,0,255,0.6);">UNIT::CHILL</span>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-2 mt-0.5">
                    <span class="status-dot" style="width:4px;height:4px;"></span>
                    <span id="cpsDisplay" class="font-mono text-xs font-bold" style="color:rgba(157,0,255,0.9)">0</span>
                    <span class="font-mono text-xs" style="color:rgba(255,255,255,0.3)">CHILLS/SEC</span>
                </div>
            </div>

            <!-- Settings Dropdown (hidden by default) -->
            <div id="settingsDropdown" class="hidden mt-3 pt-3 border-t border-white/10 space-y-3 max-w-lg mx-auto">
                <div class="flex items-center justify-between">
                    <span class="text-white/70 text-sm">Chill Handle</span>
                    <button id="changeNameBtn" class="text-neon-cyan hover:text-white transition-colors text-sm">Change</button>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-white/70 text-sm">Saved Email</span>
                    <span id="savedEmail" class="text-white/40 text-xs"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-white/70 text-sm">Offline Progress</span>
                    <button id="toggleOffline" class="w-12 h-6 rounded-full bg-neon-green/30 border border-neon-green/50 relative transition-colors">
                        <span class="absolute right-1 top-1 w-4 h-4 rounded-full bg-neon-green transition-all"></span>
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-white/70 text-sm">Particles</span>
                    <button id="toggleParticles" class="w-12 h-6 rounded-full bg-neon-green/30 border border-neon-green/50 relative transition-colors">
                        <span class="absolute right-1 top-1 w-4 h-4 rounded-full bg-neon-green transition-all"></span>
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-white/70 text-sm">Music</span>
                    <button id="toggleMusic" class="w-12 h-6 rounded-full bg-neon-green/30 border border-neon-green/50 relative transition-colors">
                        <span class="absolute right-1 top-1 w-4 h-4 rounded-full bg-neon-green transition-all"></span>
                    </button>
                </div>
                <button id="resetGameBtn" class="w-full bg-red-500/20 border border-red-500/50 rounded-xl py-2 text-red-400 font-orbitron font-bold text-sm hover:bg-red-500/30 transition-all">
                    RESET GAME
                </button>
                <p class="text-white/25 text-xs text-center">Last saved: <span id="lastSaved">Never</span></p>
            </div>
        </div>

        <!-- ===== LEFT SLIDE-OUT MENU ===== -->
        <!-- Overlay -->
        <div id="menuOverlay" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm"></div>
        <!-- Drawer -->
        <div id="sideMenu" class="fixed top-0 left-0 h-full w-64 z-50 transform -translate-x-full transition-transform duration-300 flex flex-col" style="background:rgba(2,4,16,0.97);border-right:1px solid rgba(0,243,255,0.2);">
            <!-- Menu header -->
            <div class="p-5 border-b border-cyan-900/50" style="border-color:rgba(0,243,255,0.15)">
                <div class="flex items-center gap-2 mb-1">
                    <div class="status-dot"></div>
                    <span class="font-mono text-xs" style="color:rgba(0,243,255,0.4);letter-spacing:0.1em;">CHILL_OS // ONLINE</span>
                </div>
                <h2 class="font-orbitron text-xl font-black neon-text-cyan tracking-wider">IDLE VERSE</h2>
                <div style="height:1px;background:linear-gradient(90deg,rgba(0,243,255,0.5),transparent);margin-top:6px;"></div>
            </div>
            <!-- Nav links -->
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all tab-active text-left" data-tab="Home">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    <span class="font-orbitron text-sm">Home</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Shop">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                    <span class="font-orbitron text-sm">Shop</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Diamonds">
                    <i data-lucide="gem" style="width:20px;height:20px;flex-shrink:0;color:#ffd700;"></i>
                    <span class="font-orbitron text-sm">Diamonds</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Web3">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span class="font-orbitron text-sm">Web3</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="NFTs">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    <span class="font-orbitron text-sm">NFTs</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Stake">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                    <span class="font-orbitron text-sm">Stake</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="HQ">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    <span class="font-orbitron text-sm">Gang HQ</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Achievements">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                    <span class="font-orbitron text-sm">Trophies</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Leaderboard">
                    <svg class="w-5 h-5 flex-shrink-0 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span class="font-orbitron text-sm">Leaderboard</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Social">
                    <svg class="w-5 h-5 flex-shrink-0 neon-text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span class="font-orbitron text-sm">Social</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Profile">
                    <svg class="w-5 h-5 flex-shrink-0 text-neon-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    <span class="font-orbitron text-sm">Profile</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="BlackMarket">
                    <svg class="w-5 h-5 flex-shrink-0 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <span class="font-orbitron text-sm">Black Market</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="About">
                    <svg class="w-5 h-5 flex-shrink-0 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="font-orbitron text-sm">About</span>
                </button>
                <button class="side-nav-btn tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all opacity-60 hover:opacity-100 text-left" data-tab="Contacts">
                    <svg class="w-5 h-5 flex-shrink-0 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <span class="font-orbitron text-sm">Contacts</span>
                </button>
            </nav>
            <!-- Menu footer branding -->
            <div class="p-4 border-t border-white/10 text-center">
                <p class="text-white/20 text-xs">Version 1.1.0 â€¢ Made with Chill</p>
            </div>
        </div>

        <!-- ===== MAIN CONTENT ===== -->
        <div class="flex-1 p-4 pb-6 overflow-y-auto">

            <!-- HOME TAB -->
            <div id="tabHome" class="tab-content max-w-lg mx-auto">
                <div class="flex flex-col items-center py-8">
                    <div class="relative flex items-center justify-center">
                        <!-- Outer rotating rings -->
                        <div class="orb-ring orb-ring-1"></div>
                        <div class="orb-ring orb-ring-2"></div>
                        <div class="orb-ring orb-ring-3"></div>
                        <!-- Crosshair lines -->
                        <div style="position:absolute;width:1px;height:80px;background:linear-gradient(180deg,rgba(0,243,255,0.5),transparent);top:-80px;left:50%;transform:translateX(-50%);pointer-events:none;"></div>
                        <div style="position:absolute;width:1px;height:80px;background:linear-gradient(0deg,rgba(0,243,255,0.5),transparent);bottom:-80px;left:50%;transform:translateX(-50%);pointer-events:none;"></div>
                        <div style="position:absolute;height:1px;width:80px;background:linear-gradient(90deg,transparent,rgba(0,243,255,0.5));right:-80px;top:50%;transform:translateY(-50%);pointer-events:none;"></div>
                        <div style="position:absolute;height:1px;width:80px;background:linear-gradient(270deg,transparent,rgba(0,243,255,0.5));left:-80px;top:50%;transform:translateY(-50%);pointer-events:none;"></div>
                        <!-- Main orb button -->
                        <button id="chillCore" class="w-48 h-48 md:w-56 md:h-56 rounded-full orb-glow relative" style="cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;display:block;padding:0;overflow:hidden;background:radial-gradient(circle at 40% 35%, rgba(0,243,255,0.25) 0%, rgba(0,243,255,0.08) 40%, rgba(157,0,255,0.12) 70%, rgba(255,215,0,0.08) 100%);border:1px solid rgba(0,243,255,0.4);">
                            <!-- Radar sweep -->
                            <div class="orb-radar"></div>
                            <!-- Tap overlay -->
                            <span class="absolute inset-0 rounded-full z-20" style="display:block;"></span>
                            <!-- Hex grid pattern overlay -->
                            <div class="absolute inset-0 rounded-full opacity-10" style="background-image:repeating-linear-gradient(0deg,rgba(0,243,255,0.4) 0,rgba(0,243,255,0.4) 1px,transparent 1px,transparent 20px),repeating-linear-gradient(60deg,rgba(0,243,255,0.4) 0,rgba(0,243,255,0.4) 1px,transparent 1px,transparent 20px),repeating-linear-gradient(120deg,rgba(0,243,255,0.4) 0,rgba(0,243,255,0.4) 1px,transparent 1px,transparent 20px);pointer-events:none;"></div>
                            <span class="absolute inset-0 flex flex-col items-center justify-center gap-0 z-10" style="pointer-events:none;">
                                <span class="font-mono text-xs tracking-widest" style="color:rgba(0,243,255,0.5);">SYS::ACTIVE</span>
                                <span class="font-orbitron font-black text-2xl neon-text-cyan" style="letter-spacing:0.05em;">CORE</span>
                                <div style="height:1px;width:60%;background:rgba(0,243,255,0.4);margin:4px 0;"></div>
                                <span class="font-mono text-xs" style="color:rgba(0,243,255,0.7);">+<span id="clickPowerDisplay">1</span> / TAP</span>
                            </span>
                        </button>
                        <!-- Corner brackets around orb area -->
                        <div style="position:absolute;top:-48px;left:-48px;width:20px;height:20px;border-top:2px solid rgba(0,243,255,0.4);border-left:2px solid rgba(0,243,255,0.4);pointer-events:none;"></div>
                        <div style="position:absolute;top:-48px;right:-48px;width:20px;height:20px;border-top:2px solid rgba(0,243,255,0.4);border-right:2px solid rgba(0,243,255,0.4);pointer-events:none;"></div>
                        <div style="position:absolute;bottom:-48px;left:-48px;width:20px;height:20px;border-bottom:2px solid rgba(0,243,255,0.4);border-left:2px solid rgba(0,243,255,0.4);pointer-events:none;"></div>
                        <div style="position:absolute;bottom:-48px;right:-48px;width:20px;height:20px;border-bottom:2px solid rgba(0,243,255,0.4);border-right:2px solid rgba(0,243,255,0.4);pointer-events:none;"></div>
                    </div>
                    <div class="flex items-center gap-2 mt-10">
                        <div class="status-dot"></div>
                        <p class="font-mono text-xs tracking-widest" style="color:rgba(0,243,255,0.4);">TAP CORE TO GENERATE CHILLS</p>
                    </div>
                </div>
                <!-- Offline Progress -->
                <div id="offlineProgress" class="hidden glass rounded-xl p-4 mb-4 border-l-4 border-neon-green">
                    <div class="flex items-center gap-2 text-neon-green">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="font-bold">Offline Progress</span>
                    </div>
                    <p class="text-white/70 text-sm mt-1">You earned <span id="offlineChills" class="text-neon-cyan font-bold">0</span> Chills while away!</p>
                </div>
                <!-- Owned Producers -->
                <div class="glass rounded-2xl p-4">
                    <h3 class="font-orbitron text-neon-purple mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        YOUR PRODUCERS
                    </h3>
                    <div id="ownedProducersList" class="space-y-2">
                        <p class="text-white/40 text-center py-4">No producers yet. Visit the Production Shop!</p>
                    </div>
                </div>
            </div>

            <!-- SHOP TAB -->
            <div id="tabShop" class="tab-content hidden max-w-lg mx-auto">
                <h2 class="font-orbitron text-2xl neon-text-cyan mb-4 text-center">PRODUCTION SHOP</h2>
                <div id="shopGrid" class="space-y-3 mb-8"></div>

                <!-- ARTEFACTS SECTION -->
                <div class="border-t border-white/10 pt-6">
                    <h2 class="font-orbitron text-xl neon-text-purple mb-1 text-center">âš—ï¸ ARTEFACTS</h2>
                    <p class="text-white/40 text-xs text-center mb-4">Collected artefacts appear in your NFT vault</p>
                    <div id="artefactsShopGrid" class="space-y-3"></div>
                </div>
            </div>

            <!-- DIAMONDS TAB -->
            <div id="tabDiamonds" class="tab-content hidden max-w-lg mx-auto">
                <div class="text-center py-6">
                    <div class="inline-flex items-center gap-2 glass rounded-full px-6 py-3 glass-gold">
                        <i data-lucide="gem" class="w-6 h-6" style="color:#ffd700;"></i>
                        <span id="diamondCountBig" class="text-3xl font-orbitron font-black neon-text-gold">0</span>
                        <span style="color:#ffd700;">Diamonds</span>
                    </div>
                </div>
                <div class="glass-gold rounded-2xl p-6 mb-6 text-center" style="box-shadow:0 0 20px rgba(255,215,0,0.1)">
                    <h3 class="font-orbitron text-xl neon-text-gold mb-2">ASCEND TO DIAMOND VERSE</h3>
                    <p class="text-white/60 text-sm mb-4">Reset your progress for permanent Diamonds</p>
                    <div class="glass rounded-xl p-3 mb-4">
                        <p class="text-white/70 text-sm">You will earn:</p>
                        <p class="text-2xl font-orbitron font-bold neon-text-gold">+<span id="ascendDiamonds">0</span> Diamonds</p>
                    </div>
                    <button id="ascendBtn" class="w-full rounded-xl py-4 font-orbitron font-bold tracking-wider transition-all btn-gold-glow"
                        style="background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(157,0,255,0.2));border:1px solid rgba(255,215,0,0.5);">
                        ASCEND NOW
                    </button>
                </div>
                <h3 class="font-orbitron text-neon-cyan mb-4">DIAMOND UPGRADES</h3>
                <div id="diamondShop" class="space-y-3"></div>

                <!-- â”€â”€ CONVERSION SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <div class="mt-6 mb-2 flex items-center gap-3">
                    <div style="height:1px;flex:1;background:linear-gradient(90deg,transparent,rgba(255,215,0,0.4))"></div>
                    <span class="font-orbitron text-xs tracking-widest" style="color:rgba(255,215,0,0.7);">â—† CONVERSION EXCHANGE â—†</span>
                    <div style="height:1px;flex:1;background:linear-gradient(90deg,rgba(255,215,0,0.4),transparent)"></div>
                </div>

                <div class="glass-gold rounded-2xl p-5 mb-4" style="box-shadow:0 0 20px rgba(255,215,0,0.08)">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="arrow-left-right" style="width:22px;height:22px;color:#ffd700;"></i>
                        <div>
                            <p class="font-orbitron font-bold" style="color:#ffd700;">DIAMOND â†” CHILL EXCHANGE</p>
                            <p class="text-white/40 text-xs">Rate: 1 <i data-lucide="gem" style="width:10px;height:10px;display:inline;vertical-align:middle;color:#ffd700;"></i> = 100,000,000 Chills</p>
                        </div>
                    </div>

                    <!-- Rate display -->
                    <div class="glass rounded-xl p-3 mb-4 text-center">
                        <p class="font-mono text-xs" style="color:rgba(255,215,0,0.5);letter-spacing:0.1em;">EXCHANGE RATE</p>
                        <p class="font-orbitron font-bold text-white mt-1">1 <span style="color:#ffd700;">â—†</span> = 100M Chills</p>
                        <p class="text-white/30 text-xs mt-1">Daily limit: 500 Diamonds or 500B Chills per direction</p>
                    </div>

                    <!-- Direction tabs -->
                    <div class="flex gap-2 mb-4">
                        <button onclick="setConvertTab('toChills')" id="convTabToChills"
                            class="flex-1 py-2 rounded-lg font-orbitron text-xs font-bold border transition-all"
                            style="background:rgba(255,215,0,0.15);border-color:rgba(255,215,0,0.5);color:#ffd700;">
                            <i data-lucide="gem" style="width:12px;height:12px;display:inline;vertical-align:middle;margin-right:4px;"></i> â†’ CHILLS
                        </button>
                        <button onclick="setConvertTab('toDiamonds')" id="convTabToDiamonds"
                            class="flex-1 py-2 rounded-lg font-orbitron text-xs font-bold border transition-all"
                            style="background:rgba(0,245,255,0.05);border-color:rgba(0,245,255,0.2);color:rgba(0,245,255,0.4);">
                            CHILLS â†’ <i data-lucide="gem" style="width:12px;height:12px;display:inline;vertical-align:middle;margin-left:4px;"></i>
                        </button>
                    </div>

                    <!-- Diamonds â†’ Chills panel -->
                    <div id="convPanelToChills">
                        <div class="mb-3">
                            <label class="text-white/50 text-xs block mb-1 font-orbitron tracking-wider">DIAMONDS TO CONVERT (max 500/day)</label>
                            <input id="convDiaInput" type="number" min="10" max="500" step="10" placeholder="Min 10 diamonds"
                                class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:outline-none"
                                style="border-color:rgba(255,215,0,0.3)!important;"
                                oninput="updateConvPreview('toChills')">
                        </div>
                        <div class="glass rounded-xl p-3 mb-3 text-center">
                            <p class="text-white/40 text-xs mb-1">YOU WILL RECEIVE</p>
                            <p id="convChillsPreview" class="font-orbitron font-bold text-neon-cyan text-xl">0 Chills</p>
                        </div>
                        <!-- Daily limit bar -->
                        <div class="mb-3">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-white/40 font-mono">DAILY LIMIT USED</span>
                                <span id="convDiaUsedLabel" class="font-orbitron" style="color:#ffd700;">0 / 500</span>
                            </div>
                            <div class="w-full rounded-full h-1.5" style="background:rgba(255,215,0,0.1);">
                                <div id="convDiaBar" class="h-1.5 rounded-full transition-all duration-500" style="width:0%;background:linear-gradient(90deg,#ffd700,#ff8c00);box-shadow:0 0 6px rgba(255,215,0,0.5);"></div>
                            </div>
                        </div>
                        <button onclick="executeConvert('toChills')"
                            class="w-full py-3 rounded-xl font-orbitron font-bold text-sm transition-all btn-gold-glow"
                            style="background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,140,0,0.15));border:1px solid rgba(255,215,0,0.5);color:#ffd700;">
                            <i data-lucide="zap" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:6px;"></i>
                            CONVERT TO CHILLS
                        </button>
                    </div>

                    <!-- Chills â†’ Diamonds panel -->
                    <div id="convPanelToDiamonds" class="hidden">
                        <div class="mb-3">
                            <label class="text-white/50 text-xs block mb-1 font-orbitron tracking-wider">CHILLS TO CONVERT (in billions, max 500B/day)</label>
                            <input id="convChillInput" type="number" min="1" max="500" step="1" placeholder="Billions (e.g. 10 = 10B Chills)"
                                class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:outline-none"
                                style="border-color:rgba(0,245,255,0.3)!important;"
                                oninput="updateConvPreview('toDiamonds')">
                            <p class="text-white/30 text-xs mt-1 text-center">Enter in billions â€” 10 = 10,000,000,000 Chills</p>
                        </div>
                        <div class="glass rounded-xl p-3 mb-3 text-center">
                            <p class="text-white/40 text-xs mb-1">YOU WILL RECEIVE</p>
                            <p id="convDiaPreview" class="font-orbitron font-bold neon-text-gold text-xl">0 <i data-lucide="gem" style="width:16px;height:16px;display:inline;vertical-align:middle;color:#ffd700;"></i></p>
                        </div>
                        <!-- Daily limit bar -->
                        <div class="mb-3">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-white/40 font-mono">DAILY LIMIT USED</span>
                                <span id="convChillUsedLabel" class="font-orbitron text-neon-cyan">0B / 50B</span>
                            </div>
                            <div class="w-full rounded-full h-1.5" style="background:rgba(0,245,255,0.1);">
                                <div id="convChillBar" class="h-1.5 rounded-full transition-all duration-500" style="width:0%;background:linear-gradient(90deg,#00f5ff,#9d00ff);box-shadow:0 0 6px rgba(0,245,255,0.5);"></div>
                            </div>
                        </div>
                        <button onclick="executeConvert('toDiamonds')"
                            class="w-full py-3 rounded-xl font-orbitron font-bold text-sm transition-all btn-glow"
                            style="background:linear-gradient(135deg,rgba(0,245,255,0.15),rgba(157,0,255,0.15));border:1px solid rgba(0,245,255,0.4);color:#00f5ff;">
                            <i data-lucide="zap" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:6px;"></i>
                            CONVERT TO DIAMONDS
                        </button>
                    </div>
                </div>
            </div>

            <!-- WEB3 TAB -->
            <div id="tabWeb3" class="tab-content hidden max-w-lg mx-auto">
                <h2 class="font-orbitron text-2xl neon-text-cyan mb-6 text-center">WEB3 VERSE</h2>
                <div class="glass rounded-2xl p-6 mb-6 text-center">
                    <div id="walletDisconnected">
                        <svg class="w-16 h-16 mx-auto mb-4 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        <p class="text-white/60 mb-4">Connect your wallet for +25% production bonus</p>
                        <button id="connectWalletBtn" class="bg-gradient-to-r from-orange-500/30 to-orange-600/30 border border-orange-500/50 rounded-xl px-8 py-3 font-orbitron font-bold hover:from-orange-500/40 hover:to-orange-600/40 transition-all">CONNECT WALLET</button>
                    </div>
                    <div id="walletConnected" class="hidden">
                        <div class="flex items-center justify-center gap-2 text-neon-green mb-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            <span class="font-bold">CONNECTED</span>
                        </div>
                        <p id="walletAddress" class="font-mono text-sm text-white/70 bg-black/30 rounded-lg px-4 py-2"></p>
                        <div class="mt-4 p-3 bg-neon-green/10 rounded-xl border border-neon-green/30">
                            <p class="text-neon-green text-sm">+25% Global Production Active!</p>
                        </div>
                    </div>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-orbitron text-neon-cyan mb-2">VERSE STATS</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between py-2 border-b border-white/10">
                            <span class="text-white/60">NFTs Minted</span>
                            <span id="web3NftCount" class="text-neon-purple font-bold">0</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-white/10">
                            <span class="text-white/60">Artefacts Owned</span>
                            <span id="web3ArtefactCount" class="text-neon-cyan font-bold">0</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-white/60">Wallet Status</span>
                            <span id="web3WalletStatus" class="text-white/40 font-bold">Disconnected</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACHIEVEMENTS TAB -->
            <div id="tabAchievements" class="tab-content hidden max-w-lg mx-auto">
                <h2 class="font-orbitron text-2xl neon-text-cyan mb-2 text-center">ACHIEVEMENTS</h2>
                <p id="achievementProgress" class="text-center text-white/50 text-sm mb-6">0 / 0 Unlocked</p>
                <div id="achievementGrid" class="space-y-3"></div>
            </div>

            <!-- NFTs TAB -->
            <div id="tabNFTs" class="tab-content hidden max-w-lg mx-auto">
                <h2 class="font-orbitron text-2xl neon-text-cyan mb-2 text-center">NFT VAULT</h2>
                <p class="text-center text-white/40 text-xs mb-5">Mint takes 5h 30m â€¢ One mint at a time</p>

                <!-- Mint Status -->
                <div id="nftMintStatus" class="glass rounded-2xl p-5 mb-5 text-center border border-neon-purple/30">
                    <div id="nftMintIdle">
                        <p class="text-neon-purple font-orbitron font-bold mb-1">START A MINT</p>
                        <p class="text-white/50 text-sm mb-4">Cost: <span class="text-neon-cyan font-bold">100,000 Chills</span> + <span class="neon-text-gold font-bold">50 Diamonds</span></p>
                        <button id="startMintBtn" class="w-full bg-gradient-to-r from-neon-purple/30 to-yellow-400/20 border border-neon-purple/50 rounded-xl py-3 font-orbitron font-bold hover:from-neon-purple/40 hover:to-yellow-400/30 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="image" style="width:16px;height:16px;"></i> BEGIN MINT
                        </button>
                    </div>
                    <div id="nftMintActive" class="hidden">
                        <p class="text-neon-cyan font-orbitron font-bold mb-2">MINTING IN PROGRESS</p>
                        <div class="w-full bg-white/10 rounded-full h-3 mb-2">
                            <div id="mintProgressBar" class="bg-gradient-to-r from-neon-cyan to-neon-purple h-3 rounded-full transition-all duration-1000" style="width:0%"></div>
                        </div>
                        <p id="mintTimeLeft" class="text-white/60 text-sm">Calculating...</p>
                        <button id="cancelMintBtn" class="mt-3 text-white/30 text-xs hover:text-red-400 transition-colors">Cancel mint</button>
                    </div>
                    <div id="nftMintReady" class="hidden">
                        <p class="text-neon-green font-orbitron font-bold text-lg mb-2">âœ… MINT COMPLETE!</p>
                        <button id="claimNftBtn" class="w-full bg-gradient-to-r from-neon-green/30 to-neon-cyan/30 border border-neon-green/50 rounded-xl py-3 font-orbitron font-bold hover:from-neon-green/40 hover:to-neon-cyan/40 transition-all">ðŸŽ CLAIM NFT</button>
                    </div>
                </div>

                <!-- NFT Collection -->
                <h3 class="font-orbitron text-neon-purple mb-3 text-sm tracking-widest">YOUR COLLECTION</h3>
                <div id="nftCollection" class="grid grid-cols-2 gap-3 mb-6">
                    <div class="col-span-2 text-center text-white/30 py-6 text-sm">No NFTs yet. Start a mint!</div>
                </div>

                <!-- Artefacts Section -->
                <div class="border-t border-white/10 pt-5">
                    <h3 class="font-orbitron text-neon-cyan mb-1 text-sm tracking-widest">âš—ï¸ ARTEFACTS VAULT</h3>
                    <p class="text-white/30 text-xs mb-4">Items purchased from the Shop</p>
                    <div id="artefactsVault" class="grid grid-cols-2 gap-3">
                        <div class="col-span-2 text-center text-white/30 py-4 text-sm">No artefacts yet. Visit the Shop!</div>
                    </div>
                </div>
            </div>

            <!-- STAKE TAB -->
            <div id="tabStake" class="tab-content hidden max-w-lg mx-auto">
                <h2 class="font-orbitron text-2xl neon-text-cyan mb-2 text-center">CHILL STAKE</h2>
                <p class="text-center text-white/40 text-xs mb-5">1-hour staking period â€¢ Results are randomized</p>

                <!-- Chart area -->
                <div class="glass rounded-2xl p-4 mb-5">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-orbitron text-xs text-white/50">CHILL/STAKE INDEX</span>
                        <span id="stakeChartTrend" class="text-xs font-bold text-neon-green">â–² LIVE</span>
                    </div>
                    <canvas id="stakeChart" height="100" style="width:100%;height:100px;"></canvas>
                </div>

                <!-- Current stake -->
                <div id="stakeIdlePanel" class="glass rounded-2xl p-5 mb-4 border border-neon-cyan/20">
                    <p class="font-orbitron text-neon-cyan mb-4 text-center">PLACE YOUR STAKE</p>
                    <div class="mb-4">
                        <label class="text-white/60 text-xs block mb-1">AMOUNT (Chills)</label>
                        <input id="stakeAmountInput" type="number" min="100" placeholder="Min. 100 Chills"
                            class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white text-center font-orbitron focus:border-neon-cyan focus:outline-none">
                        <p class="text-white/30 text-xs text-center mt-1">Balance: <span id="stakeBalanceDisplay">0</span> Chills</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="stakeBuyBtn" class="py-4 rounded-xl bg-neon-green/20 border border-neon-green/50 text-neon-green font-orbitron font-bold text-lg hover:bg-neon-green/30 transition-all">
                            â¬† BUY
                        </button>
                        <button id="stakeSellBtn" class="py-4 rounded-xl bg-red-500/20 border border-red-500/50 text-red-400 font-orbitron font-bold text-lg hover:bg-red-500/30 transition-all">
                            â¬‡ SELL
                        </button>
                    </div>
                </div>

                <!-- Active stake -->
                <div id="stakeActivePanel" class="hidden glass rounded-2xl p-5 mb-4 border border-neon-purple/30">
                    <p class="font-orbitron text-neon-purple text-center mb-3">STAKE IN PROGRESS</p>
                    <div class="flex justify-between text-sm mb-3">
                        <span class="text-white/60">Staked</span>
                        <span id="stakeAmountDisplay" class="text-neon-cyan font-bold">0 Chills</span>
                    </div>
                    <div class="flex justify-between text-sm mb-3">
                        <span class="text-white/60">Position</span>
                        <span id="stakePositionDisplay" class="font-bold">â€”</span>
                    </div>
                    <div class="w-full bg-white/10 rounded-full h-2 mb-2">
                        <div id="stakeProgressBar" class="bg-gradient-to-r from-neon-purple to-neon-cyan h-2 rounded-full transition-all duration-1000" style="width:0%"></div>
                    </div>
                    <p id="stakeTimeLeft" class="text-white/50 text-xs text-center">Calculating...</p>
                </div>

                <!-- Stake history -->
                <div class="glass rounded-2xl p-4 mb-5">
                    <p class="font-orbitron text-xs text-white/40 tracking-widest mb-3">CHILL STAKE HISTORY</p>
                    <div id="stakeHistory" class="space-y-2 text-sm text-white/40 text-center py-2">No stakes yet</div>
                </div>

                <!-- DIAMOND STAKE SECTION -->
                <div class="border-t pt-5 mt-2" style="border-color:rgba(255,215,0,0.3)">
                    <h2 class="font-orbitron text-2xl mb-1 text-center neon-text-gold flex items-center justify-center gap-2">
                        <i data-lucide="gem" style="width:24px;height:24px;"></i> DIAMOND STAKE
                    </h2>
                    <p class="text-center text-white/40 text-xs mb-5">1-hour period â€¢ Max 1,000 <i data-lucide="gem" style="width:10px;height:10px;display:inline;vertical-align:middle;color:#ffd700;"></i> â€¢ Win: 1.0xâ€“1.7x â€¢ Loss: all gone</p>

                    <!-- Diamond Chart -->
                    <div class="glass rounded-2xl p-4 mb-5">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-orbitron text-xs text-white/50">â—† DIAMOND INDEX</span>
                            <span id="dStakeChartTrend" class="text-xs font-bold neon-text-gold">â–² LIVE</span>
                        </div>
                        <canvas id="dStakeChart" height="100" style="width:100%;height:100px;"></canvas>
                    </div>

                    <!-- Diamond idle panel -->
                    <div id="dStakeIdlePanel" class="glass rounded-2xl p-5 mb-4 glass-gold">
                        <p class="font-orbitron neon-text-gold mb-4 text-center">PLACE DIAMOND STAKE</p>
                        <div class="mb-4">
                            <label class="text-white/60 text-xs block mb-1">AMOUNT (Diamonds, max 1,000)</label>
                            <input id="dStakeAmountInput" type="number" min="1" max="1000" placeholder="1 â€“ 1,000 Diamonds"
                                class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white text-center font-orbitron focus:outline-none"
                                style="border-color:rgba(255,215,0,0.3)!important;">
                            <p class="text-white/30 text-xs text-center mt-1">Balance: <span id="dStakeBalanceDisplay">0</span> <i data-lucide="gem" style="width:10px;height:10px;display:inline;vertical-align:middle;color:#ffd700;"></i></p>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="placeDiamondStake('buy')" class="py-4 rounded-xl bg-neon-green/20 border border-neon-green/50 text-neon-green font-orbitron font-bold text-lg hover:bg-neon-green/30 transition-all">â¬† BUY</button>
                            <button onclick="placeDiamondStake('sell')" class="py-4 rounded-xl bg-red-500/20 border border-red-500/50 text-red-400 font-orbitron font-bold text-lg hover:bg-red-500/30 transition-all">â¬‡ SELL</button>
                        </div>
                    </div>

                    <!-- Diamond active panel -->
                    <div id="dStakeActivePanel" class="hidden glass rounded-2xl p-5 mb-4 glass-gold">
                        <p class="font-orbitron neon-text-gold text-center mb-3 flex items-center justify-center gap-2">
                            <i data-lucide="gem" style="width:16px;height:16px;"></i> DIAMOND STAKE IN PROGRESS
                        </p>
                        <div class="flex justify-between text-sm mb-3">
                            <span class="text-white/60">Staked</span>
                            <span id="dStakeAmountDisplay" class="neon-text-gold font-bold">0 â—†</span>
                        </div>
                        <div class="flex justify-between text-sm mb-3">
                            <span class="text-white/60">Position</span>
                            <span id="dStakePositionDisplay" class="font-bold">â€”</span>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2 mb-2">
                            <div id="dStakeProgressBar" class="h-2 rounded-full transition-all duration-1000" style="width:0%;background:linear-gradient(90deg,#ffd700,#ff8c00);box-shadow:0 0 6px rgba(255,215,0,0.5);"></div>
                        </div>
                        <p id="dStakeTimeLeft" class="text-white/50 text-xs text-center">Calculating...</p>
                    </div>

                    <!-- Diamond stake history -->
                    <div class="glass rounded-2xl p-4">
                        <p class="font-orbitron text-xs text-white/40 tracking-widest mb-3">DIAMOND STAKE HISTORY</p>
                        <div id="dStakeHistory" class="space-y-2 text-sm text-white/40 text-center py-2">No diamond stakes yet</div>
                    </div>
                </div>
            </div>

            <!-- HQ TAB -->
            <div id="tabHQ" class="tab-content hidden max-w-lg mx-auto">

                <!-- Header & Rank -->
                <div class="text-center py-4 mb-4">
                    <p class="text-white/40 text-xs tracking-widest font-orbitron mb-1">CHILL VERSE</p>
                    <h2 class="font-orbitron text-3xl font-black neon-text-cyan mb-1">GANG HQ</h2>
                    <div class="inline-block px-4 py-1 rounded-full border border-neon-purple/50 bg-neon-purple/10 mb-3">
                        <span id="hqRankLabel" class="font-orbitron text-sm text-neon-purple">Empty Lot</span>
                    </div>
                    <div class="glass rounded-2xl p-3 mx-4">
                        <div class="flex justify-between text-xs text-white/40 mb-1">
                            <span>TIERS BUILT</span>
                            <span><span id="hqTierCount">0</span> / 30</span>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2">
                            <div id="hqProgressBar" class="bg-gradient-to-r from-neon-cyan via-neon-purple to-yellow-400 h-2 rounded-full transition-all duration-500" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                    <div id="hqMinePanel" class="hidden glass rounded-2xl p-4 mb-4" style="border:1px solid rgba(255,215,0,0.3)">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="pickaxe" style="width:24px;height:24px;color:#ffd700;flex-shrink:0;"></i>
                            <div>
                                <p class="font-orbitron text-xs font-bold" style="color:#ffd700;">DIAMOND MINE</p>
                                <p id="hqMineTimerLabel" class="text-white/50 text-xs">Next payout in...</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p id="hqMineTimeLeft" class="font-orbitron font-bold" style="color:#ffd700;">--:--</p>
                            <button id="hqMineClaimBtn" class="hidden text-xs font-orbitron font-bold text-neon-green bg-neon-green/20 border border-neon-green/40 px-3 py-1 rounded-lg hq-mine-ready" onclick="claimMineDiamonds()">CLAIM 5 <i data-lucide="gem" style="width:10px;height:10px;display:inline;vertical-align:middle;color:#ffd700;"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Rooms Grid -->
                <div id="hqRoomsGrid" class="space-y-3"></div>

                <!-- HQ Bonuses Summary -->
                <div class="glass rounded-2xl p-4 mt-4">
                    <p class="font-orbitron text-xs text-white/40 tracking-widest mb-3">ACTIVE HQ BONUSES</p>
                    <div id="hqBonusSummary" class="space-y-2 text-sm">
                        <p class="text-white/30 text-center text-xs">No rooms built yet</p>
                    </div>
                </div>

                <!-- HQ Items Vault -->
                <div class="glass rounded-2xl p-4 mt-4 border border-red-400/20">
                    <div class="flex items-center justify-between mb-3">
                        <p class="font-orbitron text-xs text-red-400 tracking-widest flex items-center gap-2">
                            <i data-lucide="store" style="width:14px;height:14px;"></i> HQ ITEMS VAULT
                        </p>
                        <button onclick="switchTab('BlackMarket')" class="text-red-400 text-xs font-orbitron hover:text-white transition-colors">+ Get More</button>
                    </div>
                    <div id="hqItemsVault" class="space-y-2">
                        <p class="text-white/30 text-center text-xs">No items yet â€” buy from the Black Market</p>
                    </div>
                </div>
            </div>

            <!-- LEADERBOARD TAB -->
            <div id="tabLeaderboard" class="tab-content hidden max-w-lg mx-auto">
                <div class="text-center py-4 mb-4">
                    <p class="text-white/40 text-xs tracking-widest font-orbitron mb-1">CHILL VERSE</p>
                    <h2 class="font-orbitron text-3xl font-black neon-text-cyan mb-1">LEADERBOARD</h2>
                    <p class="text-white/30 text-xs">Live global rankings</p>
                </div>
                <!-- Category tabs -->
                <div class="flex gap-2 mb-5">
                    <button onclick="setLeaderboardTab('chills')" id="lbTabChills" class="flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-neon-cyan/50 bg-neon-cyan/20 text-neon-cyan transition-all flex items-center justify-center gap-1">
                        <i data-lucide="wind" style="width:12px;height:12px;"></i> CHILLS
                    </button>
                    <button onclick="setLeaderboardTab('diamonds')" id="lbTabDiamonds" class="flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-white/10 bg-white/5 text-white/40 transition-all flex items-center justify-center gap-1">
                        <i data-lucide="gem" style="width:12px;height:12px;"></i> DIAMONDS
                    </button>
                    <button onclick="setLeaderboardTab('hq')" id="lbTabHQ" class="flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-white/10 bg-white/5 text-white/40 transition-all flex items-center justify-center gap-1">
                        <i data-lucide="trophy" style="width:12px;height:12px;"></i> TROPHIES
                    </button>
                </div>
                <!-- Rankings list -->
                <div id="lbList" class="space-y-2">
                    <div class="text-center text-white/30 text-sm py-8">Loading rankings...</div>
                </div>
            </div>

            <!-- SOCIAL TAB -->
            <div id="tabSocial" class="tab-content hidden max-w-lg mx-auto">
                <div class="text-center py-4 mb-4">
                    <p class="text-white/40 text-xs tracking-widest font-orbitron mb-1">CHILL VERSE</p>
                    <h2 class="font-orbitron text-3xl font-black neon-text-magenta mb-1">SOCIAL</h2>
                </div>

                <!-- Community Pot -->
                <div class="glass rounded-2xl p-5 mb-5 border border-yellow-400/30" style="box-shadow:0 0 20px rgba(255,180,0,0.15)">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="trophy" style="width:36px;height:36px;color:#ffd700;flex-shrink:0;"></i>
                        <div>
                            <p class="font-orbitron font-bold text-yellow-400">WEEKLY CHILL POT</p>
                            <p class="text-white/40 text-xs">Top 3 stakers win big every Sunday</p>
                        </div>
                    </div>
                    <!-- Pot stats -->
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-white/50">Total Chills Pot</span>
                            <span id="potSize" class="text-yellow-400 font-bold font-orbitron">Loading...</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-white/50">Total Staked This Week</span>
                            <span id="potTotalStaked" class="text-neon-cyan font-bold">â€”</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-white/50">Resets In</span>
                            <span id="potTimeLeft" class="text-neon-purple font-bold">â€”</span>
                        </div>
                    </div>
                    <!-- Prize breakdown -->
                    <div class="bg-black/30 rounded-xl p-3 mb-4 text-xs space-y-1">
                        <p class="text-white/40 font-orbitron mb-2">PRIZE BREAKDOWN</p>
                        <div class="flex justify-between"><span class="text-yellow-400">ðŸ¥‡ 1st</span><span class="text-white/70">700 â—† + 50% of pot</span></div>
                        <div class="flex justify-between"><span class="text-white/60">ðŸ¥ˆ 2nd</span><span class="text-white/70">500 â—† + 30% of pot</span></div>
                        <div class="flex justify-between"><span class="text-white/60">ðŸ¥‰ 3rd</span><span class="text-white/70">200 â—† + 20% of pot</span></div>
                        <p class="text-white/30 mt-2">Every stake contributes 30% to pot</p>
                    </div>
                    <!-- Top 3 stakers -->
                    <div id="potTop3" class="space-y-2 mb-4">
                        <p class="text-white/30 text-center text-xs">No stakes yet this week</p>
                    </div>
                    <!-- Claim buttons (shown when eligible) -->
                    <div id="potClaimArea" class="hidden space-y-2">
                        <p class="text-yellow-400 font-orbitron text-xs text-center mb-2">â° Week ended â€” claim your prize!</p>
                        <button id="potClaim0" class="hidden w-full py-3 rounded-xl bg-yellow-400/20 border border-yellow-400/50 text-yellow-400 font-orbitron font-bold text-sm hover:bg-yellow-400/30 transition-all" onclick="claimPotWin(0)">ðŸ¥‡ CLAIM 1ST PLACE PRIZE</button>
                        <button id="potClaim1" class="hidden w-full py-3 rounded-xl bg-white/10 border border-white/20 text-white font-orbitron font-bold text-sm hover:bg-white/20 transition-all" onclick="claimPotWin(1)">ðŸ¥ˆ CLAIM 2ND PLACE PRIZE</button>
                        <button id="potClaim2" class="hidden w-full py-3 rounded-xl bg-amber-700/20 border border-amber-700/40 text-amber-600 font-orbitron font-bold text-sm hover:bg-amber-700/30 transition-all" onclick="claimPotWin(2)">ðŸ¥‰ CLAIM 3RD PLACE PRIZE</button>
                    </div>
                    <!-- Recent stakes feed -->
                    <div class="mt-4">
                        <p class="text-white/30 font-orbitron text-xs mb-2">RECENT STAKES</p>
                        <div id="potRecentStakes" class="space-y-1 max-h-32 overflow-y-auto">
                            <p class="text-white/20 text-xs text-center">No recent stakes</p>
                        </div>
                    </div>
                </div>

                <!-- Gift Panel -->
                <div class="glass rounded-2xl p-5 mb-5" style="border:1px solid rgba(255,215,0,0.2)">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="gift" style="width:36px;height:36px;color:#ffd700;flex-shrink:0;"></i>
                        <div>
                            <p class="font-orbitron font-bold" style="color:#ffd700;">SEND A GIFT</p>
                            <p class="text-white/40 text-xs">Max 1.5B Chills or 200 <i data-lucide="gem" style="width:10px;height:10px;display:inline;vertical-align:middle;color:#ffd700;"></i> per day</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-white/50 text-xs block mb-1">RECIPIENT USERNAME</label>
                        <input id="giftUsername" type="text" placeholder="Enter exact username"
                            class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:border-yellow-400 focus:outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-white/50 text-xs block mb-1">AMOUNT</label>
                            <input id="giftAmount" type="number" min="1" placeholder="Amount"
                                class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:border-yellow-400 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-white/50 text-xs block mb-1">CURRENCY</label>
                            <select id="giftCurrency" class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-neon-cyan font-orbitron text-sm focus:outline-none">
                                <option value="chills">ðŸ’¨ Chills</option>
                                <option value="diamonds">â—† Diamonds</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="sendGift()" class="w-full py-3 rounded-xl font-orbitron font-bold text-sm transition-all flex items-center justify-center gap-2"
                        style="background:rgba(255,215,0,0.15);border:1px solid rgba(255,215,0,0.4);color:#ffd700;">
                        <i data-lucide="gift" style="width:16px;height:16px;"></i> SEND GIFT
                    </button>
                    <div id="giftDailyLeft" class="text-center text-white/30 text-xs mt-2">Daily left: 1.5B Chills â€¢ 200 â—†</div>
                </div>

                <!-- Visit Profile -->
                <div class="glass rounded-2xl p-5 mb-5 border border-neon-cyan/20">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="user-search" style="width:36px;height:36px;color:#00f5ff;flex-shrink:0;"></i>
                        <div>
                            <p class="font-orbitron font-bold text-neon-cyan">VISIT A PLAYER</p>
                            <p class="text-white/40 text-xs">Search by username to view their profile</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input id="visitUsername" type="text" placeholder="Enter username"
                            class="flex-1 bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:border-neon-cyan focus:outline-none">
                        <button onclick="visitProfile()" class="px-4 py-3 rounded-xl bg-neon-cyan/20 border border-neon-cyan/50 text-neon-cyan font-orbitron font-bold text-sm hover:bg-neon-cyan/30 transition-all">GO</button>
                    </div>
                    <!-- Profile card -->
                    <div id="visitedProfile" class="hidden mt-4 glass rounded-xl p-4 border border-neon-cyan/20"></div>
                </div>

                <!-- My Profile -->
                <div class="glass rounded-2xl p-5 border border-neon-purple/20">
                    <p class="font-orbitron text-xs text-white/40 tracking-widest mb-3">MY PUBLIC PROFILE</p>
                    <div id="myProfileCard" class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-white/50">Username</span><span id="myProfName" class="text-neon-cyan font-bold">â€”</span></div>
                        <div class="flex justify-between"><span class="text-white/50">HQ Rank</span><span id="myProfHQ" class="text-neon-purple font-bold">â€”</span></div>
                        <div class="flex justify-between"><span class="text-white/50">Total Chills</span><span id="myProfChills" class="text-white/70">â€”</span></div>
                        <div class="flex justify-between"><span class="text-white/50">Diamonds</span><span id="myProfDia" class="neon-text-gold font-bold">â€”</span></div>
                        <div class="flex justify-between"><span class="text-white/50">NFTs</span><span id="myProfNFT" class="text-neon-green font-bold">â€”</span></div>
                        <div class="flex justify-between"><span class="text-white/50">Trophies</span><span id="myProfAch" class="text-yellow-400 font-bold">â€”</span></div>
                    </div>
                </div>
            </div>
            <div id="tabAbout" class="tab-content hidden max-w-lg mx-auto">
                <div class="text-center py-4 mb-2">
                    <p class="text-white/40 text-xs tracking-widest font-orbitron mb-1">CHILL VERSE PRESENTS</p>
                    <h2 class="font-orbitron text-3xl font-black neon-text-cyan mb-1">IDLE VERSE</h2>
                    <p class="text-white/30 text-xs">Version 1.4.0 â€¢ Made with Chill</p>
                </div>

                <!-- Game Summary -->
                <div class="glass rounded-2xl p-6 mb-4 border border-neon-cyan/20">
                    <h3 class="font-orbitron text-lg neon-text-magenta mb-3">âš¡ WHAT IS IDLE VERSE?</h3>
                    <p class="text-white/70 leading-relaxed text-sm">Idle Verse is the official idle game of the Chill Verse community â€” a neon-drenched, cyberpunk universe where you accumulate <span class="text-neon-cyan font-bold">Chills</span>, build an empire, and ascend into the <span class="neon-text-gold font-bold">Diamond Verse</span>.</p>
                    <p class="text-white/60 leading-relaxed text-sm mt-3">Tap the Core to generate Chills. Buy Producers to automate your income. Ascend to earn permanent Diamonds. Build your Gang HQ. Raid rivals. Trade on the Black Market. Climb the leaderboard. There is no end goal â€” just chill harder, ascend higher, and let the diamonds flow.</p>
                </div>

                <!-- Features Overview -->
                <div class="glass rounded-2xl p-5 mb-4 border border-neon-purple/20">
                    <h3 class="font-orbitron text-sm neon-text-purple mb-3">ðŸŽ® FEATURES</h3>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="text-neon-cyan">ðŸ’¨</span><p class="text-white/60 mt-1">Idle Production</p></div>
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="neon-text-gold"><span style="color:#ffd700;">â—†</span></span><p class="text-white/60 mt-1">Diamond Ascension</p></div>
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="text-yellow-400">ðŸ </span><p class="text-white/60 mt-1">Gang HQ Building</p></div>
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="text-neon-green">ðŸ“ˆ</span><p class="text-white/60 mt-1">Chill Staking</p></div>
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="text-neon-purple">ðŸ–¼ï¸</span><p class="text-white/60 mt-1">NFT Minting</p></div>
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="text-red-400">âš”ï¸</span><p class="text-white/60 mt-1">HQ Raids</p></div>
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="text-neon-cyan">ðŸ†</span><p class="text-white/60 mt-1">Weekly Pot</p></div>
                        <div class="bg-white/5 rounded-xl p-2 text-center"><span class="text-yellow-400">ðŸ›’</span><p class="text-white/60 mt-1">Black Market</p></div>
                    </div>
                </div>

                <!-- Credits -->
                <div class="glass rounded-2xl p-6 mb-4">
                    <h3 class="font-orbitron text-neon-purple mb-4">CREDITS</h3>
                    <div class="space-y-3 text-white/70 text-sm">
                        <p class="flex items-center gap-2"><span class="text-neon-cyan">Built by:</span><span>Presido &amp; Victor-vk</span></p>
                        <p class="flex items-center gap-2"><span class="text-neon-cyan">Location:</span><span>Nigeria ðŸ‡³ðŸ‡¬</span></p>
                        <p class="flex items-center gap-2"><span class="text-neon-cyan">For:</span><span>@Chill Verse WhatsApp Group</span></p>
                    </div>
                </div>

                <!-- How to Play Button -->
                <button onclick="switchTab('Guide')" class="w-full py-4 rounded-2xl bg-gradient-to-r from-neon-cyan/20 to-neon-purple/20 border border-neon-cyan/40 font-orbitron font-bold text-neon-cyan hover:from-neon-cyan/30 hover:to-neon-purple/30 transition-all mb-4">
                    ðŸ“– HOW TO PLAY â€” FULL GUIDE
                </button>
            </div>

            <!-- GUIDE PAGE -->
            <div id="tabGuide" class="tab-content hidden max-w-lg mx-auto">
                <div class="flex items-center gap-3 mb-6">
                    <button onclick="switchTab('About')" class="text-neon-cyan hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <h2 class="font-orbitron text-2xl neon-text-cyan">HOW TO PLAY</h2>
                </div>
                <div class="space-y-4">
                    <!-- Section 1 -->
                    <div class="glass rounded-2xl p-5 border border-neon-cyan/20">
                        <h3 class="font-orbitron text-neon-cyan mb-2">ðŸ’¨ CHILLING & CLICKING</h3>
                        <p class="text-white/60 text-sm leading-relaxed">Tap the glowing <strong class="text-white">CORE</strong> orb on the Home screen to generate Chills. Each tap gives you Chills equal to your Click Power. The more you tap, the faster you earn early on. Your current Chills are shown at the top of the screen and your Chills Per Second (CPS) below it.</p>
                    </div>
                    <!-- Section 2 -->
                    <div class="glass rounded-2xl p-5 border border-neon-purple/20">
                        <h3 class="font-orbitron text-neon-purple mb-2">ðŸ­ PRODUCERS</h3>
                        <p class="text-white/60 text-sm leading-relaxed">Visit the <strong class="text-white">Production Shop</strong> to buy Producers â€” machines that generate Chills for you automatically every second. Start with the cheapest (Neon Pod) and work up. You can buy 1, 10, or 100 at a time. Each producer gets 15% more expensive per purchase, so save up and bulk buy.</p>
                    </div>
                    <!-- Section 3 -->
                    <div class="glass rounded-2xl p-5 border border-yellow-400/30">
                        <h3 class="font-orbitron neon-text-gold mb-2">â—† DIAMONDS & ASCENDING</h3>
                        <p class="text-white/60 text-sm leading-relaxed">Once you've earned 10,000+ total Chills, you can <strong class="text-white">Ascend</strong> from the Diamonds tab. This resets your Chills and Producers but awards permanent <strong class="neon-text-gold">Diamonds</strong>. Diamonds buy upgrades that make every future run faster â€” like the Global Multiplier (+10% all production per level) and Click Power upgrades. The more total Chills you earn before ascending, the more Diamonds you receive.</p>
                    </div>
                    <!-- Section 4 -->
                    <div class="glass rounded-2xl p-5 border border-neon-purple/20">
                        <h3 class="font-orbitron text-neon-purple mb-2">ðŸ–¼ï¸ NFTs & MINTING</h3>
                        <p class="text-white/60 text-sm leading-relaxed">In the <strong class="text-white">NFTs tab</strong> you can mint NFT cards by spending 100,000 Chills + 50 Diamonds. The mint takes 5.5 hours. When done, claim a random NFT â€” Common (70%), Rare (20%), or Legend (10%). Your collection is displayed in the NFT Vault. NFTs can also be sold on the <strong class="text-red-400">Black Market</strong>.</p>
                    </div>
                    <!-- Section 5 -->
                    <div class="glass rounded-2xl p-5 border border-yellow-400/20">
                        <h3 class="font-orbitron text-yellow-400 mb-2">ðŸ  GANG HQ & ROOMS</h3>
                        <p class="text-white/60 text-sm leading-relaxed">The <strong class="text-white">Gang HQ</strong> lets you build and upgrade 10 rooms, each with 3 tiers. Rooms give powerful bonuses â€” more CPS, better click power, diamond mine payouts, and more. Each room takes 5 hours to build and 5 hours to reside before upgrading further. Some rooms cost both Chills and Diamonds. You can apply an owned Artefact to reduce a room's cost (one artefact per room, used once). Build all 30 tiers to reach ðŸ‘‘ THE VERSE THRONE.</p>
                    </div>
                    <!-- Section 6 -->
                    <div class="glass rounded-2xl p-5 border border-neon-green/20">
                        <h3 class="font-orbitron text-neon-green mb-2">ðŸ“ˆ STAKING</h3>
                        <p class="text-white/60 text-sm leading-relaxed">In the <strong class="text-white">Stake tab</strong> you can bet Chills or Diamonds on a price chart going UP (Buy) or DOWN (Sell). After the timer ends, if you predicted correctly you win 1.0xâ€“1.9x your stake back. Lose and it's gone. Chill stakes are open amounts; Diamond stakes allow up to 1,000 â—†. Be careful â€” it's a game of chance.</p>
                    </div>
                    <!-- Section 7 -->
                    <div class="glass rounded-2xl p-5 border border-yellow-400/30">
                        <h3 class="font-orbitron neon-text-gold mb-2">ðŸŽ SOCIAL & GIFTING</h3>
                        <p class="text-white/60 text-sm leading-relaxed">In the <strong class="text-white">Social tab</strong> you can gift Chills or Diamonds to any player by username (up to 1.5B Chills or 200 â—† per day). You can also search and visit any player's profile to view their stats, add them as a friend, or send a raid. The <strong class="text-yellow-400">Weekly Chill Pot</strong> collects 30% of all staked amounts â€” the top 3 stakers at week's end share the pot plus Diamond prizes (700/500/200 â—†).</p>
                    </div>
                    <!-- Section 8 -->
                    <div class="glass rounded-2xl p-5 border border-red-400/20">
                        <h3 class="font-orbitron text-red-400 mb-2">ðŸ›’ BLACK MARKET</h3>
                        <p class="text-white/60 text-sm leading-relaxed">The <strong class="text-white">Black Market</strong> is where players buy and sell NFTs and HQ items. You can list any NFT you own for a price in Chills or Diamonds. Other players can browse and purchase listings. HQ decorations and items are also sold here â€” things like Shields (protects your HQ from raids for 24h), Power Boosters, and cosmetic room decorations.</p>
                    </div>
                    <!-- Section 9 -->
                    <div class="glass rounded-2xl p-5 border border-red-500/20">
                        <h3 class="font-orbitron text-red-400 mb-2">âš”ï¸ RAIDS</h3>
                        <p class="text-white/60 text-sm leading-relaxed">Visit a player's profile and hit the <strong class="text-red-400">Raid</strong> button to attack their HQ. Raids cost 200M Chills + 5 â—†. Your odds of winning depend on the difference in HQ tier count between you and your target. Win and you loot a percentage of the raid cost plus a 10% chance of bonus Diamonds. You can only raid the same player once per day. Buy a <strong class="text-white">Shield</strong> from the Black Market to protect yourself for 24 hours.</p>
                    </div>
                    <!-- Section 10 -->
                    <div class="glass rounded-2xl p-5 border border-yellow-400/20">
                        <h3 class="font-orbitron text-yellow-400 mb-2">ðŸ† LEADERBOARD & DAILY REWARDS</h3>
                        <p class="text-white/60 text-sm leading-relaxed">The <strong class="text-white">Leaderboard</strong> shows the top 50 players ranked by Total Chills, Diamonds, or Trophy count. Every day at midnight, the top 3 players on the Chills leaderboard earn bonus Diamonds: 1st place gets 3 â—†, 2nd gets 2 â—†, and 3rd gets 1 â—†. These are delivered automatically on your next login.</p>
                    </div>
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="tabProfile" class="tab-content hidden max-w-lg mx-auto">
                <div class="text-center py-4 mb-4">
                    <p class="text-white/40 text-xs tracking-widest font-orbitron mb-1">CHILL VERSE</p>
                    <h2 class="font-orbitron text-3xl font-black neon-text-cyan mb-1">MY PROFILE</h2>
                </div>

                <!-- Avatar & Stats Card -->
                <div class="glass rounded-2xl p-6 mb-4 border border-neon-cyan/30" style="background:linear-gradient(135deg,rgba(0,243,255,0.05),rgba(157,0,255,0.05))">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl font-orbitron font-black" style="background:linear-gradient(135deg,rgba(0,243,255,0.3),rgba(157,0,255,0.3));border:2px solid rgba(0,243,255,0.4);">
                            <span id="profileAvatar">?</span>
                        </div>
                        <div class="flex-1">
                            <p id="profPageName" class="font-orbitron text-xl text-white font-black">â€”</p>
                            <div class="inline-block px-2 py-0.5 rounded-full text-xs font-orbitron mt-1" style="background:rgba(157,0,255,0.2);border:1px solid rgba(157,0,255,0.4);color:#9d00ff;">
                                <span id="profPageHQ">Empty Lot</span>
                            </div>
                        </div>
                        <button onclick="document.getElementById('editNameBtn').click()" class="text-neon-cyan text-xs font-orbitron border border-neon-cyan/30 px-3 py-2 rounded-xl hover:bg-neon-cyan/10 transition-all">EDIT</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-white/5 rounded-xl p-3 text-center">
                            <p id="profPageChills" class="font-orbitron font-bold text-neon-cyan text-sm">0</p>
                            <p class="text-white/40 text-xs mt-1">Total Chills</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 text-center">
                            <p id="profPageDia" class="font-orbitron font-bold neon-text-gold text-sm">0 â—†</p>
                            <p class="text-white/40 text-xs mt-1">Diamonds</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 text-center">
                            <p id="profPageNFT" class="font-orbitron font-bold text-neon-green text-sm">0</p>
                            <p class="text-white/40 text-xs mt-1">NFTs</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 text-center">
                            <p id="profPageTrophies" class="font-orbitron font-bold text-yellow-400 text-sm">0</p>
                            <p class="text-white/40 text-xs mt-1">Trophies</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 text-center">
                            <p id="profPageAscensions" class="font-orbitron font-bold text-neon-purple text-sm">0</p>
                            <p class="text-white/40 text-xs mt-1">Ascensions</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 text-center">
                            <p id="profPageRaidWins" class="font-orbitron font-bold text-red-400 text-sm">0</p>
                            <p class="text-white/40 text-xs mt-1">Raid Wins</p>
                        </div>
                    </div>
                </div>

                <!-- Friend Requests Incoming -->
                <div id="friendRequestsSection" class="glass rounded-2xl p-5 mb-4 border border-neon-green/20">
                    <div class="flex items-center justify-between mb-3">
                        <p class="font-orbitron text-neon-green text-sm flex items-center gap-2">
                            <i data-lucide="mail" style="width:16px;height:16px;"></i> FRIEND REQUESTS
                        </p>
                        <button onclick="loadFriendRequests()" class="text-white/40 text-xs hover:text-white transition-colors">Refresh</button>
                    </div>
                    <div id="friendRequestsList" class="space-y-2">
                        <p class="text-white/30 text-xs text-center">No pending requests</p>
                    </div>
                </div>

                <!-- Friends List -->
                <div class="glass rounded-2xl p-5 mb-4 border border-neon-cyan/20">
                    <div class="flex items-center justify-between mb-3">
                        <p class="font-orbitron text-neon-cyan text-sm flex items-center gap-2">
                            <i data-lucide="users" style="width:16px;height:16px;"></i> FRIENDS
                        </p>
                        <button onclick="loadFriendsList()" class="text-white/40 text-xs hover:text-white transition-colors">Refresh</button>
                    </div>
                    <div id="friendsList" class="space-y-2">
                        <p class="text-white/30 text-xs text-center">No friends yet â€” visit players to add them!</p>
                    </div>
                </div>

                <!-- Gift Button from Profile -->
                <button onclick="switchTab('Social')" class="w-full py-3 mb-4 rounded-xl font-orbitron font-bold text-sm transition-all flex items-center justify-center gap-2"
                    style="background:rgba(255,215,0,0.15);border:1px solid rgba(255,215,0,0.4);color:#ffd700;">
                    <i data-lucide="gift" style="width:16px;height:16px;"></i> SEND A GIFT â†’ SOCIAL
                </button>

                <!-- Raid History -->
                <div class="glass rounded-2xl p-5 border border-red-500/20">
                    <p class="font-orbitron text-red-400 text-sm mb-3 flex items-center gap-2">
                        <i data-lucide="swords" style="width:16px;height:16px;"></i> RAID HISTORY
                    </p>
                    <div id="profileRaidHistory" class="space-y-2">
                        <p class="text-white/30 text-xs text-center">No raids yet</p>
                    </div>
                </div>
            </div>

            <!-- BLACK MARKET PAGE -->
            <div id="tabBlackMarket" class="tab-content hidden max-w-lg mx-auto">
                <div class="text-center py-4 mb-4">
                    <p class="text-white/40 text-xs tracking-widest font-orbitron mb-1">CHILL VERSE</p>
                    <h2 class="font-orbitron text-3xl font-black text-red-400 mb-1" style="text-shadow:0 0 20px rgba(255,80,80,0.5)">BLACK MARKET</h2>
                    <p class="text-white/30 text-xs">Buy & sell NFTs â€¢ HQ items â€¢ Listings refresh daily</p>
                </div>

                <!-- Market Tabs -->
                <div class="flex gap-2 mb-5">
                    <button onclick="setMarketTab('browse')" id="mktTabBrowse" class="flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-red-400/50 bg-red-400/20 text-red-400 transition-all flex items-center justify-center gap-1">
                        <i data-lucide="shopping-cart" style="width:12px;height:12px;"></i> BROWSE
                    </button>
                    <button onclick="setMarketTab('sell')" id="mktTabSell" class="flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-white/10 bg-white/5 text-white/40 transition-all flex items-center justify-center gap-1">
                        <i data-lucide="package" style="width:12px;height:12px;"></i> SELL
                    </button>
                    <button onclick="setMarketTab('hqitems')" id="mktTabHQ" class="flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-white/10 bg-white/5 text-white/40 transition-all flex items-center justify-center gap-1">
                        <i data-lucide="building-2" style="width:12px;height:12px;"></i> HQ ITEMS
                    </button>
                </div>

                <!-- Browse Listings -->
                <div id="mktBrowsePanel">
                    <div class="flex items-center justify-between mb-3">
                        <p class="font-orbitron text-xs text-white/40 tracking-widest">ACTIVE LISTINGS</p>
                        <button onclick="loadMarketListings()" class="text-red-400 text-xs hover:text-white transition-colors font-orbitron">â†» REFRESH</button>
                    </div>
                    <div id="marketListings" class="space-y-3">
                        <div class="text-center text-white/30 py-8">
                            <p class="text-4xl mb-2">ðŸª</p>
                            <p class="text-sm">Loading market...</p>
                        </div>
                    </div>
                </div>

                <!-- Sell Panel -->
                <div id="mktSellPanel" class="hidden">
                    <div class="glass rounded-2xl p-5 mb-4 border border-red-400/20">
                        <p class="font-orbitron text-red-400 mb-4 text-center">LIST AN NFT FOR SALE</p>
                        <label class="text-white/50 text-xs block mb-2">SELECT YOUR NFT</label>
                        <select id="sellNFTSelect" class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:border-red-400 focus:outline-none mb-4">
                            <option value="">â€” Choose an NFT to sell â€”</option>
                        </select>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="text-white/50 text-xs block mb-1">CHILLS PRICE</label>
                                <input id="sellPriceChills" type="number" min="0" placeholder="0 = free"
                                    class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:border-red-400 focus:outline-none">
                            </div>
                            <div>
                                <label class="text-white/50 text-xs block mb-1">DIAMONDS PRICE</label>
                                <input id="sellPriceDia" type="number" min="0" placeholder="0 = free"
                                    class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-3 text-white font-orbitron text-sm focus:border-red-400 focus:outline-none">
                            </div>
                        </div>
                        <button onclick="listNFTForSale()" class="w-full py-3 rounded-xl bg-red-400/20 border border-red-400/50 text-red-400 font-orbitron font-bold text-sm hover:bg-red-400/30 transition-all">ðŸ“¦ LIST FOR SALE</button>
                    </div>
                    <div id="myListings" class="space-y-3">
                        <p class="text-white/30 text-xs text-center">Your active listings will appear here</p>
                    </div>
                </div>

                <!-- HQ Items Shop -->
                <div id="mktHQPanel" class="hidden">
                    <div class="space-y-3" id="hqItemsShop"></div>
                </div>
            </div>
            </div>

            <!-- CONTACTS TAB -->
            <div id="tabContacts" class="tab-content hidden max-w-lg mx-auto">
                <h2 class="font-orbitron text-2xl neon-text-cyan mb-6 text-center">CONTACTS</h2>
                <div class="space-y-4">
                    <a href="https://chat.whatsapp.com/F7hNH78V3TPISp9HIZHqLa?mode=gi_t" target="_blank" rel="noopener noreferrer"
                        class="flex items-center gap-4 p-4 glass rounded-2xl hover:bg-green-500/10 border border-transparent hover:border-green-500/30 transition-all group">
                        <div class="w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 group-hover:bg-green-500/30 transition-all">
                            <svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-bold text-white group-hover:text-green-300 transition-colors">WhatsApp</p>
                            <p class="text-white/50 text-sm">Join the Chill Verse group</p>
                        </div>
                        <svg class="w-5 h-5 text-white/30 ml-auto group-hover:text-green-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                    </a>

                    <a href="/cdn-cgi/l/email-protection#cba9a7a8a0b8babeaab9aefbfbfa8baca6aaa2a7e5a8a4a6f4b8bea9a1aea8bff6899e8ceb998e9b849f98eda9a4afb2f683a2eb8faebde7eba2ebbca4bea7afeba7a2a0aeebbfa4" target="_blank" rel="noopener noreferrer" class="flex items-center gap-4 p-4 glass rounded-2xl hover:bg-neon-cyan/10 border border-transparent hover:border-neon-cyan/30 transition-all group">
                        <div class="w-12 h-12 rounded-full bg-neon-cyan/20 flex items-center justify-center flex-shrink-0 group-hover:bg-neon-cyan/30 transition-all">
                            <svg class="w-6 h-6 text-neon-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        </div>
                        <div>
                            <p class="font-bold text-white group-hover:text-neon-cyan transition-colors">Email</p>
                            <p class="text-white/50 text-sm"><span class="__cf_email__" data-cfemail="dcbeb0bfb7afada9bdaeb9ececed9cbbb1bdb5b0f2bfb3b1"><span class="__cf_email__" data-cfemail="ea88868981999b9f8b988fdadadbaa8d878b8386c4898587">[email&#160;protected]</span></span></p>
                        </div>
                        <svg class="w-5 h-5 text-white/30 ml-auto group-hover:text-neon-cyan transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                    </a>

                    <a href="https://x.com/YoungPresido34" target="_blank" rel="noopener noreferrer"
                        class="flex items-center gap-4 p-4 glass rounded-2xl hover:bg-neon-purple/10 border border-transparent hover:border-neon-purple/30 transition-all group">
                        <div class="w-12 h-12 rounded-full bg-neon-purple/20 flex items-center justify-center flex-shrink-0 group-hover:bg-neon-purple/30 transition-all">
                            <svg class="w-6 h-6 text-neon-purple" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </div>
                        <div>
                            <p class="font-bold text-white group-hover:text-neon-purple transition-colors">X / Twitter</p>
                            <p class="text-white/50 text-sm">@YoungPresido34</p>
                        </div>
                        <svg class="w-5 h-5 text-white/30 ml-auto group-hover:text-neon-purple transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                    </a>
                </div>
            </div>

        </div>

    </div>

    <!-- Background Music -->
    <audio id="bgMusic" loop preload="auto">
        <source src="Sounds/Sound 1.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Ascend Confirmation Modal -->
    <div id="ascendModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="glass-strong rounded-2xl p-6 max-w-sm w-full text-center">
            <svg class="w-16 h-16 mx-auto mb-4 neon-text-gold" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/>
            </svg>
            <h3 class="font-orbitron text-xl neon-text-gold mb-2">ASCEND?</h3>
            <p class="text-white/70 mb-4">This will reset ALL your progress but you'll keep <span id="modalDiamonds" class="neon-text-gold font-bold">0</span> Diamonds permanently.</p>
            <div class="flex gap-3">
                <button id="cancelAscend" class="flex-1 py-3 rounded-xl border border-white/30 text-white/70 hover:bg-white/10 transition-all">CANCEL</button>
                <button id="confirmAscend" class="flex-1 py-3 rounded-xl font-bold transition-all" style="background:linear-gradient(135deg,rgba(255,215,0,0.25),rgba(157,0,255,0.2));border:1px solid rgba(255,215,0,0.5);color:#ffd700;">ASCEND</button>
            </div>
        </div>
    </div>
    
    <!-- Reset Confirmation Modal -->
    <div id="resetModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="glass-strong rounded-2xl p-6 max-w-sm w-full text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <h3 class="font-orbitron text-xl text-red-400 mb-2">RESET GAME?</h3>
            <p class="text-white/70 mb-4">This will DELETE ALL your progress forever. This cannot be undone!</p>
            <div class="flex gap-3">
                <button id="cancelReset" class="flex-1 py-3 rounded-xl border border-white/30 text-white/70 hover:bg-white/10 transition-all">CANCEL</button>
                <button id="confirmReset" class="flex-1 py-3 rounded-xl bg-red-500/30 border border-red-500/50 text-red-400 font-bold hover:bg-red-500/40 transition-all">DELETE</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Name Modal -->
    <div id="editNameModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="glass-strong rounded-2xl p-6 max-w-sm w-full">
            <h3 class="font-orbitron text-xl neon-text-cyan mb-4 text-center">CHANGE HANDLE</h3>
            <input type="text" id="newNameInput" placeholder="New chill handle..." 
                class="w-full bg-black/30 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:border-neon-cyan focus:outline-none transition-colors text-center font-orbitron mb-4">
            <div class="flex gap-3">
                <button id="cancelEditName" class="flex-1 py-3 rounded-xl border border-white/30 text-white/70 hover:bg-white/10 transition-all">CANCEL</button>
                <button id="saveName" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-neon-cyan/30 to-neon-purple/30 border border-neon-cyan/50 text-white font-bold hover:from-neon-cyan/40 hover:to-neon-purple/40 transition-all">SAVE</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ==================== ACHIEVEMENTS ====================
        // reward types: 'cps_mult', 'click_mult', 'click_flat', 'diamonds', 'chills', 'producer_mult'
        const ACHIEVEMENTS = [
            // â”€â”€ CLICKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'first_click',      category:'clicking',  icon:'ðŸ‘†', name:'First Touch',         desc:'Click the Chill Core for the first time',   check:s=>s.totalClicks>=1,      reward:null },
            { id: 'clicks_50',        category:'clicking',  icon:'âœŒï¸', name:'Warm Fingers',         desc:'Click 50 times',                            check:s=>s.totalClicks>=50,     reward:{type:'click_flat', val:1, label:'+1 Click Power'} },
            { id: 'clicks_100',       category:'clicking',  icon:'ðŸ–±ï¸', name:'Clicker',              desc:'Click 100 times',                           check:s=>s.totalClicks>=100,    reward:{type:'chills', val:500, label:'+500 Chills'} },
            { id: 'clicks_500',       category:'clicking',  icon:'ðŸ”¥', name:'Tap Fever',            desc:'Click 500 times',                           check:s=>s.totalClicks>=500,    reward:{type:'click_flat', val:2, label:'+2 Click Power'} },
            { id: 'clicks_1000',      category:'clicking',  icon:'âš¡', name:'Click Maniac',         desc:'Click 1,000 times',                         check:s=>s.totalClicks>=1000,   reward:{type:'click_mult', val:0.10, label:'+10% Click Power'} },
            { id: 'clicks_5000',      category:'clicking',  icon:'ðŸ’¢', name:'Relentless',           desc:'Click 5,000 times',                         check:s=>s.totalClicks>=5000,   reward:{type:'click_flat', val:5, label:'+5 Click Power'} },
            { id: 'clicks_10000',     category:'clicking',  icon:'ðŸŒ€', name:'Tap God',              desc:'Click 10,000 times',                        check:s=>s.totalClicks>=10000,  reward:{type:'click_mult', val:0.25, label:'+25% Click Power'} },
            { id: 'clicks_50000',     category:'clicking',  icon:'ðŸŒŒ', name:'Infinity Tap',         desc:'Click 50,000 times',                        check:s=>s.totalClicks>=50000,  reward:{type:'click_mult', val:0.50, label:'+50% Click Power'} },

            // â”€â”€ CHILLS EARNED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'chills_100',       category:'chills',    icon:'â„ï¸', name:'Chilly Start',         desc:'Earn 100 total Chills',                     check:s=>s.totalChills>=100,          reward:null },
            { id: 'chills_1k',        category:'chills',    icon:'ðŸŒŠ', name:'Chill Wave',           desc:'Earn 1,000 total Chills',                   check:s=>s.totalChills>=1000,         reward:{type:'chills', val:1000, label:'+1,000 Chills'} },
            { id: 'chills_10k',       category:'chills',    icon:'ðŸ§Š', name:'Frost Bloom',          desc:'Earn 10,000 total Chills',                  check:s=>s.totalChills>=10000,        reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'chills_100k',      category:'chills',    icon:'ðŸ’«', name:'Chill Storm',          desc:'Earn 100,000 total Chills',                 check:s=>s.totalChills>=100000,       reward:{type:'chills', val:50000, label:'+50,000 Chills'} },
            { id: 'chills_1m',        category:'chills',    icon:'ðŸŒŒ', name:'Chill Universe',       desc:'Earn 1 Million total Chills',               check:s=>s.totalChills>=1e6,          reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'chills_10m',       category:'chills',    icon:'ðŸš€', name:'Chill Rocket',         desc:'Earn 10 Million total Chills',              check:s=>s.totalChills>=1e7,          reward:{type:'diamonds', val:5, label:'+5 Diamonds'} },
            { id: 'chills_100m',      category:'chills',    icon:'ðŸŒ ', name:'Chill Comet',          desc:'Earn 100 Million total Chills',             check:s=>s.totalChills>=1e8,          reward:{type:'cps_mult', val:0.15, label:'+15% Global CPS'} },
            { id: 'chills_1b',        category:'chills',    icon:'ðŸª', name:'Chill Galaxy',         desc:'Earn 1 Billion total Chills',               check:s=>s.totalChills>=1e9,          reward:{type:'diamonds', val:20, label:'+20 Diamonds'} },
            { id: 'chills_1t',        category:'chills',    icon:'ðŸŒ€', name:'Chill Multiverse',     desc:'Earn 1 Trillion total Chills',              check:s=>s.totalChills>=1e12,         reward:{type:'cps_mult', val:0.25, label:'+25% Global CPS'} },

            // â”€â”€ PRODUCERS OWNED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'first_producer',   category:'producers', icon:'ðŸ­', name:'First Factory',        desc:'Buy your first producer',                   check:s=>s.producers.some(p=>p.owned>=1),                           reward:{type:'chills', val:100, label:'+100 Chills'} },
            { id: 'prod_5',           category:'producers', icon:'ðŸ”©', name:'Getting Started',      desc:'Own 5 producers total',                     check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=5,                 reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'prod_10',          category:'producers', icon:'ðŸ”§', name:'Getting Busy',         desc:'Own 10 producers total',                    check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=10,                reward:{type:'chills', val:5000, label:'+5,000 Chills'} },
            { id: 'prod_25',          category:'producers', icon:'ðŸ—ï¸', name:'Workshop',             desc:'Own 25 producers total',                    check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=25,                reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'prod_50',          category:'producers', icon:'ðŸ™ï¸', name:'Verse Builder',        desc:'Own 50 producers total',                    check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=50,                reward:{type:'click_flat', val:3, label:'+3 Click Power'} },
            { id: 'prod_100',         category:'producers', icon:'ðŸŒ†', name:'Chill Empire',         desc:'Own 100 producers total',                   check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=100,               reward:{type:'cps_mult', val:0.15, label:'+15% Global CPS'} },
            { id: 'prod_250',         category:'producers', icon:'ðŸŒƒ', name:'Mega Empire',          desc:'Own 250 producers total',                   check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=250,               reward:{type:'diamonds', val:10, label:'+10 Diamonds'} },
            { id: 'prod_500',         category:'producers', icon:'ðŸŒ', name:'Infinite Factory',     desc:'Own 500 producers total',                   check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=500,               reward:{type:'cps_mult', val:0.25, label:'+25% Global CPS'} },
            { id: 'prod_1000',        category:'producers', icon:'ðŸš€', name:'Unstoppable',          desc:'Own 1,000 producers total',                 check:s=>s.producers.reduce((a,p)=>a+p.owned,0)>=1000,              reward:{type:'diamonds', val:25, label:'+25 Diamonds'} },
            { id: 'all_producers',    category:'producers', icon:'ðŸŽ›ï¸', name:'Full Verse',           desc:'Own at least 1 of every producer',          check:s=>s.producers.every(p=>p.owned>=1),                          reward:{type:'cps_mult', val:0.20, label:'+20% Global CPS'} },
            { id: 'all_prod_10',      category:'producers', icon:'ðŸ’¥', name:'Stacked',              desc:'Own at least 10 of every producer',         check:s=>s.producers.every(p=>p.owned>=10),                         reward:{type:'cps_mult', val:0.30, label:'+30% Global CPS'} },
            { id: 'pod_100',          category:'producers', icon:'ðŸŸ¦', name:'Pod Farm',             desc:'Own 100 Neon Pods',                         check:s=>s.producers[0]?.owned>=100,                                reward:{type:'producer_mult', prodIdx:0, val:0.25, label:'+25% Neon Pod output'} },
            { id: 'flicker_50',       category:'producers', icon:'ðŸ”µ', name:'Flicker Gang',         desc:'Own 50 Holo Flickers',                      check:s=>s.producers[1]?.owned>=50,                                 reward:{type:'producer_mult', prodIdx:1, val:0.25, label:'+25% Holo Flicker output'} },
            { id: 'drone_50',         category:'producers', icon:'ðŸ¤–', name:'Drone Army',           desc:'Own 50 Quantum Drones',                     check:s=>s.producers[2]?.owned>=50,                                 reward:{type:'producer_mult', prodIdx:2, val:0.25, label:'+25% Quantum Drone output'} },

            // â”€â”€ CPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'cps_1',            category:'cps',       icon:'ðŸŒ¬ï¸', name:'Breeze',               desc:'Reach 1 Chill/s',                           check:_=>getCPS()>=1,     reward:null },
            { id: 'cps_10',           category:'cps',       icon:'ðŸ’¨', name:'Wind',                 desc:'Reach 10 Chills/s',                         check:_=>getCPS()>=10,    reward:{type:'chills', val:500, label:'+500 Chills'} },
            { id: 'cps_100',          category:'cps',       icon:'ðŸŒªï¸', name:'Vortex',               desc:'Reach 100 Chills/s',                        check:_=>getCPS()>=100,   reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'cps_1k',           category:'cps',       icon:'âš¡', name:'Lightning',            desc:'Reach 1,000 Chills/s',                      check:_=>getCPS()>=1000,  reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'cps_10k',          category:'cps',       icon:'ðŸŒŠ', name:'Tsunami',              desc:'Reach 10,000 Chills/s',                     check:_=>getCPS()>=10000, reward:{type:'diamonds', val:5, label:'+5 Diamonds'} },
            { id: 'cps_100k',         category:'cps',       icon:'ðŸ”±', name:'Trident',              desc:'Reach 100,000 Chills/s',                    check:_=>getCPS()>=100000,reward:{type:'cps_mult', val:0.15, label:'+15% Global CPS'} },
            { id: 'cps_1m',           category:'cps',       icon:'ðŸŒ ', name:'Singularity',          desc:'Reach 1 Million Chills/s',                  check:_=>getCPS()>=1e6,   reward:{type:'diamonds', val:15, label:'+15 Diamonds'} },
            { id: 'cps_1b',           category:'cps',       icon:'ðŸŒŒ', name:'Godspeed',             desc:'Reach 1 Billion Chills/s',                  check:_=>getCPS()>=1e9,   reward:{type:'cps_mult', val:0.50, label:'+50% Global CPS'} },

            // â”€â”€ DIAMONDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'first_ascend',     category:'diamonds',  icon:"â—†", name:'First Ascension',      desc:'Ascend for the first time',                 check:s=>s.totalAscensions>=1,  reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'ascend_3',         category:'diamonds',  icon:'ðŸ”·', name:'Veteran',              desc:'Ascend 3 times',                            check:s=>s.totalAscensions>=3,  reward:{type:'click_flat', val:5, label:'+5 Click Power'} },
            { id: 'ascend_5',         category:'diamonds',  icon:'ðŸŒŸ', name:'Serial Ascender',      desc:'Ascend 5 times',                            check:s=>s.totalAscensions>=5,  reward:{type:'cps_mult', val:0.15, label:'+15% Global CPS'} },
            { id: 'ascend_10',        category:'diamonds',  icon:'ðŸ†', name:'Transcendent',         desc:'Ascend 10 times',                           check:s=>s.totalAscensions>=10, reward:{type:'diamonds', val:10, label:'+10 Diamonds'} },
            { id: 'ascend_25',        category:'diamonds',  icon:'ðŸ‘‘', name:'Eternal',              desc:'Ascend 25 times',                           check:s=>s.totalAscensions>=25, reward:{type:'cps_mult', val:0.50, label:'+50% Global CPS'} },
            { id: 'diamonds_5',       category:'diamonds',  icon:'ðŸ’ ', name:'Diamond Dabbler',      desc:'Have 5 Diamonds at once',                   check:s=>s.diamonds>=5,         reward:{type:'chills', val:2000, label:'+2,000 Chills'} },
            { id: 'diamonds_25',      category:'diamonds',  icon:'ðŸ”®', name:'Diamond Collector',    desc:'Have 25 Diamonds at once',                  check:s=>s.diamonds>=25,        reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'diamonds_100',     category:'diamonds',  icon:'ðŸ’', name:'Diamond Hoarder',      desc:'Have 100 Diamonds at once',                 check:s=>s.diamonds>=100,       reward:{type:'diamonds', val:10, label:'+10 Diamonds'} },
            { id: 'diamonds_500',     category:'diamonds',  icon:'ðŸŒŸ', name:'Diamond Lord',         desc:'Have 500 Diamonds at once',                 check:s=>s.diamonds>=500,       reward:{type:'cps_mult', val:0.25, label:'+25% Global CPS'} },
            { id: 'total_diamonds_50',category:'diamonds',  icon:'âš—ï¸', name:'Alchemist',            desc:'Earn 50 total Diamonds (all-time)',          check:s=>(s.totalDiamonds||0)>=50,   reward:{type:'click_mult', val:0.15, label:'+15% Click Power'} },

            // â”€â”€ WEB3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'wallet',           category:'web3',      icon:'ðŸ”—', name:'Web3 Chiller',         desc:'Connect your wallet',                       check:s=>s.walletConnected,     reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'nft_1',            category:'web3',      icon:'ðŸ–¼ï¸', name:'NFT Pioneer',          desc:'Mint your first NFT',                       check:s=>s.nftCount>=1,         reward:{type:'chills', val:10000, label:'+10,000 Chills'} },
            { id: 'nft_3',            category:'web3',      icon:'ðŸŽ¨', name:'NFT Enthusiast',       desc:'Mint 3 NFTs',                               check:s=>s.nftCount>=3,         reward:{type:'click_flat', val:3, label:'+3 Click Power'} },
            { id: 'nft_5',            category:'web3',      icon:'ðŸ›ï¸', name:'NFT Collector',        desc:'Mint 5 NFTs',                               check:s=>s.nftCount>=5,         reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'nft_10',           category:'web3',      icon:'ðŸŽ­', name:'NFT Whale',            desc:'Mint 10 NFTs',                              check:s=>s.nftCount>=10,        reward:{type:'diamonds', val:15, label:'+15 Diamonds'} },

            // â”€â”€ SAVINGS / TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'save_1',           category:'time',      icon:'ðŸ’¾', name:'Saved',                desc:'Save the game for the first time',          check:s=>!!s.lastSave,          reward:null },
            { id: 'offline_1k',       category:'time',      icon:'ðŸ˜´', name:'While You Slept',      desc:'Earn 1,000 Chills offline',                 check:s=>(s.totalOfflineChills||0)>=1000,   reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'offline_1m',       category:'time',      icon:'ðŸŒ™', name:'Dream Farmer',         desc:'Earn 1 Million Chills offline',             check:s=>(s.totalOfflineChills||0)>=1e6,    reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },

            // â”€â”€ MILESTONES / COMBO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'click_and_cps',    category:'milestones',icon:'âš–ï¸', name:'Balanced',             desc:'Have 100+ click power and 100+ CPS',        check:s=>getClickPower()>=100&&getCPS()>=100,  reward:{type:'cps_mult', val:0.20, label:'+20% Global CPS'} },
            { id: 'rich',             category:'milestones',icon:'ðŸ’°', name:'Rolling in Chills',    desc:'Have 1 Million Chills at once',             check:s=>s.chills>=1e6,                        reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'mega_rich',        category:'milestones',icon:'ðŸ¤‘', name:'Chill Billionaire',    desc:'Have 1 Billion Chills at once',             check:s=>s.chills>=1e9,                        reward:{type:'diamonds', val:30, label:'+30 Diamonds'} },
            { id: 'chill_100_cps',    category:'milestones',icon:'ðŸ…', name:'Century',              desc:'Have exactly 100 CPS',                      check:s=>Math.floor(getCPS())===100,           reward:{type:'click_flat', val:10, label:'+10 Click Power'} },
            { id: 'spend_1m',         category:'milestones',icon:'ðŸ›ï¸', name:'Big Spender',          desc:'Spend 1 Million Chills on producers',       check:s=>(s.totalSpent||0)>=1e6,               reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'spend_1b',         category:'milestones',icon:'ðŸ’¸', name:'Whale',                desc:'Spend 1 Billion Chills on producers',       check:s=>(s.totalSpent||0)>=1e9,               reward:{type:'diamonds', val:20, label:'+20 Diamonds'} },

            // â”€â”€ SECRET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'secret_name',      category:'secret',    icon:'ðŸ•µï¸', name:'Who Are You?',         desc:'Change your Chill Handle',                  check:s=>s.nameChanges>=1,                     reward:{type:'chills', val:1000, label:'+1,000 Chills'} },
            { id: 'secret_name3',     category:'secret',    icon:'ðŸŽ­', name:'Identity Crisis',      desc:'Change your handle 3 times',                check:s=>s.nameChanges>=3,                     reward:{type:'click_flat', val:5, label:'+5 Click Power'} },
            { id: 'secret_night',     category:'secret',    icon:'ðŸŒƒ', name:'Night Owl',            desc:'Play between midnight and 4 AM',            check:_=>{const h=new Date().getHours();return h>=0&&h<4;},  reward:{type:'cps_mult', val:0.15, label:'+15% Global CPS'} },
            { id: 'secret_speed',     category:'secret',    icon:'ðŸŽï¸', name:'Speed Runner',         desc:'Reach 1,000 total Chills in under 5 minutes',check:s=>(s.totalChills>=1000)&&((Date.now()-(s.sessionStart||Date.now()))<300000), reward:{type:'chills', val:5000, label:'+5,000 Chills'} },

            // â”€â”€ NFTs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'nft_first_mint',   category:'nfts',      icon:'ðŸ–¼ï¸', name:'Minted',               desc:'Claim your very first NFT from the vault',  check:s=>(s.ownedNfts||[]).length>=1,                                          reward:{type:'chills', val:50000, label:'+50,000 Chills'} },
            { id: 'nft_common_3',     category:'nfts',      icon:'ðŸƒ', name:'Common Grind',         desc:'Own 3 Common NFTs',                         check:s=>(s.ownedNfts||[]).filter(n=>n.rarity==='common').length>=3,           reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'nft_common_10',    category:'nfts',      icon:'ðŸŽ´', name:'Common Hoarder',       desc:'Own 10 Common NFTs',                        check:s=>(s.ownedNfts||[]).filter(n=>n.rarity==='common').length>=10,          reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'nft_rare_1',       category:'nfts',      icon:'ðŸ”·', name:'Rare Find',            desc:'Own your first Rare NFT',                   check:s=>(s.ownedNfts||[]).some(n=>n.rarity==='rare'),                         reward:{type:'diamonds', val:5, label:'+5 Diamonds'} },
            { id: 'nft_rare_2',       category:'nfts',      icon:'ðŸ’ ', name:'Rare Collector',       desc:'Own both Rare NFTs',                        check:s=>{const r=s.ownedNfts||[];const names=new Set(r.filter(n=>n.rarity==='rare').map(n=>n.name));return names.size>=2;}, reward:{type:'cps_mult', val:0.15, label:'+15% Global CPS'} },
            { id: 'nft_legend_1',     category:'nfts',      icon:'ðŸ‘‘', name:'Legend Status',        desc:'Own a Legend NFT',                          check:s=>(s.ownedNfts||[]).some(n=>n.rarity==='legend'),                       reward:{type:'cps_mult', val:0.25, label:'+25% Global CPS'} },
            { id: 'nft_legend_both',  category:'nfts',      icon:'ðŸŒŸ', name:'Verse Founders',       desc:'Own both Presido and Victor-vk Legend NFTs', check:s=>{const r=s.ownedNfts||[];const p=r.some(n=>n.name==='Presido Legend');const v=r.some(n=>n.name==='Victor-vk Legend');return p&&v;}, reward:{type:'cps_mult', val:0.50, label:'+50% Global CPS'} },
            { id: 'nft_vault_5',      category:'nfts',      icon:'ðŸ—„ï¸', name:'Vault Keeper',         desc:'Have 5 NFTs in your vault',                 check:s=>(s.ownedNfts||[]).length>=5,                                          reward:{type:'diamonds', val:10, label:'+10 Diamonds'} },
            { id: 'nft_vault_15',     category:'nfts',      icon:'ðŸ›ï¸', name:'Verse Museum',         desc:'Have 15 NFTs in your vault',                check:s=>(s.ownedNfts||[]).length>=15,                                         reward:{type:'cps_mult', val:0.20, label:'+20% Global CPS'} },

            // â”€â”€ ARTEFACTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'art_first',        category:'artefacts', icon:'âš—ï¸', name:'Artefact Hunter',      desc:'Purchase your first artefact',              check:s=>Object.keys(s.artefactsOwned||{}).length>=1,                          reward:{type:'chills', val:100000, label:'+100,000 Chills'} },
            { id: 'art_3',            category:'artefacts', icon:'ðŸ§ª', name:'Collector',             desc:'Own 3 artefacts',                           check:s=>Object.keys(s.artefactsOwned||{}).length>=3,                          reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'art_7',            category:'artefacts', icon:'ðŸ”¬', name:'Artefact Scholar',     desc:'Own 7 artefacts',                           check:s=>Object.keys(s.artefactsOwned||{}).length>=7,                          reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'art_12',           category:'artefacts', icon:'ðŸº', name:'Artefact Master',      desc:'Own 12 artefacts',                          check:s=>Object.keys(s.artefactsOwned||{}).length>=12,                         reward:{type:'diamonds', val:15, label:'+15 Diamonds'} },
            { id: 'art_all',          category:'artefacts', icon:"â—†", name:'Complete Collection',   desc:'Own all 20 artefacts',                      check:s=>Object.keys(s.artefactsOwned||{}).length>=20,                         reward:{type:'cps_mult', val:1.00, label:'+100% Global CPS'} },
            { id: 'art_diamond_1',    category:'artefacts', icon:'ðŸ”®', name:'Diamond Taste',        desc:'Buy your first diamond artefact',           check:s=>['art_gem','art_gauntlet','art_amulet','art_codex','art_hourglass','art_wings','art_trident','art_throne'].some(id=>(s.artefactsOwned||{})[id]), reward:{type:'click_flat', val:10, label:'+10 Click Power'} },
            { id: 'art_diamond_all',  category:'artefacts', icon:'ðŸ‘ï¸', name:'Diamond Vault',        desc:'Own all 8 diamond artefacts',               check:s=>['art_gem','art_gauntlet','art_amulet','art_codex','art_hourglass','art_wings','art_trident','art_throne'].every(id=>(s.artefactsOwned||{})[id]), reward:{type:'cps_mult', val:0.30, label:'+30% Global CPS'} },

            // â”€â”€ STAKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'stake_first',      category:'staking',   icon:'ðŸ“Š', name:'First Stake',          desc:'Place your first stake',                    check:s=>(s.stakeHistory||[]).length>=1,                                        reward:{type:'chills', val:50000, label:'+50,000 Chills'} },
            { id: 'stake_win_1',      category:'staking',   icon:'ðŸ“ˆ', name:'In the Green',         desc:'Win your first stake',                      check:s=>(s.stakeHistory||[]).some(h=>h.won),                                  reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'stake_win_5',      category:'staking',   icon:'ðŸ†', name:'Consistent Gains',     desc:'Win 5 stakes',                              check:s=>(s.stakeHistory||[]).filter(h=>h.won).length>=5,                      reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'stake_win_10',     category:'staking',   icon:'ðŸ¤‘', name:'Market Wizard',        desc:'Win 10 stakes',                             check:s=>(s.stakeHistory||[]).filter(h=>h.won).length>=10,                     reward:{type:'diamonds', val:10, label:'+10 Diamonds'} },
            { id: 'stake_big',        category:'staking',   icon:'ðŸ’°', name:'High Roller',          desc:'Stake at least 1 Million Chills at once',   check:s=>(s.stakeHistory||[]).some(h=>h.amount>=1e6),                          reward:{type:'cps_mult', val:0.15, label:'+15% Global CPS'} },
            { id: 'stake_loss_brave', category:'staking',   icon:'ðŸ’€', name:'Reckless',             desc:'Lose 3 stakes in a row',                    check:s=>{const h=s.stakeHistory||[];if(h.length<3)return false;return !h[0].won&&!h[1].won&&!h[2].won;}, reward:{type:'diamonds', val:5, label:'+5 Diamonds (sympathy bonus)'} },

            // â”€â”€ GANG HQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'hq_landlord',      category:'hq',  icon:'ðŸ—ï¸', name:'Landlord',             desc:'Build your first HQ room tier',              check:s=>getHQTotalTiers()>=1,                                                  reward:{type:'chills', val:100000, label:'+100,000 Chills'} },
            { id: 'hq_foundation',    category:'hq',  icon:'ðŸ§±', name:'First Foundation',     desc:'Complete 3 room tiers',                      check:s=>getHQTotalTiers()>=3,                                                  reward:{type:'cps_mult', val:0.02, label:'+2% Global CPS'} },
            { id: 'hq_builder',       category:'hq',  icon:'ðŸ”¨', name:'Builder',              desc:'Complete 6 room tiers',                      check:s=>getHQTotalTiers()>=6,                                                  reward:{type:'chills', val:500000, label:'+500,000 Chills'} },
            { id: 'hq_gang',          category:'hq',  icon:'ðŸ ', name:'Gang HQ',              desc:'Complete 10 room tiers',                     check:s=>getHQTotalTiers()>=10,                                                 reward:{type:'diamonds', val:5, label:'+5 Diamonds'} },
            { id: 'hq_architect',     category:'hq',  icon:'ðŸ“', name:'Verse Architect',      desc:'Complete 15 room tiers',                     check:s=>getHQTotalTiers()>=15,                                                 reward:{type:'cps_mult', val:0.03, label:'+3% Global CPS'} },
            { id: 'hq_full_t1',       category:'hq',  icon:'ðŸ˜ï¸', name:'Full House',           desc:'All 10 rooms at Tier 1',                     check:s=>HQ_ROOMS.every(r=>(s.hqRooms||{})[r.id]>=1),                         reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'hq_mine_first',    category:'hq',  icon:'â›ï¸', name:'Diamond Earner',       desc:'Collect your first Diamond Mine payout',     check:s=>(s.hqMinePayoutCount||0)>=1,                                          reward:{type:'diamonds', val:5, label:'+5 Diamonds'} },
            { id: 'hq_mine_5',        category:'hq',  icon:"â—†", name:'Hourly Grind',         desc:'Collect 5 Diamond Mine payouts',             check:s=>(s.hqMinePayoutCount||0)>=5,                                          reward:{type:'cps_mult', val:0.03, label:'+3% Global CPS'} },
            { id: 'hq_mine_20',       category:'hq',  icon:'ðŸ‘‘', name:'Diamond Baron',        desc:'Collect 20 Diamond Mine payouts',            check:s=>(s.hqMinePayoutCount||0)>=20,                                         reward:{type:'diamonds', val:10, label:'+10 Diamonds'} },
            { id: 'hq_mine_t3',       category:'hq',  icon:'ðŸŒ‹', name:'Mine Lord',            desc:'Upgrade Diamond Mine to Tier 3',             check:s=>(s.hqRooms||{})['mine']>=3,                                           reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'hq_spend_1b',      category:'hq',  icon:'ðŸ’¸', name:'Chill Investor',       desc:'Spend 1 Billion Chills on HQ',               check:s=>(s.hqChillsSpent||0)>=1e9,                                            reward:{type:'cps_mult', val:0.03, label:'+3% Global CPS'} },
            { id: 'hq_spend_10b',     category:'hq',  icon:'ðŸ¤‘', name:'Verse Tycoon',         desc:'Spend 10 Billion Chills on HQ',              check:s=>(s.hqChillsSpent||0)>=10e9,                                           reward:{type:'diamonds', val:5, label:'+5 Diamonds'} },
            { id: 'hq_dia_spend_500', category:'hq',  icon:'ðŸ’ ', name:'Diamond Spender',      desc:'Spend 500 Diamonds on HQ',                   check:s=>(s.hqDiamondsSpent||0)>=500,                                          reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'hq_half_legend',   category:'hq',  icon:'ðŸŒŸ', name:'Half Legendary',       desc:'Get 5 Tier 3 rooms',                         check:s=>HQ_ROOMS.filter(r=>(s.hqRooms||{})[r.id]>=3).length>=5,             reward:{type:'cps_mult', val:0.05, label:'+5% Global CPS'} },
            { id: 'hq_25_tiers',      category:'hq',  icon:'ðŸ¯', name:'Almost There',         desc:'Complete 25 room tiers',                     check:s=>getHQTotalTiers()>=25,                                                reward:{type:'diamonds', val:10, label:'+10 Diamonds'} },
            { id: 'hq_full_t2',       category:'hq',  icon:'ðŸ›ï¸', name:'Verse Fortress',       desc:'All 10 rooms at Tier 2',                     check:s=>HQ_ROOMS.every(r=>(s.hqRooms||{})[r.id]>=2),                        reward:{type:'cps_mult', val:0.08, bonusDiamonds:10, label:'+8% CPS + 10 â—†'} },
            { id: 'hq_spend_1t',      category:'hq',  icon:'ðŸŒŒ', name:'Neon Empire',          desc:'Spend 1 Trillion Chills on HQ',              check:s=>(s.hqChillsSpent||0)>=1e12,                                           reward:{type:'cps_mult', val:0.10, label:'+10% Global CPS'} },
            { id: 'hq_dia_spend_2k',  category:'hq',  icon:'ðŸ”®', name:'Diamond Legend',       desc:'Spend 2,000 Diamonds on HQ',                 check:s=>(s.hqDiamondsSpent||0)>=2000,                                         reward:{type:'diamonds', val:15, label:'+15 Diamonds'} },
            { id: 'hq_full_t3',       category:'hq',  icon:'ðŸ†', name:'Full Legendary',       desc:'All 10 rooms at Tier 3',                     check:s=>HQ_ROOMS.every(r=>(s.hqRooms||{})[r.id]>=3),                        reward:{type:'cps_mult', val:0.15, bonusDiamonds:20, label:'+15% CPS + 20 â—†'} },
            { id: 'hq_throne',        category:'hq',  icon:'ðŸ‘‘', name:'THE VERSE THRONE',     desc:'All 30 tiers built and 5T Chills spent on HQ',check:s=>getHQTotalTiers()>=30&&(s.hqChillsSpent||0)>=5e12,                  reward:{type:'cps_mult', val:0.25, bonusDiamonds:30, label:'+25% CPS + 30 â—†'} },
        ];

        const CATEGORY_COLORS = {
            clicking:   'neon-cyan',
            chills:     'neon-cyan',
            producers:  'neon-purple',
            cps:        'neon-cyan',
            diamonds:   'neon-gold',
            web3:       'neon-green',
            time:       'neon-purple',
            milestones: 'neon-magenta',
            secret:     'yellow-400',
            nfts:       'neon-purple',
            artefacts:  'neon-cyan',
            staking:    'neon-green',
            hq:         'yellow-400',
        };

        const CATEGORY_LABELS = {
            clicking:'CLICKING', chills:'CHILLS', producers:'PRODUCERS', cps:'PRODUCTION',
            diamonds:'DIAMONDS', web3:'WEB3', time:'TIME & OFFLINE', milestones:'MILESTONES',
            secret:'SECRET', nfts:'NFTs', artefacts:'ARTEFACTS', staking:'STAKING', hq:'GANG HQ',
        };

        // Apply a reward immediately when an achievement is unlocked
        function applyReward(reward) {
            if (!reward) return;
            switch(reward.type) {
                case 'chills':
                    gameState.chills += reward.val;
                    gameState.totalChills += reward.val;
                    break;
                case 'diamonds':
                    gameState.diamonds += reward.val;
                    gameState.totalDiamonds = (gameState.totalDiamonds||0) + reward.val;
                    break;
                case 'click_flat':
                    gameState.achievementClickBonus = (gameState.achievementClickBonus||0) + reward.val;
                    break;
                case 'click_mult':
                    gameState.achievementClickMult = (gameState.achievementClickMult||1) * (1 + reward.val);
                    break;
                case 'cps_mult':
                    gameState.achievementCpsMult = (gameState.achievementCpsMult||1) * (1 + reward.val);
                    // Some HQ achievements also give bonus diamonds via reward.bonusDiamonds
                    if (reward.bonusDiamonds) {
                        gameState.diamonds += reward.bonusDiamonds;
                        gameState.totalDiamonds = (gameState.totalDiamonds||0) + reward.bonusDiamonds;
                    }
                    break;
                case 'producer_mult':
                    if (!gameState.producerMults) gameState.producerMults = {};
                    const key = 'p' + reward.prodIdx;
                    gameState.producerMults[key] = (gameState.producerMults[key]||1) * (1 + reward.val);
                    break;
            }
        }

        function updateAchievements() {
            const newlyUnlocked = [];
            ACHIEVEMENTS.forEach(a => {
                if (!gameState.achievements[a.id] && a.check(gameState)) {
                    gameState.achievements[a.id] = Date.now();
                    applyReward(a.reward);
                    newlyUnlocked.push(a);
                }
            });
            newlyUnlocked.forEach((a, i) => {
                setTimeout(() => showAchievementToast(a), i * 1800);
            });
            if (newlyUnlocked.length) saveGame();
            renderAchievements();
        }

        function renderAchievements() {
            const container = document.getElementById('achievementGrid');
            if (!container) return;
            const unlocked = Object.keys(gameState.achievements).length;
            document.getElementById('achievementProgress').textContent = `${unlocked} / ${ACHIEVEMENTS.length} Unlocked`;

            const categories = {};
            ACHIEVEMENTS.forEach(a => {
                if (!categories[a.category]) categories[a.category] = [];
                categories[a.category].push(a);
            });

            container.innerHTML = Object.entries(categories).map(([cat, list]) => {
                const color = CATEGORY_COLORS[cat] || 'neon-cyan';
                const items = list.map(a => {
                    const done = !!gameState.achievements[a.id];
                    const rewardBadge = a.reward && done
                        ? `<span class="inline-block mt-1 text-xs px-2 py-0.5 rounded-full bg-neon-green/20 text-neon-green border border-neon-green/30">${a.reward.label}</span>`
                        : (a.reward ? `<span class="inline-block mt-1 text-xs px-2 py-0.5 rounded-full bg-white/5 text-white/20 border border-white/10">??? reward</span>` : '');
                    return `
                    <div class="flex items-start gap-3 p-3 rounded-xl ${done ? 'bg-white/5' : 'bg-black/20 achievement-card-locked'} transition-all">
                        <div class="w-11 h-11 rounded-full flex items-center justify-center text-xl flex-shrink-0 mt-0.5 ${done ? `bg-${color}/20 border border-${color}/40` : 'bg-white/5 border border-white/10'}">
                            ${done ? a.icon : 'ðŸ”’'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-orbitron text-sm font-bold ${done ? `text-${color}` : 'text-white/30'} truncate">${done ? a.name : '???'}</p>
                            <p class="text-xs ${done ? 'text-white/60' : 'text-white/20'} mt-0.5">${done ? a.desc : 'Keep playing to unlock'}</p>
                            <div>${rewardBadge}</div>
                            ${done ? `<p class="text-xs text-white/20 mt-1">${new Date(gameState.achievements[a.id]).toLocaleDateString()}</p>` : ''}
                        </div>
                        ${done ? `<div class="text-neon-green flex-shrink-0 mt-0.5"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></div>` : ''}
                    </div>`;
                }).join('');

                const doneCount = list.filter(a => !!gameState.achievements[a.id]).length;
                return `
                <div class="mb-5">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h3 class="font-orbitron text-xs text-white/40 tracking-widest">${CATEGORY_LABELS[cat]||cat.toUpperCase()}</h3>
                        <span class="text-xs text-white/30">${doneCount}/${list.length}</span>
                    </div>
                    <div class="glass rounded-2xl p-3 space-y-2">${items}</div>
                </div>`;
            }).join('');
        }

        function showAchievementToast(achievement) {
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            const rewardLine = achievement.reward
                ? `<p class="text-xs text-neon-green mt-0.5">ðŸŽ ${achievement.reward.label}</p>`
                : '';
            toast.innerHTML = `
                <div class="glass-strong rounded-2xl p-4 border border-neon-cyan/40 flex items-center gap-3" style="box-shadow: 0 0 20px rgba(0,243,255,0.3)">
                    <div class="w-12 h-12 rounded-full bg-neon-cyan/20 border border-neon-cyan/50 flex items-center justify-center text-2xl flex-shrink-0">${achievement.icon}</div>
                    <div>
                        <p class="text-xs text-neon-cyan font-orbitron tracking-widest mb-0.5">ACHIEVEMENT UNLOCKED</p>
                        <p class="font-orbitron font-bold text-white">${achievement.name}</p>
                        <p class="text-xs text-white/60">${achievement.desc}</p>
                        ${rewardLine}
                    </div>
                </div>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-out');
                setTimeout(() => toast.remove(), 400);
            }, 3500);
        }


        // ==================== GAME DATA ====================
        const producers = [
            { id: 'pod', name: 'Neon Pod', baseCost: 180, baseProduction: 0.1, owned: 0 },
            { id: 'flicker', name: 'Holo Flicker', baseCost: 1200, baseProduction: 0.5, owned: 0 },
            { id: 'drone', name: 'Quantum Drone', baseCost: 6000, baseProduction: 2, owned: 0 },
            { id: 'amplifier', name: 'Verse Amplifier', baseCost: 30000, baseProduction: 8, owned: 0 },
            { id: 'nexus', name: 'Chill Nexus', baseCost: 144000, baseProduction: 50, owned: 0 },
            { id: 'singularity', name: 'Neon Singularity', baseCost: 900000, baseProduction: 100, owned: 0 },
            { id: 'diamond', name: 'Diamond Core', baseCost: 4800000, baseProduction: 500, owned: 0 },
            { id: 'eternal', name: 'Eternal Verse', baseCost: 30000000, baseProduction: 1000, owned: 0 },
        ];
        
        const diamondUpgrades = [
            { id: 'globalMult', name: 'Global Multiplier', description: '+10% to all production', baseCost: 20, level: 0, multiplier: 0.1 },
            { id: 'clickMult', name: 'Click Power', description: '+1 base click power', baseCost: 30, level: 0, multiplier: 1 },
            { id: 'startBonus', name: 'Starting Bonus', description: 'Start with +100 Chills after ascend', baseCost: 40, level: 0, multiplier: 100 },
            { id: 'diamondBoost', name: 'Diamond Boost', description: '+10% Diamonds from ascend', baseCost: 60, level: 0, multiplier: 0.1 },
        ];
        
        // ==================== GAME STATE ====================
        let gameState = {
            username: '',
            email: '',
            chills: 0,
            totalChills: 0,
            diamonds: 0,
            clickPower: 1,
            producers: JSON.parse(JSON.stringify(producers)),
            diamondUpgrades: JSON.parse(JSON.stringify(diamondUpgrades)),
            walletConnected: false,
            settings: {
                offlineProgress: true,
                particles: true,
                music: true,
            },
            lastSave: null,
            nftCount: 0,
            achievements: {},
            totalClicks: 0,
            totalAscensions: 0,
            nameChanges: 0,
            totalSpent: 0,
            totalDiamonds: 0,
            totalOfflineChills: 0,
            achievementCpsMult: 1,
            achievementClickMult: 1,
            achievementClickBonus: 0,
            producerMults: {},
            sessionStart: Date.now(),
            ownedNfts: [],
            mintStartTime: null,
            artefactsOwned: {},
            stakeActive: null,
            stakeHistory: [],
            dStakeActive: null,
            dStakeHistory: [],
            resetBonusGiven: false,
            hqRooms: {},
            hqChillsSpent: 0,
            hqDiamondsSpent: 0,
            hqMineLastPayout: null,
            hqMinePayoutCount: 0,
            hqBuildTimers: {},
            hqActiveTimes: {},
            convDay: '',
            convDiaUsed: 0,
            convChillUsed: 0,
        };
        
        // ==================== UTILITY FUNCTIONS ====================
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            if (!isFinite(num)) return 'âˆž';
            if (num < 10000) return Math.floor(num).toLocaleString();
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'];
            const suffixIndex = Math.floor(Math.log10(num) / 3);
            if (suffixIndex >= suffixes.length) return num.toExponential(2);
            const scaled = num / Math.pow(1000, suffixIndex);
            return scaled.toFixed(scaled >= 100 ? 0 : 1) + suffixes[suffixIndex];
        }
        
        function getCost(baseCost, owned) {
            return Math.floor(baseCost * Math.pow(1.15, owned));
        }
        
        function getCPS() {
            let cps = 0;
            const globalMult = 1 + (gameState.diamondUpgrades.find(u => u.id === 'globalMult')?.level || 0) * 0.1;
            const walletBonus = gameState.walletConnected ? 1.25 : 1;
            const achMult = gameState.achievementCpsMult || 1;
            const producerMults = gameState.producerMults || {};
            
            gameState.producers.forEach((p, i) => {
                const pMult = producerMults['p' + i] || 1;
                cps += p.owned * p.baseProduction * pMult;
            });
            
            return cps * globalMult * walletBonus * achMult * getHQCpsMult();
        }
        
        function getClickPower() {
            const clickBonus = gameState.diamondUpgrades.find(u => u.id === 'clickMult')?.level || 0;
            const achFlat = gameState.achievementClickBonus || 0;
            const achMult = gameState.achievementClickMult || 1;
            return (gameState.clickPower + clickBonus + achFlat) * achMult * getHQClickMult();
        }
        
        function calculateAscendDiamonds() {
            if (gameState.totalChills < 10000) return 0;
            const diamondBoost = 1 + (gameState.diamondUpgrades.find(u => u.id === 'diamondBoost')?.level || 0) * 0.1;
            // HQ Verse Vault diamond_pct bonus
            let hqDiaPct = 1;
            HQ_ROOMS.forEach(room => {
                const tier = gameState.hqRooms[room.id] || 0;
                for (let t = 0; t < tier; t++) {
                    if (room.tiers[t].type === 'diamond_pct') hqDiaPct += room.tiers[t].val;
                }
            });
            return Math.floor(Math.log10(gameState.totalChills / 10000) * 10 * diamondBoost * hqDiaPct);
        }
        
        // ==================== PARTICLE SYSTEM ====================
        function createParticle(x, y) {
            if (!gameState.settings.particles) return;
            
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.background = Math.random() > 0.5 ? '#00f3ff' : '#ffd700';
            
            const angle = Math.random() * Math.PI * 2;
            const distance = 50 + Math.random() * 100;
            particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
            particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
            
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 800);
        }
        
        function createFloatingChill(x, y, amount) {
            if (!gameState.settings.particles) return;
            
            const el = document.createElement('div');
            el.className = 'floating-chill';
            el.textContent = '+' + formatNumber(amount);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
        
        // ==================== UI UPDATES ====================
        function updateUI() {
            document.getElementById('chillCount').textContent = formatNumber(gameState.chills);
            document.getElementById('cpsDisplay').textContent = formatNumber(getCPS());
            document.getElementById('diamondCount').textContent = formatNumber(gameState.diamonds);
            document.getElementById('diamondCountBig').textContent = formatNumber(gameState.diamonds);
            document.getElementById('clickPowerDisplay').textContent = formatNumber(getClickPower());
            document.getElementById('displayUsername').textContent = gameState.username || 'Chiller';
            document.getElementById('ascendDiamonds').textContent = formatNumber(calculateAscendDiamonds());
            document.getElementById('modalDiamonds').textContent = formatNumber(calculateAscendDiamonds());
            document.getElementById('savedEmail').textContent = gameState.email || 'Not set';
            document.getElementById('lastSaved').textContent = gameState.lastSave ? new Date(gameState.lastSave).toLocaleTimeString() : 'Never';
            
            updateOwnedProducersList();
            updateShop();
            updateDiamondShop();
            updateAchievements();
            renderArtefactsShop();
            // Web3 stats
            const w3nft = document.getElementById('web3NftCount');
            const w3art = document.getElementById('web3ArtefactCount');
            const w3wal = document.getElementById('web3WalletStatus');
            if (w3nft) w3nft.textContent = gameState.nftCount || 0;
            if (w3art) w3art.textContent = Object.keys(gameState.artefactsOwned || {}).length;
            if (w3wal) { w3wal.textContent = gameState.walletConnected ? 'Connected âœ“' : 'Disconnected'; w3wal.className = gameState.walletConnected ? 'text-neon-green font-bold' : 'text-white/40 font-bold'; }
        }
        
        function updateOwnedProducersList() {
            const container = document.getElementById('ownedProducersList');
            const owned = gameState.producers.filter(p => p.owned > 0);
            
            if (owned.length === 0) {
                container.innerHTML = '<p class="text-white/40 text-center py-4">No producers yet. Visit the Production Shop!</p>';
                return;
            }
            
            container.innerHTML = owned.map((p, i) => {
                const idx = gameState.producers.indexOf(p);
                const pMult = (gameState.producerMults || {})['p' + idx] || 1;
                const globalMult = 1 + (gameState.diamondUpgrades.find(u => u.id === 'globalMult')?.level || 0) * 0.1;
                const walletBonus = gameState.walletConnected ? 1.25 : 1;
                const achMult = gameState.achievementCpsMult || 1;
                const hqMult = getHQCpsMult();
                const actualCps = p.owned * p.baseProduction * pMult * globalMult * walletBonus * achMult * hqMult;
                return `
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                    <div>
                        <p class="font-bold text-white">${p.name}</p>
                        <p class="text-xs text-white/50">${p.owned} owned</p>
                    </div>
                    <div class="text-right">
                        <p class="text-neon-cyan font-bold">+${formatNumber(actualCps)}/s</p>
                    </div>
                </div>`;
            }).join('');
        }
        
        function updateShop() {
            const container = document.getElementById('shopGrid');
            
            container.innerHTML = gameState.producers.map((p, index) => {
                const cost = getCost(p.baseCost, p.owned);
                const canAfford = gameState.chills >= cost;
                const cost10 = Array(10).fill(0).reduce((sum, _, i) => sum + getCost(p.baseCost, p.owned + i), 0);
                const cost100 = Array(100).fill(0).reduce((sum, _, i) => sum + getCost(p.baseCost, p.owned + i), 0);
                const canAfford10 = gameState.chills >= cost10;
                const canAfford100 = gameState.chills >= cost100;
                
                return `
                    <div class="producer-card glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-orbitron font-bold text-white">${p.name}</h4>
                                <p class="text-xs text-white/50">+${p.baseProduction} Chills/s each</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-orbitron font-bold ${canAfford ? 'text-neon-cyan' : 'text-white/30'}">${p.owned}</p>
                                <p class="text-xs text-white/40">owned</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="buyProducer(${index}, 1)" 
                                class="flex-1 py-2 rounded-lg font-bold text-sm transition-all ${canAfford ? 'bg-neon-cyan/20 border border-neon-cyan/50 text-neon-cyan hover:bg-neon-cyan/30' : 'bg-white/5 border border-white/10 text-white/30 cursor-not-allowed'}">
                                Buy 1<br><span class="text-xs">${formatNumber(cost)}</span>
                            </button>
                            <button onclick="buyProducer(${index}, 10)" 
                                class="flex-1 py-2 rounded-lg font-bold text-sm transition-all ${canAfford10 ? 'bg-neon-purple/20 border border-neon-purple/50 text-neon-purple hover:bg-neon-purple/30' : 'bg-white/5 border border-white/10 text-white/30 cursor-not-allowed'}">
                                Buy 10<br><span class="text-xs">${formatNumber(cost10)}</span>
                            </button>
                            <button onclick="buyProducer(${index}, 100)" 
                                class="flex-1 py-2 rounded-lg font-bold text-sm transition-all ${canAfford100 ? 'bg-yellow-400/10 border border-yellow-400/30 neon-text-gold hover:bg-yellow-400/10' : 'bg-white/5 border border-white/10 text-white/30 cursor-not-allowed'}">
                                Buy 100<br><span class="text-xs">${formatNumber(cost100)}</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateDiamondShop() {
            const container = document.getElementById('diamondShop');
            
            container.innerHTML = gameState.diamondUpgrades.map((u, index) => {
                const cost = u.baseCost + u.level;
                const canAfford = gameState.diamonds >= cost;
                
                return `
                    <div class="producer-card glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-orbitron font-bold text-white">${u.name}</h4>
                                <p class="text-xs text-white/50">${u.description}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-orbitron font-bold neon-text-gold">Lv.${u.level}</p>
                            </div>
                        </div>
                        <button onclick="buyDiamondUpgrade(${index})" 
                            class="w-full py-2 rounded-lg font-bold text-sm transition-all ${canAfford ? '' : 'bg-white/5 border border-white/10 text-white/30 cursor-not-allowed'}"
                            style="${canAfford ? 'background:rgba(255,215,0,0.15);border:1px solid rgba(255,215,0,0.5);color:#ffd700;' : ''}">
                            Upgrade â€¢ ${formatNumber(cost)} Diamonds
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== GAME ACTIONS ====================
        function buyProducer(index, amount) {
            const p = gameState.producers[index];
            let totalCost = 0;
            
            for (let i = 0; i < amount; i++) {
                totalCost += getCost(p.baseCost, p.owned + i);
            }
            
            if (gameState.chills >= totalCost) {
                gameState.chills -= totalCost;
                gameState.totalSpent = (gameState.totalSpent||0) + totalCost;
                p.owned += amount;
                saveGame();
                updateUI();
            }
        }
        
        function buyDiamondUpgrade(index) {
            const u = gameState.diamondUpgrades[index];
            const cost = u.baseCost + u.level;
            
            if (gameState.diamonds >= cost) {
                gameState.diamonds -= cost;
                u.level++;
                saveGame();
                updateUI();
            }
        }
        
        function clickChillCore(e) {
            e.preventDefault();
            e.stopPropagation();

            const power = getClickPower();
            gameState.chills += power;
            gameState.totalChills += power;
            gameState.totalClicks = (gameState.totalClicks || 0) + 1;

            // Instant counter update only â€” skip expensive shop/achievement re-renders
            document.getElementById('chillCount').textContent = formatNumber(gameState.chills);
            document.getElementById('cpsDisplay').textContent = formatNumber(getCPS());
            document.getElementById('clickPowerDisplay').textContent = formatNumber(getClickPower());

            // Particle + float text
            const btn = document.getElementById('chillCore');
            const rect = btn.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const tx = e.changedTouches ? e.changedTouches[0].clientX : (e.clientX || cx);
            const ty = e.changedTouches ? e.changedTouches[0].clientY : (e.clientY || cy);

            for (let i = 0; i < 6; i++) {
                setTimeout(() => createParticle(cx, cy), i * 20);
            }
            createFloatingChill(tx, ty, power);
        }
        
        function ascend() {
            const diamonds = calculateAscendDiamonds();
            if (diamonds <= 0) return;
            
            gameState.diamonds += diamonds;
            gameState.totalDiamonds = (gameState.totalDiamonds||0) + diamonds;
            gameState.totalAscensions = (gameState.totalAscensions || 0) + 1;
            gameState.chills = gameState.diamondUpgrades.find(u => u.id === 'startBonus')?.level * 100 || 0;
            gameState.totalChills = gameState.chills; // starts fresh; startBonus chills count toward new total
            gameState.clickPower = 1;
            gameState.producers = JSON.parse(JSON.stringify(producers));
            gameState.walletConnected = false;
            
            saveGame();
            updateUI();
            updateWalletUI();
            
            document.getElementById('ascendModal').classList.add('hidden');
        }
        
        function resetGame() {
            // Give 20 diamonds one-time bonus on this update if not already given
            const bonusKey = 'idleVerseV11ResetBonus';
            localStorage.removeItem('idleVerseSave');
            localStorage.removeItem(bonusKey); // clear so next load awards it
            // Reset state fully in-memory
            gameState = {
                username: '', email: '', chills: 0, totalChills: 0, diamonds: 20,
                totalDiamonds: 20, clickPower: 1, producers: JSON.parse(JSON.stringify(producers)),
                diamondUpgrades: JSON.parse(JSON.stringify(diamondUpgrades)),
                walletConnected: false, settings: { offlineProgress: true, particles: true, music: gameState.settings?.music ?? true },
                lastSave: null, nftCount: 0, ownedNfts: [], mintStartTime: null,
                achievements: {}, totalClicks: 0, totalAscensions: 0, nameChanges: 0,
                totalSpent: 0, totalOfflineChills: 0, achievementCpsMult: 1,
                achievementClickMult: 1, achievementClickBonus: 0, producerMults: {},
                sessionStart: Date.now(), stakeActive: null, stakeHistory: [],
                dStakeActive: null, dStakeHistory: [],
                artefactsOwned: {}, resetBonusGiven: true,
                hqRooms: {}, hqChillsSpent: 0, hqDiamondsSpent: 0,
                hqMineLastPayout: null, hqMinePayoutCount: 0,
                hqBuildTimers: {}, hqActiveTimes: {},
                _settlingStake: false, _settlingDStake: false,
            };
            saveGame();
            // Show reset modal hidden first
            document.getElementById('resetModal').classList.add('hidden');
            // Show a brief confirmation then refresh UI
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('mainGame').classList.add('hidden');
            // Keep music state
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainGame').classList.remove('hidden');
                updateUI();
                updateWalletUI();
                renderNFTCollection();
                renderArtefactsVault();
                renderArtefactsShop();
                renderStakeHistory();
                renderDiamondStakeHistory();
                renderHQRooms();
                updateHQBonusSummary();
                updateDiamondStakeUI();
                updateStakeUI();
            }, 500);
        }
        
        // ==================== WALLET ====================
        function updateWalletUI() {
            if (gameState.walletConnected) {
                document.getElementById('walletDisconnected').classList.add('hidden');
                document.getElementById('walletConnected').classList.remove('hidden');
                document.getElementById('walletAddress').textContent = '0x7a9f...3k9d';
            } else {
                document.getElementById('walletDisconnected').classList.remove('hidden');
                document.getElementById('walletConnected').classList.add('hidden');
            }
        }
        
        function connectWallet() {
            gameState.walletConnected = true;
            saveGame();
            updateWalletUI();
        }
        
        // ==================== NFT SYSTEM ====================
        const NFT_IMAGES = [
            { file: 'NFTs/1.jpg',   name: 'Chill Common #1',    rarity: 'common' },
            { file: 'NFTs/2.jpg',   name: 'Chill Common #2',    rarity: 'common' },
            { file: 'NFTs/3.jpg',   name: 'Chill Common #3',    rarity: 'common' },
            { file: 'NFTs/4.jpg',   name: 'Chill Common #4',    rarity: 'common' },
            { file: 'NFTs/5.jpg',   name: 'Chill Common #5',    rarity: 'common' },
            { file: 'NFTs/6.jpg',   name: 'Chill Common #6',    rarity: 'common' },
            { file: 'NFTs/7.jpg',   name: 'Chill Common #7',    rarity: 'common' },
            { file: 'NFTs/8.jpg',   name: 'Chill Common #8',    rarity: 'common' },
            { file: 'NFTs/9.jpg',   name: 'Chill Common #9',    rarity: 'common' },
            { file: 'NFTs/10.jpg',  name: 'Chill Common #10',   rarity: 'common' },
            { file: 'NFTs/11.jpg',  name: 'Chill Common #11',   rarity: 'common' },
            { file: 'NFTs/12.jpg',  name: 'Chill Common #12',   rarity: 'common' },
            { file: 'NFTs/13.jpg',  name: 'Chill Common #13',   rarity: 'common' },
            { file: 'NFTs/14.jpg',  name: 'Epic Emblem',        rarity: 'rare' },
            { file: 'NFTs/15.jpg',  name: 'Rare Emblem',        rarity: 'rare' },
            { file: 'NFTs/16.jpg',  name: 'Presido Legend',     rarity: 'legend' },
            { file: 'NFTs/17.jpg',  name: 'Victor-vk Legend',   rarity: 'legend' },
        ];
        const MINT_DURATION = 5.5 * 60 * 60 * 1000; // 5h 30m in ms
        const RARITY_WEIGHTS = { common: 70, rare: 20, legend: 10 }; // %

        function pickRandomNFT() {
            const roll = Math.random() * 100;
            let pool;
            if (roll < RARITY_WEIGHTS.legend) pool = NFT_IMAGES.filter(n => n.rarity === 'legend');
            else if (roll < RARITY_WEIGHTS.legend + RARITY_WEIGHTS.rare) pool = NFT_IMAGES.filter(n => n.rarity === 'rare');
            else pool = NFT_IMAGES.filter(n => n.rarity === 'common');
            return pool[Math.floor(Math.random() * pool.length)];
        }

        function startMint() {
            if (gameState.mintStartTime) return;
            if (gameState.diamonds < 50) { alert('Need 50 Diamonds to mint!'); return; }
            if (gameState.chills < 100000) { alert('Need 100,000 Chills to mint!'); return; }
            gameState.diamonds -= 50;
            gameState.chills -= 100000;
            gameState.mintStartTime = Date.now();
            saveGame();
            updateUI();
            updateMintUI();
        }

        function cancelMint() {
            if (!gameState.mintStartTime) return;
            // Refund the minting cost
            gameState.diamonds += 50;
            gameState.chills += 100000;
            gameState.mintStartTime = null;
            saveGame();
            updateUI();
            updateMintUI();
        }

        function claimNFT() {
            const nft = pickRandomNFT();
            if (!gameState.ownedNfts) gameState.ownedNfts = [];
            gameState.ownedNfts.push({ ...nft, mintedAt: Date.now(), id: Date.now() });
            gameState.nftCount = (gameState.nftCount || 0) + 1;
            gameState.mintStartTime = null;
            saveGame();
            updateUI();
            updateMintUI();
            renderNFTCollection();
            // Show claim toast
            showNFTClaimToast(nft);
        }

        function showNFTClaimToast(nft) {
            const rarityColor = nft.rarity === 'legend' ? '#ffcc00' : nft.rarity === 'rare' ? '#ffd700' : '#00f3ff';
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `
                <div class="glass-strong rounded-2xl p-4 border flex items-center gap-3" style="border-color:${rarityColor}40;box-shadow:0 0 20px ${rarityColor}33">
                    <img src="${nft.file}" class="w-12 h-12 rounded-xl object-cover flex-shrink-0" onerror="this.style.display='none'">
                    <div>
                        <p class="text-xs font-orbitron tracking-widest mb-0.5" style="color:${rarityColor}">NFT CLAIMED â€¢ ${nft.rarity.toUpperCase()}</p>
                        <p class="font-orbitron font-bold text-white">${nft.name}</p>
                    </div>
                </div>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 4000);
        }

        function updateMintUI() {
            const idle = document.getElementById('nftMintIdle');
            const active = document.getElementById('nftMintActive');
            const ready = document.getElementById('nftMintReady');
            if (!idle) return;
            if (!gameState.mintStartTime) {
                idle.classList.remove('hidden'); active.classList.add('hidden'); ready.classList.add('hidden');
            } else {
                const elapsed = Date.now() - gameState.mintStartTime;
                const pct = Math.min(100, (elapsed / MINT_DURATION) * 100);
                if (elapsed >= MINT_DURATION) {
                    idle.classList.add('hidden'); active.classList.add('hidden'); ready.classList.remove('hidden');
                } else {
                    idle.classList.add('hidden'); active.classList.remove('hidden'); ready.classList.add('hidden');
                    const remaining = MINT_DURATION - elapsed;
                    const h = Math.floor(remaining / 3600000);
                    const m = Math.floor((remaining % 3600000) / 60000);
                    const s = Math.floor((remaining % 60000) / 1000);
                    document.getElementById('mintProgressBar').style.width = pct + '%';
                    document.getElementById('mintTimeLeft').textContent = `${h}h ${m}m ${s}s remaining`;
                }
            }
        }

        function renderNFTCollection() {
            const container = document.getElementById('nftCollection');
            if (!container) return;
            const nfts = gameState.ownedNfts || [];
            if (!nfts.length) {
                container.innerHTML = '<div class="col-span-2 text-center text-white/30 py-6 text-sm">No NFTs yet. Start a mint!</div>';
                return;
            }
            const rarityBorder = { legend: 'border-yellow-400/60', rare: 'border-yellow-400/30', common: 'border-neon-cyan/30' };
            const rarityLabel = { legend: 'text-yellow-400', rare: 'neon-text-gold', common: 'text-neon-cyan' };
            container.innerHTML = nfts.map(nft => `
                <div class="glass rounded-xl overflow-hidden border ${rarityBorder[nft.rarity] || 'border-white/10'}">
                    <img src="${nft.file}" class="w-full h-28 object-cover" onerror="this.style.background='#111';this.style.minHeight='7rem'">
                    <div class="p-2">
                        <p class="font-orbitron text-xs font-bold text-white truncate">${nft.name}</p>
                        <p class="text-xs ${rarityLabel[nft.rarity] || 'text-white/40'} uppercase tracking-wider">${nft.rarity}</p>
                    </div>
                </div>`).join('');
        }

        // ==================== ARTEFACTS SYSTEM ====================
        const ARTEFACTS = [
            // Chill-bought (12) â€” lowest starts at 3M (+20%)
            { id: 'art_crystal',    name: 'Chill Crystal',      icon: 'ðŸ”·', cost: 36000000,    currency: 'chills',   desc: 'A frozen shard of pure chill energy' },
            { id: 'art_scroll',     name: 'Verse Scroll',       icon: 'ðŸ“œ', cost: 96000000,    currency: 'chills',   desc: 'Ancient texts of the Chill Verse' },
            { id: 'art_compass',    name: 'Neon Compass',       icon: 'ðŸ§­', cost: 240000000,   currency: 'chills',   desc: 'Points toward infinite chills' },
            { id: 'art_orb',        name: 'Plasma Orb',         icon: 'ðŸ”®', cost: 720000000,   currency: 'chills',   desc: 'A swirling ball of chill plasma' },
            { id: 'art_mask',       name: 'Chiller Mask',       icon: 'ðŸŽ­', cost: 1800000000,  currency: 'chills',   desc: 'Worn by the OG chill legends' },
            { id: 'art_sword',      name: 'Neon Blade',         icon: 'âš”ï¸', cost: 4800000000,  currency: 'chills',   desc: 'Forged in the neon forge' },
            { id: 'art_crown',      name: 'Verse Crown',        icon: 'ðŸ‘‘', cost: 12000000000, currency: 'chills',   desc: 'Only for the true Chill Lords' },
            { id: 'art_ring',       name: 'Diamond Ring',       icon: 'ðŸ’', cost: 36000000000, currency: 'chills',   desc: 'A ring encrusted with chill diamonds' },
            { id: 'art_lantern',    name: 'Star Lantern',       icon: 'ðŸ®', cost: 96000000000, currency: 'chills',   desc: 'Lights the path through the verse' },
            { id: 'art_map',        name: 'Verse Map',          icon: 'ðŸ—ºï¸', cost: 300000000000, currency:'chills',   desc: 'Maps every corner of the Idle Verse' },
            { id: 'art_banner',     name: 'Chill Banner',       icon: 'ðŸš©', cost: 900000000000, currency:'chills',   desc: 'Plant your flag in the verse' },
            { id: 'art_tome',       name: 'Ancient Tome',       icon: 'ðŸ“•', cost: 2400000000000,currency:'chills',   desc: 'The complete history of the Chill Verse' },
            // Diamond-bought (8) (+20%)
            { id: 'art_gem',        name: 'Prism Gem',          icon: "â—†", cost: 420,      currency: 'diamonds', desc: 'Refracts all light into chill frequencies' },
            { id: 'art_gauntlet',   name: 'Chill Gauntlet',     icon: 'ðŸ¥Š', cost: 720,      currency: 'diamonds', desc: 'Power of a thousand chills in one fist' },
            { id: 'art_amulet',     name: 'Verse Amulet',       icon: 'ðŸ§¿', cost: 1200,     currency: 'diamonds', desc: 'Protects against unchill forces' },
            { id: 'art_codex',      name: 'Diamond Codex',      icon: 'ðŸ“’', cost: 1800,     currency: 'diamonds', desc: 'Secrets of the diamond ascension' },
            { id: 'art_hourglass',  name: 'Neon Hourglass',     icon: 'â³', cost: 2640,     currency: 'diamonds', desc: 'Time flows differently in the verse' },
            { id: 'art_wings',      name: 'Verse Wings',        icon: 'ðŸ¦‹', cost: 4200,     currency: 'diamonds', desc: 'Ascend beyond the known verse' },
            { id: 'art_trident',    name: 'Chill Trident',      icon: 'ðŸ”±', cost: 6000,     currency: 'diamonds', desc: 'Commands the three realms of chill' },
            { id: 'art_throne',     name: 'Diamond Throne',     icon: 'ðŸ›ï¸', cost: 9600,     currency: 'diamonds', desc: 'Sit atop the entire chill empire' },
        ];

        function buyArtefact(id) {
            const art = ARTEFACTS.find(a => a.id === id);
            if (!art) return;
            if (!gameState.artefactsOwned) gameState.artefactsOwned = {};
            if (gameState.artefactsOwned[id]) { alert('You already own this artefact!'); return; }
            if (art.currency === 'chills') {
                if (gameState.chills < art.cost) { alert('Not enough Chills!'); return; }
                gameState.chills -= art.cost;
            } else {
                if (gameState.diamonds < art.cost) { alert('Not enough Diamonds!'); return; }
                gameState.diamonds -= art.cost;
            }
            gameState.artefactsOwned[id] = Date.now();
            saveGame();
            updateUI();
            renderArtefactsShop();
            renderArtefactsVault();
        }

        function renderArtefactsShop() {
            const container = document.getElementById('artefactsShopGrid');
            if (!container) return;
            if (!gameState.artefactsOwned) gameState.artefactsOwned = {};
            container.innerHTML = ARTEFACTS.map(art => {
                const owned = !!gameState.artefactsOwned[art.id];
                const isChills = art.currency === 'chills';
                const canAfford = isChills ? gameState.chills >= art.cost : gameState.diamonds >= art.cost;
                return `
                <div class="glass rounded-xl p-3 flex items-center gap-3 ${owned ? 'opacity-50' : ''}">
                    <span class="text-2xl flex-shrink-0">${art.icon}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-orbitron text-sm font-bold text-white">${art.name}</p>
                        <p class="text-xs text-white/40">${art.desc}</p>
                    </div>
                    <button onclick="buyArtefact('${art.id}')" ${owned ? 'disabled' : ''}
                        class="flex-shrink-0 px-3 py-2 rounded-lg text-xs font-orbitron font-bold transition-all ${owned ? 'bg-neon-green/20 text-neon-green border border-neon-green/30 cursor-default' : canAfford ? (isChills ? 'bg-neon-cyan/20 border border-neon-cyan/50 text-neon-cyan hover:bg-neon-cyan/30' : 'bg-yellow-400/10 border border-yellow-400/30 neon-text-gold hover:bg-yellow-400/10') : 'bg-white/5 border border-white/10 text-white/30 cursor-not-allowed'}">
                        ${owned ? 'âœ“ Owned' : formatNumber(art.cost) + (isChills ? ' C' : ' â—†')}
                    </button>
                </div>`;
            }).join('');
        }

        function renderArtefactsVault() {
            const container = document.getElementById('artefactsVault');
            if (!container) return;
            if (!gameState.artefactsOwned) gameState.artefactsOwned = {};
            const owned = ARTEFACTS.filter(a => gameState.artefactsOwned[a.id]);
            if (!owned.length) {
                container.innerHTML = '<div class="col-span-2 text-center text-white/30 py-4 text-sm">No artefacts yet. Visit the Shop!</div>';
                return;
            }
            container.innerHTML = owned.map(art => `
                <div class="glass rounded-xl p-3 text-center border border-white/10">
                    <div class="text-3xl mb-1">${art.icon}</div>
                    <p class="font-orbitron text-xs font-bold text-white">${art.name}</p>
                    <p class="text-xs text-neon-cyan capitalize">${art.currency === 'diamonds' ? 'â—† Rare' : 'âœ¨ Common'}</p>
                </div>`).join('');
        }

        // ==================== STAKING SYSTEM ====================
        const STAKE_DURATION = 60 * 60 * 1000; // 1 hour
        let stakeChartData = (gameState.stakeChartData && gameState.stakeChartData.length >= 5)
            ? gameState.stakeChartData
            : Array(30).fill(100).map((v, i) => v + Math.sin(i * 0.5) * 20 + Math.random() * 10);

        function initStakeChart() {
            const canvas = document.getElementById('stakeChart');
            if (!canvas) return;
            drawStakeChart(canvas);
        }

        function drawStakeChart(canvas) {
            const ctx = canvas.getContext('2d');
            const w = canvas.offsetWidth || 300;
            canvas.width = w;
            canvas.height = 100;
            ctx.clearRect(0, 0, w, 100);
            const max = Math.max(...stakeChartData);
            const min = Math.min(...stakeChartData);
            const range = max - min || 1;
            const pts = stakeChartData.map((v, i) => ({ x: (i / (stakeChartData.length - 1)) * w, y: 90 - ((v - min) / range) * 80 }));
            // Gradient fill
            const grad = ctx.createLinearGradient(0, 0, 0, 100);
            grad.addColorStop(0, 'rgba(0,243,255,0.3)');
            grad.addColorStop(1, 'rgba(0,243,255,0)');
            ctx.beginPath();
            ctx.moveTo(pts[0].x, pts[0].y);
            pts.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(w, 100); ctx.lineTo(0, 100); ctx.closePath();
            ctx.fillStyle = grad;
            ctx.fill();
            // Line
            ctx.beginPath();
            ctx.moveTo(pts[0].x, pts[0].y);
            pts.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.strokeStyle = '#00f3ff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function updateStakeChart() {
            const last = stakeChartData[stakeChartData.length - 1];
            const change = (Math.random() - 0.48) * 8;
            stakeChartData.push(Math.max(10, last + change));
            if (stakeChartData.length > 40) stakeChartData.shift();
            const canvas = document.getElementById('stakeChart');
            if (canvas) drawStakeChart(canvas);
            const trend = document.getElementById('stakeChartTrend');
            if (trend) {
                const up = change >= 0;
                trend.textContent = up ? 'â–² BULLISH' : 'â–¼ BEARISH';
                trend.className = 'text-xs font-bold ' + (up ? 'text-neon-green' : 'text-red-400');
            }
        }

        // ==================== DIAMOND CHART ====================
        let dStakeChartData = Array(30).fill(100).map((v, i) => v + Math.sin(i * 0.7 + 1) * 15 + Math.random() * 12);

        function initDiamondChart() {
            const canvas = document.getElementById('dStakeChart');
            if (!canvas) return;
            drawDiamondChart(canvas);
        }

        function drawDiamondChart(canvas) {
            const ctx = canvas.getContext('2d');
            const w = canvas.offsetWidth || 300;
            canvas.width = w;
            canvas.height = 100;
            ctx.clearRect(0, 0, w, 100);
            const max = Math.max(...dStakeChartData);
            const min = Math.min(...dStakeChartData);
            const range = max - min || 1;
            const pts = dStakeChartData.map((v, i) => ({
                x: (i / (dStakeChartData.length - 1)) * w,
                y: 90 - ((v - min) / range) * 80
            }));
            // Gradient fill (magenta)
            const grad = ctx.createLinearGradient(0, 0, 0, 100);
            grad.addColorStop(0, 'rgba(255,215,0,0.35)');
            grad.addColorStop(1, 'rgba(255,215,0,0)');
            ctx.beginPath();
            ctx.moveTo(pts[0].x, pts[0].y);
            pts.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(w, 100); ctx.lineTo(0, 100); ctx.closePath();
            ctx.fillStyle = grad;
            ctx.fill();
            // Line
            ctx.beginPath();
            ctx.moveTo(pts[0].x, pts[0].y);
            pts.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function updateDiamondChart() {
            const last = dStakeChartData[dStakeChartData.length - 1];
            const change = (Math.random() - 0.47) * 6;
            dStakeChartData.push(Math.max(10, last + change));
            if (dStakeChartData.length > 40) dStakeChartData.shift();
            const canvas = document.getElementById('dStakeChart');
            if (canvas) drawDiamondChart(canvas);
            const trend = document.getElementById('dStakeChartTrend');
            if (trend) {
                const up = change >= 0;
                trend.textContent = up ? 'â–² BULLISH' : 'â–¼ BEARISH';
                trend.className = 'text-xs font-bold ' + (up ? 'neon-text-gold' : 'text-red-400');
            }
        }

        function placeStake(direction) {
            if (gameState.stakeActive) { alert('A stake is already in progress!'); return; }
            const input = document.getElementById('stakeAmountInput');
            const amount = parseFloat(input?.value || 0);
            if (amount < 120) { alert('Minimum stake is 120 Chills!'); return; }
            if (gameState.chills < amount) { alert('Not enough Chills!'); return; }
            gameState.chills -= amount;
            gameState.stakeActive = { amount, direction, startTime: Date.now(), startPrice: stakeChartData[stakeChartData.length - 1] };
            // Contribute 5% to community pot
            if (window.fbContributePot) window.fbContributePot(amount, gameState.username || 'Anonymous');
            saveGame();
            updateUI();
            updateStakeUI();
        }

        function updateStakeUI() {
            const idle = document.getElementById('stakeIdlePanel');
            const active = document.getElementById('stakeActivePanel');
            if (!idle || !active) return;
            const bal = document.getElementById('stakeBalanceDisplay');
            if (bal) bal.textContent = formatNumber(gameState.chills);
            if (!gameState.stakeActive) {
                idle.classList.remove('hidden'); active.classList.add('hidden');
            } else {
                idle.classList.add('hidden'); active.classList.remove('hidden');
                const s = gameState.stakeActive;
                const elapsed = Date.now() - s.startTime;
                const pct = Math.min(100, (elapsed / STAKE_DURATION) * 100);
                const remaining = Math.max(0, STAKE_DURATION - elapsed);
                const m = Math.floor(remaining / 60000);
                const sec = Math.floor((remaining % 60000) / 1000);
                const bar = document.getElementById('stakeProgressBar');
                const time = document.getElementById('stakeTimeLeft');
                const pos = document.getElementById('stakePositionDisplay');
                const amt = document.getElementById('stakeAmountDisplay');
                if (bar) bar.style.width = pct + '%';
                if (time) time.textContent = elapsed >= STAKE_DURATION ? 'Settling...' : `${m}m ${sec}s remaining`;
                if (amt) amt.textContent = formatNumber(s.amount) + ' Chills';
                if (pos) { pos.textContent = s.direction === 'buy' ? 'â¬† BUY' : 'â¬‡ SELL'; pos.className = 'font-bold ' + (s.direction === 'buy' ? 'text-neon-green' : 'text-red-400'); }
                // Settle when done
                if (elapsed >= STAKE_DURATION) settleStake();
            }
        }

        function settleStake() {
            if (!gameState.stakeActive || gameState._settlingStake) return;
            gameState._settlingStake = true;
            const s = gameState.stakeActive;
            gameState.stakeActive = null; // null out immediately to prevent re-entry
            const endPrice = stakeChartData[stakeChartData.length - 1];
            const priceUp = endPrice >= s.startPrice;
            const won = (s.direction === 'buy' && priceUp) || (s.direction === 'sell' && !priceUp);
            const multiplier = 1.0 + Math.random() * 0.9; // 1.0x â€“ 1.9x
            const payout = won ? Math.floor(s.amount * multiplier) : 0;
            gameState.chills += payout;
            gameState.totalChills += payout;
            if (!gameState.stakeHistory) gameState.stakeHistory = [];
            gameState.stakeHistory.unshift({ amount: s.amount, direction: s.direction, won, payout, time: Date.now() });
            if (gameState.stakeHistory.length > 10) gameState.stakeHistory.pop();
            gameState._settlingStake = false;
            saveGame();
            updateUI();
            updateStakeUI();
            renderStakeHistory();
            // Toast
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `<div class="glass-strong rounded-2xl p-4 border ${won ? 'border-neon-green/40' : 'border-red-500/40'} text-center" style="box-shadow:0 0 20px ${won ? 'rgba(0,255,136,0.3)' : 'rgba(255,80,80,0.3)'}">
                <p class="font-orbitron font-bold ${won ? 'text-neon-green' : 'text-red-400'}">${won ? 'ðŸ“ˆ STAKE WON!' : 'ðŸ“‰ STAKE LOST'}</p>
                <p class="text-white/70 text-sm mt-1">${won ? '+' + formatNumber(payout) + ' Chills' : 'Better luck next time!'}</p></div>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 4000);
        }

        function renderStakeHistory() {
            const container = document.getElementById('stakeHistory');
            if (!container) return;
            const hist = gameState.stakeHistory || [];
            if (!hist.length) { container.innerHTML = '<p class="text-white/30 text-sm text-center py-2">No stakes yet</p>'; return; }
            container.innerHTML = hist.map(h => `
                <div class="flex items-center justify-between py-2 border-b border-white/5 text-xs">
                    <span class="${h.won ? 'text-neon-green' : 'text-red-400'}">${h.direction === 'buy' ? 'â¬†' : 'â¬‡'} ${h.direction.toUpperCase()}</span>
                    <span class="text-white/40">${formatNumber(h.amount)} staked</span>
                    <span class="${h.won ? 'text-neon-green font-bold' : 'text-red-400'}">${h.won ? '+' + formatNumber(h.payout) : 'Lost'}</span>
                </div>`).join('');
        }

        // ==================== DIAMOND STAKING ====================
        function placeDiamondStake(direction) {
            if (gameState.dStakeActive) { alert('A diamond stake is already active!'); return; }
            const input = document.getElementById('dStakeAmountInput');
            const amount = Math.floor(parseFloat(input?.value || 0));
            if (amount < 1) { alert('Minimum diamond stake is 1!'); return; }
            if (amount > 1000) { alert('Maximum diamond stake is 1,000 Diamonds!'); return; }
            if (gameState.diamonds < amount) { alert('Not enough Diamonds!'); return; }
            gameState.diamonds -= amount;
            gameState.dStakeActive = { amount, direction, startTime: Date.now(), startPrice: dStakeChartData[dStakeChartData.length - 1] };
            saveGame();
            updateUI();
            updateDiamondStakeUI();
        }

        function updateDiamondStakeUI() {
            const idle   = document.getElementById('dStakeIdlePanel');
            const active = document.getElementById('dStakeActivePanel');
            if (!idle || !active) return;
            const bal = document.getElementById('dStakeBalanceDisplay');
            if (bal) bal.textContent = Math.floor(gameState.diamonds);
            if (!gameState.dStakeActive) {
                idle.classList.remove('hidden');
                active.classList.add('hidden');
            } else {
                idle.classList.add('hidden');
                active.classList.remove('hidden');
                const s = gameState.dStakeActive;
                const elapsed   = Date.now() - s.startTime;
                const pct       = Math.min(100, (elapsed / STAKE_DURATION) * 100);
                const remaining = Math.max(0, STAKE_DURATION - elapsed);
                const m   = Math.floor(remaining / 60000);
                const sec = Math.floor((remaining % 60000) / 1000);
                const bar = document.getElementById('dStakeProgressBar');
                const time= document.getElementById('dStakeTimeLeft');
                const pos = document.getElementById('dStakePositionDisplay');
                const amt = document.getElementById('dStakeAmountDisplay');
                if (bar) bar.style.width = pct + '%';
                if (time) time.textContent = elapsed >= STAKE_DURATION ? 'Settling...' : `${m}m ${sec}s remaining`;
                if (amt)  amt.textContent  = s.amount + ' â—†';
                if (pos)  { pos.textContent = s.direction === 'buy' ? 'â¬† BUY' : 'â¬‡ SELL'; pos.className = 'font-bold ' + (s.direction === 'buy' ? 'text-neon-green' : 'text-red-400'); }
                if (elapsed >= STAKE_DURATION) settleDiamondStake();
            }
        }

        function settleDiamondStake() {
            if (!gameState.dStakeActive || gameState._settlingDStake) return;
            gameState._settlingDStake = true;
            const s = gameState.dStakeActive;
            gameState.dStakeActive = null; // null out immediately to prevent re-entry
            const endPrice = dStakeChartData[dStakeChartData.length - 1];
            const priceUp  = endPrice >= s.startPrice;
            const won = (s.direction === 'buy' && priceUp) || (s.direction === 'sell' && !priceUp);
            const multiplier = 1.0 + Math.random() * 0.7; // 1.0x â€“ 1.7x
            const payout = won ? Math.floor(s.amount * multiplier) : 0;
            if (won) {
                gameState.diamonds += payout;
                gameState.totalDiamonds = (gameState.totalDiamonds || 0) + payout;
            }
            if (!gameState.dStakeHistory) gameState.dStakeHistory = [];
            gameState.dStakeHistory.unshift({ amount: s.amount, direction: s.direction, won, payout, time: Date.now() });
            if (gameState.dStakeHistory.length > 10) gameState.dStakeHistory.pop();
            gameState._settlingDStake = false;
            saveGame();
            updateUI();
            updateDiamondStakeUI();
            renderDiamondStakeHistory();
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `<div class="glass-strong rounded-2xl p-4 border ${won ? 'border-yellow-400/30' : 'border-red-500/40'} text-center" style="box-shadow:0 0 20px ${won ? 'rgba(255,215,0,0.4)' : 'rgba(255,80,80,0.3)'}">
                <p class="font-orbitron font-bold ${won ? 'neon-text-gold' : 'text-red-400'}">${won ? 'â—† DIAMOND WIN!' : 'ðŸ’€ DIAMOND LOST'}</p>
                <p class="text-white/70 text-sm mt-1">${won ? '+' + payout + ' â—† returned' : 'Better luck next time!'}</p></div>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 4000);
        }

        function renderDiamondStakeHistory() {
            const container = document.getElementById('dStakeHistory');
            if (!container) return;
            const hist = gameState.dStakeHistory || [];
            if (!hist.length) { container.innerHTML = '<p class="text-white/30 text-sm text-center py-2">No diamond stakes yet</p>'; return; }
            container.innerHTML = hist.map(h => `
                <div class="flex items-center justify-between py-2 border-b border-white/5 text-xs">
                    <span class="${h.won ? 'text-neon-green' : 'text-red-400'}">${h.direction === 'buy' ? 'â¬†' : 'â¬‡'} ${h.direction.toUpperCase()}</span>
                    <span class="text-white/40">${h.amount} â—† staked</span>
                    <span class="${h.won ? 'neon-text-gold font-bold' : 'text-red-400'}">${h.won ? '+' + h.payout + ' â—†' : 'Lost'}</span>
                </div>`).join('');
        }
        
        // ==================== GANG HQ SYSTEM ====================
        const HQ_ROOMS = [
            {
                id: 'lounge', name: 'Chill Lounge', icon: 'ðŸ›‹ï¸',
                desc: 'Where it all starts. Pure chill energy flows here.',
                tiers: [
                    { cost: 10e6,   dCost: 0,   bonus: '+2% Global CPS',    type: 'cps',         val: 0.02 },
                    { cost: 30e6,   dCost: 0,   bonus: '+4% Global CPS',    type: 'cps',         val: 0.04 },
                    { cost: 90e6,   dCost: 0,   bonus: '+7% Global CPS',    type: 'cps',         val: 0.07 },
                ],
            },
            {
                id: 'lab', name: 'Neon Lab', icon: 'ðŸ§ª',
                desc: 'Science of chilling. Experiments that boost your clicks.',
                tiers: [
                    { cost: 30e6,   dCost: 0,   bonus: '+2% Click Power',   type: 'click',       val: 0.02 },
                    { cost: 100e6,  dCost: 0,   bonus: '+5% Click Power',   type: 'click',       val: 0.05 },
                    { cost: 300e6,  dCost: 0,   bonus: '+8% Click Power',   type: 'click',       val: 0.08 },
                ],
            },
            {
                id: 'studio', name: 'Beat Studio', icon: 'ðŸŽµ',
                desc: 'Music fuels the verse. Rhythm drives production.',
                tiers: [
                    { cost: 100e6, dCost: 0,   bonus: '+3% Global CPS',    type: 'cps',         val: 0.03 },
                    { cost: 300e6, dCost: 0,   bonus: '+6% Global CPS',    type: 'cps',         val: 0.06 },
                    { cost: 1e9,   dCost: 0,   bonus: '+10% Global CPS',   type: 'cps',         val: 0.10 },
                ],
            },
            {
                id: 'vault', name: 'Verse Vault', icon: 'ðŸ¦',
                desc: 'Stores the knowledge and wealth of the verse.',
                tiers: [
                    { cost: 300e6, dCost: 0,   bonus: '+2% Diamond Earn',  type: 'diamond_pct', val: 0.02 },
                    { cost: 1e9,   dCost: 0,   bonus: '+5% Diamond Earn',  type: 'diamond_pct', val: 0.05 },
                    { cost: 3e9,   dCost: 0,   bonus: '+8% Diamond Earn',  type: 'diamond_pct', val: 0.08 },
                ],
            },
            {
                id: 'warroom', name: 'War Room', icon: 'âš”ï¸',
                desc: 'Strategy hub. Every producer works harder.',
                tiers: [
                    { cost: 1e9,   dCost: 0,   bonus: '+3% All Producers', type: 'all_prod',    val: 0.03 },
                    { cost: 3e9,   dCost: 0,   bonus: '+6% All Producers', type: 'all_prod',    val: 0.06 },
                    { cost: 10e9,  dCost: 0,   bonus: '+10% All Producers',type: 'all_prod',    val: 0.10 },
                ],
            },
            {
                id: 'tower', name: 'Chill Tower', icon: 'ðŸ—¼',
                desc: 'The crown jewel of the base. Radiates chill energy.',
                tiers: [
                    { cost: 3e9,   dCost: 0,   bonus: '+4% Global CPS',    type: 'cps',         val: 0.04 },
                    { cost: 10e9,  dCost: 0,   bonus: '+8% Global CPS',    type: 'cps',         val: 0.08 },
                    { cost: 30e9,  dCost: 0,   bonus: '+12% Global CPS',   type: 'cps',         val: 0.12 },
                ],
            },
            {
                id: 'mine', name: 'Diamond Mine', icon: 'â›ï¸',
                desc: 'Generates 5 Diamonds passively over time.',
                tiers: [
                    { cost: 10e9,   dCost: 50,  bonus: '5â—† / 60 min',      type: 'mine',        val: 60 },
                    { cost: 30e9,   dCost: 150, bonus: '5â—† / 40 min',      type: 'mine',        val: 40 },
                    { cost: 100e9,  dCost: 300, bonus: '5â—† / 20 min',      type: 'mine',        val: 20 },
                ],
            },
            {
                id: 'armory', name: 'Neon Armory', icon: 'ðŸ”«',
                desc: 'Equip your clickers with neon-forged tools.',
                tiers: [
                    { cost: 30e9,   dCost: 100, bonus: '+5% Click Power',   type: 'click',       val: 0.05 },
                    { cost: 100e9,  dCost: 250, bonus: '+10% Click Power',  type: 'click',       val: 0.10 },
                    { cost: 300e9,  dCost: 500, bonus: '+15% Click Power',  type: 'click',       val: 0.15 },
                ],
            },
            {
                id: 'archive', name: 'Verse Archive', icon: 'ðŸ“š',
                desc: 'All knowledge of the Idle Verse stored here.',
                tiers: [
                    { cost: 100e9, dCost: 150, bonus: '+6% Global CPS',    type: 'cps',         val: 0.06 },
                    { cost: 300e9, dCost: 350, bonus: '+12% Global CPS',   type: 'cps',         val: 0.12 },
                    { cost: 1e12,  dCost: 700, bonus: '+20% Global CPS',   type: 'cps',         val: 0.20 },
                ],
            },
            {
                id: 'throne', name: 'Throne Room', icon: 'ðŸ‘‘',
                desc: 'You run the verse. The ultimate seat of power.',
                tiers: [
                    { cost: 300e9, dCost: 200,  bonus: '+8% Global CPS',   type: 'cps',         val: 0.08 },
                    { cost: 1e12,  dCost: 500,  bonus: '+15% Global CPS',  type: 'cps',         val: 0.15 },
                    { cost: 3e12,  dCost: 1000, bonus: '+25% Global CPS',  type: 'cps',         val: 0.25 },
                ],
            },
        ];

        const HQ_RANKS = [
            { min: 0,  label: 'Empty Lot' },
            { min: 1,  label: 'Starter Pad' },
            { min: 5,  label: 'Chill Den' },
            { min: 10, label: 'Gang HQ' },
            { min: 15, label: 'Verse Fortress' },
            { min: 20, label: 'Diamond Empire' },
            { min: 25, label: 'Chill Legion' },
            { min: 30, label: 'ðŸ‘‘ THE VERSE THRONE' },
        ];

        function getHQRank(totalTiers) {
            let rank = HQ_RANKS[0];
            for (const r of HQ_RANKS) { if (totalTiers >= r.min) rank = r; }
            return rank.label;
        }

        function getHQTotalTiers() {
            return HQ_ROOMS.reduce((sum, r) => sum + (gameState.hqRooms[r.id] || 0), 0);
        }

        // Compute all HQ CPS bonus multiplier
        function getHQCpsMult() {
            let mult = 1;
            HQ_ROOMS.forEach(room => {
                const tier = gameState.hqRooms[room.id] || 0;
                for (let t = 0; t < tier; t++) {
                    if (room.tiers[t].type === 'cps' || room.tiers[t].type === 'all_prod') {
                        mult += room.tiers[t].val;
                    }
                }
            });
            return mult;
        }

        // Compute all HQ click bonus multiplier
        function getHQClickMult() {
            let mult = 1;
            HQ_ROOMS.forEach(room => {
                const tier = gameState.hqRooms[room.id] || 0;
                for (let t = 0; t < tier; t++) {
                    if (room.tiers[t].type === 'click') mult += room.tiers[t].val;
                }
            });
            return mult;
        }

        // Mine interval in minutes based on current tier
        function getMineInterval() {
            const mineTier = gameState.hqRooms['mine'] || 0;
            if (!mineTier) return null;
            return HQ_ROOMS.find(r => r.id === 'mine').tiers[mineTier - 1].val; // minutes
        }

        const HQ_BUILD_MS  = 5 * 60 * 60 * 1000;
        const HQ_RESIDE_MS = 5 * 60 * 60 * 1000;

        function buyHQRoom(roomId) {
            const room = HQ_ROOMS.find(r => r.id === roomId);
            if (!room) return;
            const currentTier = gameState.hqRooms[roomId] || 0;
            if (currentTier >= 3) { showHQAlert('Room already maxed!'); return; }
            if (gameState.hqBuildTimers[roomId]) { showHQAlert('Already under construction!'); return; }
            if (currentTier > 0) {
                const act = gameState.hqActiveTimes[roomId];
                if (!act || (Date.now() - act) < HQ_RESIDE_MS) {
                    const rem = HQ_RESIDE_MS - (Date.now() - (act || 0));
                    const h = Math.floor(rem / 3600000);
                    const m = Math.floor((rem % 3600000) / 60000);
                    showHQAlert('Must stay in tier for ' + h + 'h ' + m + 'm more!');
                    return;
                }
            }
            const tier = room.tiers[currentTier];
            const artDiscount = getArtefactDiscountForRoom(roomId);
            const finalCost = Math.max(0, tier.cost - artDiscount);
            if (gameState.chills < finalCost) { showHQAlert('Not enough Chills!'); return; }
            if (tier.dCost > 0 && gameState.diamonds < tier.dCost) { showHQAlert('Not enough Diamonds!'); return; }
            gameState.chills -= finalCost;
            gameState.hqChillsSpent = (gameState.hqChillsSpent || 0) + finalCost;
            if (tier.dCost > 0) {
                gameState.diamonds -= tier.dCost;
                gameState.hqDiamondsSpent = (gameState.hqDiamondsSpent || 0) + tier.dCost;
            }
            gameState.hqBuildTimers[roomId] = { tier: currentTier + 1, startTime: Date.now() };
            saveGame();
            updateUI();
            renderHQRooms();
            updateHQBonusSummary();
        }

        function activateHQRoom(roomId) {
            const buildInfo = gameState.hqBuildTimers[roomId];
            if (!buildInfo) return;
            if (Date.now() - buildInfo.startTime < HQ_BUILD_MS) { showHQAlert('Not finished building yet!'); return; }
            gameState.hqRooms[roomId] = buildInfo.tier;
            gameState.hqActiveTimes[roomId] = Date.now();
            delete gameState.hqBuildTimers[roomId];
            if (roomId === 'mine' && buildInfo.tier === 1) gameState.hqMineLastPayout = Date.now();
            saveGame();
            updateUI();
            renderHQRooms();
            updateHQBonusSummary();
            updateHQMineTimer();
            showHQAlert('OK:' + HQ_ROOMS.find(r => r.id === roomId).name + ' activated!');
        }

        function showHQAlert(msg) {
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            const isOk = msg.startsWith('OK:');
            const displayMsg = isOk ? 'âœ… ' + msg.slice(3) : msg;
            toast.innerHTML = '<div class="glass-strong rounded-xl p-3 border ' + (isOk ? 'border-neon-green/40' : 'border-red-500/40') + ' text-center"><p class="' + (isOk ? 'text-neon-green' : 'text-red-400') + ' font-orbitron text-sm">' + displayMsg + '</p></div>';
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 2500);
        }

        function claimMineDiamonds() {
            gameState.diamonds += 5;
            gameState.totalDiamonds = (gameState.totalDiamonds || 0) + 5;
            gameState.hqMineLastPayout = Date.now();
            gameState.hqMinePayoutCount = (gameState.hqMinePayoutCount || 0) + 1;
            saveGame();
            updateUI();
            updateHQMineTimer();
            // Toast
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `<div class="glass-strong rounded-xl p-3 border text-center" style="border-color:rgba(255,215,0,0.4)"><p class="font-orbitron font-bold" style="color:#ffd700;">+5 Diamonds Claimed!</p></div>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 2500);
        }

        function updateHQMineTimer() {
            const mineTier = gameState.hqRooms['mine'] || 0;
            const panel = document.getElementById('hqMinePanel');
            if (!panel) return;

            if (!mineTier) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');

            const intervalMs = getMineInterval() * 60 * 1000;
            const lastPayout = gameState.hqMineLastPayout || Date.now();
            const elapsed = Date.now() - lastPayout;
            const remaining = Math.max(0, intervalMs - elapsed);

            const timeLabel = document.getElementById('hqMineTimerLabel');
            const timeLeft = document.getElementById('hqMineTimeLeft');
            const claimBtn = document.getElementById('hqMineClaimBtn');

            if (remaining <= 0) {
                if (timeLeft) timeLeft.textContent = 'READY!';
                if (timeLabel) timeLabel.textContent = 'Payout ready:';
                if (claimBtn) claimBtn.classList.remove('hidden');
                if (timeLeft) timeLeft.classList.add('hidden');
            } else {
                if (claimBtn) claimBtn.classList.add('hidden');
                if (timeLeft) timeLeft.classList.remove('hidden');
                const m = Math.floor(remaining / 60000);
                const s = Math.floor((remaining % 60000) / 1000);
                if (timeLeft) timeLeft.textContent = `${m}m ${s}s`;
                if (timeLabel) timeLabel.textContent = `Next payout in:`;
            }
        }

        function renderHQRooms() {
            const container = document.getElementById('hqRoomsGrid');
            if (!container) return;
            const tierNames  = ['Basic', 'Enhanced', 'Legendary'];
            const tierColors = ['text-neon-cyan', 'text-neon-purple', 'text-yellow-400'];
            const tierBorders= ['hq-tier-basic', 'hq-tier-enhanced', 'hq-tier-legendary'];
            const now = Date.now();

            // Sequential: only show up to first non-maxed room (+ 1 beyond)
            let visibleCount = 1;
            for (let i = 0; i < HQ_ROOMS.length - 1; i++) {
                if ((gameState.hqRooms[HQ_ROOMS[i].id] || 0) >= 3) visibleCount = i + 2;
                else break;
            }

            const html = HQ_ROOMS.slice(0, visibleCount).map(room => {
                const activeTier  = gameState.hqRooms[room.id] || 0;
                const buildInfo   = (gameState.hqBuildTimers || {})[room.id];
                const isBuilding  = !!buildInfo;
                const buildElapsed= isBuilding ? now - buildInfo.startTime : 0;
                const buildDone   = isBuilding && buildElapsed >= HQ_BUILD_MS;
                const maxed       = activeTier >= 3 && !isBuilding;
                const pips = [0,1,2].map(i => {
                    const colors = ['bg-neon-cyan','bg-neon-purple','bg-yellow-400'];
                    return '<div class="w-2 h-2 rounded-full ' + (i < activeTier ? colors[i] : 'bg-white/20') + '"></div>';
                }).join('');

                if (isBuilding && buildDone) {
                    return '<div class="glass rounded-2xl p-4 border border-neon-green/50 transition-all" style="box-shadow:0 0 16px rgba(0,255,136,0.3)">' +
                        '<div class="flex items-start gap-3 mb-3"><div class="text-3xl flex-shrink-0">' + room.icon + '</div>' +
                        '<div class="flex-1"><div class="flex items-center justify-between mb-1"><h4 class="font-orbitron font-bold text-white text-sm">' + room.name + '</h4>' +
                        '<div class="flex gap-1">' + pips + '</div></div>' +
                        '<p class="text-neon-green text-xs font-bold">Construction complete! Activate to earn bonuses.</p></div></div>' +
                        '<button onclick="activateHQRoom(\'' + room.id + '\')" class="w-full py-3 rounded-xl bg-neon-green/20 border border-neon-green/50 text-neon-green font-orbitron font-bold text-sm hover:bg-neon-green/30 transition-all">ACTIVATE â€” Tier ' + buildInfo.tier + '</button></div>';
                }

                if (isBuilding) {
                    const pct = Math.min(100, (buildElapsed / HQ_BUILD_MS) * 100);
                    const rem = HQ_BUILD_MS - buildElapsed;
                    const bh = Math.floor(rem / 3600000), bm = Math.floor((rem % 3600000) / 60000), bs = Math.floor((rem % 60000) / 1000);
                    return '<div class="glass rounded-2xl p-4 border hq-room-building transition-all">' +
                        '<div class="flex items-start gap-3 mb-3"><div class="text-3xl flex-shrink-0 hq-building-icon">ðŸ—ï¸</div>' +
                        '<div class="flex-1"><div class="flex items-center justify-between mb-1"><h4 class="font-orbitron font-bold text-white text-sm">' + room.name + '</h4>' +
                        '<div class="flex gap-1">' + pips + '</div></div>' +
                        '<p class="text-yellow-400 text-xs font-bold">BUILDING TIER ' + buildInfo.tier + '...</p></div></div>' +
                        '<div class="w-full bg-white/10 rounded-full h-2 mb-2"><div class="bg-gradient-to-r from-yellow-400 to-neon-green h-2 rounded-full" style="width:' + pct + '%"></div></div>' +
                        '<p class="text-center text-yellow-400 font-orbitron text-xs">' + bh + 'h ' + bm + 'm ' + bs + 's remaining</p></div>';
                }

                if (maxed) {
                    return '<div class="glass rounded-2xl p-4 border hq-tier-legendary transition-all">' +
                        '<div class="flex items-start gap-3"><div class="text-3xl flex-shrink-0">' + room.icon + '</div>' +
                        '<div class="flex-1"><div class="flex items-center justify-between mb-1">' +
                        '<h4 class="font-orbitron font-bold text-yellow-400 text-sm">' + room.name + '</h4>' +
                        '<div class="flex gap-1">' + pips + '</div></div>' +
                        '<p class="text-xs text-yellow-400 font-bold">âœ¨ LEGENDARY â€” MAXED</p>' +
                        '<p class="text-xs text-white/40 mt-0.5">' + room.tiers[2].bonus + '</p></div></div></div>';
                }

                const nextTierIdx = activeTier;
                const nextTier = room.tiers[nextTierIdx];
                const artDiscount = getArtefactDiscountForRoom(room.id);
                const finalCost = Math.max(0, nextTier.cost - artDiscount);
                const actTime = (gameState.hqActiveTimes || {})[room.id];
                const resideElapsed = actTime ? now - actTime : 0;
                const resideReady = activeTier === 0 || resideElapsed >= HQ_RESIDE_MS;
                const canAfford = gameState.chills >= finalCost && (nextTier.dCost === 0 || gameState.diamonds >= nextTier.dCost) && resideReady;
                let resideInfo = '';
                if (activeTier > 0 && !resideReady) {
                    const rem2 = HQ_RESIDE_MS - resideElapsed;
                    const rh = Math.floor(rem2/3600000), rm = Math.floor((rem2%3600000)/60000);
                    resideInfo = '<p class="text-xs text-white/40 mt-1">â³ Upgrade available in: <span class="text-neon-cyan font-bold">' + rh + 'h ' + rm + 'm</span></p>';
                }
                // Artefact info for this room
                const appliedArt = (gameState.roomArtefacts || {})[room.id];
                const artInfo = appliedArt ? '<p class="text-xs text-yellow-400 mt-1">ðŸ”® Artefact applied: ' + (ARTEFACTS.find(a=>a.id===appliedArt)?.name || appliedArt) + ' (-' + formatNumber(artDiscount) + ' C)</p>' : '';
                const discountInfo = artDiscount > 0 ? '<span class="text-neon-green text-xs ml-1">(-' + formatNumber(artDiscount) + ')</span>' : '';
                const borderClass = activeTier > 0 ? tierBorders[activeTier-1] : 'border-white/10';
                // Check owned artefacts not yet assigned
                const availableArts = Object.keys(gameState.artefactsOwned || {}).filter(id => {
                    const art = ARTEFACTS.find(a=>a.id===id);
                    return art && art.currency === 'chills' && !Object.values(gameState.roomArtefacts||{}).includes(id);
                });
                const artApplyUI = (!appliedArt && availableArts.length > 0 && activeTier < 3 && !gameState.hqBuildTimers[room.id])
                    ? '<div class="mt-2 flex gap-2"><select id="artSel_' + room.id + '" class="flex-1 bg-black/40 border border-white/20 rounded-lg px-2 py-1 text-white text-xs focus:outline-none">' +
                      availableArts.map(id => '<option value="' + id + '">' + (ARTEFACTS.find(a=>a.id===id)?.name||id) + '</option>').join('') +
                      '</select><button onclick="applyArtefactToRoom(\'' + room.id + '\',document.getElementById(\'artSel_' + room.id + '\').value)" class="px-2 py-1 rounded-lg bg-yellow-400/20 border border-yellow-400/40 text-yellow-400 text-xs font-orbitron hover:bg-yellow-400/30 transition-all">Apply ðŸ”®</button></div>'
                    : '';
                return '<div class="glass rounded-2xl p-4 border ' + borderClass + ' transition-all">' +
                    '<div class="flex items-start gap-3 mb-3"><div class="text-3xl flex-shrink-0">' + room.icon + '</div>' +
                    '<div class="flex-1 min-w-0"><div class="flex items-center justify-between mb-1">' +
                    '<h4 class="font-orbitron font-bold text-white text-sm">' + room.name + '</h4>' +
                    '<div class="flex gap-1 items-center">' + pips + '</div></div>' +
                    '<p class="text-white/40 text-xs">' + room.desc + '</p>' +
                    (activeTier > 0 ? '<p class="text-xs mt-1 font-bold ' + tierColors[activeTier-1] + '">' + tierNames[activeTier-1] + ' Active â€¢ ' + room.tiers[activeTier-1].bonus + '</p>' : '') +
                    artInfo + resideInfo + artApplyUI + '</div></div>' +
                    '<div class="flex items-center justify-between gap-3">' +
                    '<div class="text-xs text-white/50"><span class="' + tierColors[nextTierIdx] + ' font-bold">' + tierNames[nextTierIdx] + '</span> tier:<br>' +
                    '<span class="text-white/70">' + nextTier.bonus + '</span></div>' +
                    '<button onclick="buyHQRoom(\'' + room.id + '\')" class="flex-shrink-0 flex flex-col items-end px-3 py-2 rounded-xl font-orbitron font-bold text-xs transition-all ' +
                    (canAfford ? 'bg-neon-cyan/20 border border-neon-cyan/50 text-neon-cyan hover:bg-neon-cyan/30' : 'bg-white/5 border border-white/10 text-white/30 cursor-not-allowed') + '">' +
                    '<span>' + formatNumber(finalCost) + ' C' + discountInfo + '</span>' +
                    (nextTier.dCost > 0 ? '<span class="neon-text-gold">+ ' + nextTier.dCost + ' \ud83d\udc8e</span>' : '') +
                    (!resideReady ? '<span class="text-white/20 text-xs">\u23f3 waiting</span>' : '') +
                    '</button></div></div>';
            }).join('');

            const lockedTeaser = visibleCount < HQ_ROOMS.length
                ? '<div class="glass rounded-2xl p-5 border border-white/5 opacity-40 text-center mt-3"><p class="text-4xl mb-2">ðŸ”’</p><p class="font-orbitron text-xs text-white/40">Next room unlocks after maxing current room to Legendary</p></div>'
                : '';
            container.innerHTML = html + lockedTeaser;

            const total = getHQTotalTiers();
            const rankEl = document.getElementById('hqRankLabel');
            const tierCountEl = document.getElementById('hqTierCount');
            const progressEl = document.getElementById('hqProgressBar');
            if (rankEl) rankEl.textContent = getHQRank(total);
            if (tierCountEl) tierCountEl.textContent = total;
            if (progressEl) progressEl.style.width = Math.min(100, (total / 30) * 100) + '%';
        }

        function updateHQBonusSummary() {
            const container = document.getElementById('hqBonusSummary');
            if (!container) return;
            const bonuses = [];
            let totalCps = 0, totalClick = 0, totalDiaPct = 0, totalProd = 0;
            HQ_ROOMS.forEach(room => {
                const tier = gameState.hqRooms[room.id] || 0;
                for (let t = 0; t < tier; t++) {
                    const td = room.tiers[t];
                    if (td.type === 'cps') totalCps += td.val;
                    if (td.type === 'click') totalClick += td.val;
                    if (td.type === 'diamond_pct') totalDiaPct += td.val;
                    if (td.type === 'all_prod') totalProd += td.val;
                }
            });
            const mineTier = gameState.hqRooms['mine'] || 0;
            if (totalCps > 0)    bonuses.push(`<div class="flex justify-between"><span class="text-white/50">Global CPS</span><span class="text-neon-cyan font-bold">+${Math.round(totalCps*100)}%</span></div>`);
            if (totalClick > 0)  bonuses.push(`<div class="flex justify-between"><span class="text-white/50">Click Power</span><span class="text-neon-purple font-bold">+${Math.round(totalClick*100)}%</span></div>`);
            if (totalDiaPct > 0) bonuses.push(`<div class="flex justify-between"><span class="text-white/50">Diamond Earn</span><span class="neon-text-gold font-bold">+${Math.round(totalDiaPct*100)}%</span></div>`);
            if (totalProd > 0)   bonuses.push(`<div class="flex justify-between"><span class="text-white/50">All Producers</span><span class="text-neon-green font-bold">+${Math.round(totalProd*100)}%</span></div>`);
            if (mineTier > 0)    bonuses.push(`<div class="flex justify-between"><span class="text-white/50">Diamond Mine</span><span class="text-yellow-400 font-bold">5â—† / ${getMineInterval()}min</span></div>`);
            container.innerHTML = bonuses.length ? bonuses.join('') : '<p class="text-white/30 text-center text-xs">No rooms built yet</p>';
        }
        function saveGame() {
            gameState.lastSave = Date.now();
            gameState.stakeChartData = stakeChartData;
            localStorage.setItem('idleVerseSave', JSON.stringify(gameState));
            // Firebase sync (every save)
            if (window.fbSyncPlayer) window.fbSyncPlayer(gameState);
        }
        
        function loadGame() {
            const saved = localStorage.getItem('idleVerseSave');
            if (saved) {
                const loaded = JSON.parse(saved);
                gameState = { ...gameState, ...loaded };
                
                // Ensure new fields exist for old saves
                if (!gameState.settings) gameState.settings = {};
                if (gameState.settings.music === undefined) gameState.settings.music = true;
                if (!gameState.totalClicks) gameState.totalClicks = 0;
                if (!gameState.totalAscensions) gameState.totalAscensions = 0;
                if (!gameState.nameChanges) gameState.nameChanges = 0;
                if (!gameState.totalSpent) gameState.totalSpent = 0;
                if (!gameState.totalDiamonds) gameState.totalDiamonds = 0;
                if (!gameState.totalOfflineChills) gameState.totalOfflineChills = 0;
                if (!gameState.achievementCpsMult) gameState.achievementCpsMult = 1;
                if (!gameState.achievementClickMult) gameState.achievementClickMult = 1;
                if (!gameState.achievementClickBonus) gameState.achievementClickBonus = 0;
                if (!gameState.producerMults) gameState.producerMults = {};
                if (!gameState.sessionStart) gameState.sessionStart = Date.now();
                if (!gameState.ownedNfts) gameState.ownedNfts = [];
                if (!gameState.artefactsOwned) gameState.artefactsOwned = {};
                if (!gameState.stakeHistory) gameState.stakeHistory = [];
                if (!gameState.hqRooms) gameState.hqRooms = {};
                if (!gameState.hqChillsSpent) gameState.hqChillsSpent = 0;
                if (!gameState.hqDiamondsSpent) gameState.hqDiamondsSpent = 0;
                if (!gameState.hqMinePayoutCount) gameState.hqMinePayoutCount = 0;
                if (!gameState.hqBuildTimers) gameState.hqBuildTimers = {};
                if (!gameState.hqActiveTimes) gameState.hqActiveTimes = {};
                if (!gameState.dStakeActive) gameState.dStakeActive = null;
                if (!gameState.dStakeHistory) gameState.dStakeHistory = [];
                if (!gameState.ownedHQItems) gameState.ownedHQItems = {};
                if (!gameState.roomArtefacts) gameState.roomArtefacts = {};
                if (!gameState.raidWins) gameState.raidWins = 0;
                if (gameState.convDay === undefined) gameState.convDay = '';
                if (gameState.convDiaUsed === undefined) gameState.convDiaUsed = 0;
                if (gameState.convChillUsed === undefined) gameState.convChillUsed = 0;
                // One-time 20 diamond bonus for v1.1 update
                if (!gameState.resetBonusGiven) {
                    gameState.diamonds += 20;
                    gameState.totalDiamonds += 20;
                    gameState.resetBonusGiven = true;
                }
                
                // Ensure producers array is complete
                gameState.producers = gameState.producers.map((p, i) => ({
                    ...producers[i],
                    ...p,
                }));
                
                // Ensure diamond upgrades are complete
                gameState.diamondUpgrades = gameState.diamondUpgrades.map((u, i) => ({
                    ...diamondUpgrades[i],
                    ...u,
                }));
                
                // Apply offline progress
                if (gameState.settings.offlineProgress && gameState.lastSave) {
                    const offlineTime = (Date.now() - gameState.lastSave) / 1000;
                    if (offlineTime > 5) {
                        const offlineCPS = getCPS();
                        const offlineChills = offlineCPS * offlineTime;
                        if (offlineChills > 0) {
                            gameState.chills += offlineChills;
                            gameState.totalChills += offlineChills;
                            gameState.totalOfflineChills = (gameState.totalOfflineChills||0) + offlineChills;
                            document.getElementById('offlineChills').textContent = formatNumber(offlineChills);
                            document.getElementById('offlineProgress').classList.remove('hidden');
                        }
                    }
                }
                
                return true;
            }
            return false;
        }
        
        // ==================== STARS BACKGROUND ====================
        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.opacity = Math.random() * 0.7 + 0.3;
                container.appendChild(star);
            }
        }
        
        // ==================== SOCIAL / FIREBASE UI ====================

        // Expose HQ rank for Firebase sync
        window.getHQRankForSync = () => getHQRank(getHQTotalTiers());

        // Expose gameState for Firebase module
        Object.defineProperty(window, 'gameState', {
            get: () => typeof gameState !== 'undefined' ? gameState : null,
            configurable: true,
        });

        // â”€â”€ Receive gift reward â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.applyGiftReward = function(chills, diamonds, msgs) {
            gameState.chills   += chills;
            gameState.totalChills += chills;
            gameState.diamonds += diamonds;
            gameState.totalDiamonds = (gameState.totalDiamonds || 0) + diamonds;
            saveGame();
            updateUI();
            msgs.forEach((msg, i) => {
                setTimeout(() => {
                    const t = document.createElement('div');
                    t.className = 'achievement-toast';
                    t.innerHTML = `<div class="glass-strong rounded-2xl p-4 border border-yellow-400/30 text-center" style="box-shadow:0 0 20px rgba(255,215,0,0.4)">
                        <p class="font-orbitron font-bold neon-text-gold">GIFT RECEIVED!</p>
                        <p class="text-white/70 text-sm mt-1">${msg}</p></div>`;
                    document.body.appendChild(t);
                    setTimeout(() => { t.classList.add('toast-out'); setTimeout(() => t.remove(), 400); }, 4500);
                }, i * 600);
            });
        };

        // â”€â”€ Daily gift limit tracking (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getGiftLimits() {
            const today = new Date().toDateString();
            const raw = localStorage.getItem('giftLimits');
            if (!raw) return { date: today, chills: 0, diamonds: 0 };
            const d = JSON.parse(raw);
            if (d.date !== today) return { date: today, chills: 0, diamonds: 0 };
            return d;
        }
        function saveGiftLimits(lim) {
            localStorage.setItem('giftLimits', JSON.stringify(lim));
        }
        function updateGiftLimitDisplay() {
            const lim = getGiftLimits();
            const el = document.getElementById('giftDailyLeft');
            if (el) el.textContent = `Daily left: ${formatNumber(1500e6 - lim.chills)} Chills â€¢ ${200 - lim.diamonds} â—†`;
        }

        // â”€â”€ Send Gift â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function sendGift() {
            if (!window.fbSendGift) {
                let waited = 0;
                while (!window.fbSendGift && waited < 5000) {
                    await new Promise(r => setTimeout(r, 200));
                    waited += 200;
                }
                if (!window.fbSendGift) { alert('Not connected to server yet. Try again in a moment.'); return; }
            }
            const toUsername = document.getElementById('giftUsername')?.value?.trim();
            const amount     = Math.floor(parseFloat(document.getElementById('giftAmount')?.value || 0));
            const currency   = document.getElementById('giftCurrency')?.value || 'chills';

            if (!toUsername) { alert('Enter a username!'); return; }
            if (amount <= 0) { alert('Enter a valid amount!'); return; }
            if (!gameState.username) { alert('Set your username first!'); return; }

            // Check limits
            const lim = getGiftLimits();
            if (currency === 'chills') {
                if (amount > 1500e6) { alert('Max gift is 1,500,000,000 Chills!'); return; }
                if (lim.chills + amount > 1500e6) { alert('You\'ve hit your daily Chill gift limit!'); return; }
                if (gameState.chills < amount) { alert('Not enough Chills!'); return; }
                gameState.chills -= amount;
            } else {
                if (amount > 200) { alert('Max gift is 200 Diamonds!'); return; }
                if (lim.diamonds + amount > 200) { alert('You\'ve hit your daily Diamond gift limit!'); return; }
                if (gameState.diamonds < amount) { alert('Not enough Diamonds!'); return; }
                gameState.diamonds -= amount;
            }

            const result = await window.fbSendGift(toUsername, amount, currency);
            if (!result.ok) {
                // Refund
                if (currency === 'chills') gameState.chills += amount;
                else gameState.diamonds += amount;
                alert(result.msg || 'Gift failed!');
                return;
            }

            // Commit limit
            if (currency === 'chills') lim.chills += amount;
            else lim.diamonds += amount;
            saveGiftLimits(lim);
            saveGame();
            updateUI();
            updateGiftLimitDisplay();

            const t = document.createElement('div');
            t.className = 'achievement-toast';
            t.innerHTML = `<div class="glass-strong rounded-2xl p-4 border border-yellow-400/30 text-center">
                <p class="font-orbitron font-bold neon-text-gold">Gift Sent!</p>
                <p class="text-white/70 text-sm mt-1">${formatNumber(amount)} ${currency === 'chills' ? 'Chills' : "â—†"} â†’ ${toUsername}</p></div>`;
            document.body.appendChild(t);
            setTimeout(() => { t.classList.add('toast-out'); setTimeout(() => t.remove(), 400); }, 4000);
            document.getElementById('giftUsername').value = '';
            document.getElementById('giftAmount').value = '';
        }

        // â”€â”€ Community Pot UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.renderPotUI = function() {
            const p = window.fbPotData || {};
            const potSize    = document.getElementById('potSize');
            const potTotalStaked = document.getElementById('potTotalStaked');
            const potTimeEl  = document.getElementById('potTimeLeft');
            const top3El     = document.getElementById('potTop3');
            const claimArea  = document.getElementById('potClaimArea');
            const recentEl   = document.getElementById('potRecentStakes');

            if (potSize)       potSize.textContent       = formatNumber(p.pot || 0) + ' Chills';
            if (potTotalStaked) potTotalStaked.textContent = formatNumber(p.totalStaked || 0) + ' Chills staked';

            const now    = window.getServerNow ? window.getServerNow() : Date.now();
            const weekMs = (p.weekEnd || 0) - now;
            const weekEnded = weekMs <= 0;
            if (potTimeEl) {
                if (!weekEnded) {
                    const d = Math.floor(weekMs / 86400000);
                    const h = Math.floor((weekMs % 86400000) / 3600000);
                    const m = Math.floor((weekMs % 3600000) / 60000);
                    potTimeEl.textContent = `${d}d ${h}h ${m}m`;
                } else {
                    potTimeEl.textContent = 'Week ended â€” prizes available!';
                }
            }

            // Top 3
            const top3 = p.top3 || [];
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const medColors = ['text-yellow-400','text-white/80','text-amber-600'];
            if (top3El) {
                if (!top3.length) {
                    top3El.innerHTML = '<p class="text-white/30 text-center text-xs">No stakes yet this week</p>';
                } else {
                    top3El.innerHTML = top3.map((s, i) => `
                        <div class="flex items-center justify-between p-2 rounded-xl bg-white/5">
                            <span class="${medColors[i]} font-bold text-sm">${medals[i]} ${s.name || 'Unknown'}</span>
                            <span class="text-white/60 text-xs">${formatNumber(s.amount || 0)} staked</span>
                        </div>`).join('');
                }
            }

            // Claim buttons
            if (claimArea) {
                if (weekEnded && top3.length) {
                    claimArea.classList.remove('hidden');
                    for (let i = 0; i < 3; i++) {
                        const btn = document.getElementById('potClaim' + i);
                        if (btn) {
                            if (top3[i] && top3[i].uid === window.fbUid) btn.classList.remove('hidden');
                            else btn.classList.add('hidden');
                        }
                    }
                } else {
                    claimArea.classList.add('hidden');
                }
            }

            // Recent stakes
            if (recentEl) {
                const recent = p.recentStakes || [];
                if (!recent.length) {
                    recentEl.innerHTML = '<p class="text-white/20 text-xs text-center">No recent stakes</p>';
                } else {
                    recentEl.innerHTML = recent.map(r => `
                        <div class="flex justify-between text-xs text-white/40 py-0.5">
                            <span>${r.name || '?'}</span>
                            <span class="text-neon-cyan">${formatNumber(r.amount || 0)} staked</span>
                        </div>`).join('');
                }
            }
        };
        setInterval(() => { if (window.renderPotUI) window.renderPotUI(); }, 60000);

        async function claimPotWin(position) {
            if (!window.fbClaimPotWin) return;
            const result = await window.fbClaimPotWin(position);
            if (result && result.ok) {
                gameState.diamonds += result.diamonds || 0;
                gameState.totalDiamonds = (gameState.totalDiamonds || 0) + (result.diamonds || 0);
                gameState.chills += result.chills || 0;
                gameState.totalChills += result.chills || 0;
                saveGame();
                updateUI();
                const posLabels = ['ðŸ¥‡ 1st','ðŸ¥ˆ 2nd','ðŸ¥‰ 3rd'];
                const t = document.createElement('div');
                t.className = 'achievement-toast';
                t.innerHTML = `<div class="glass-strong rounded-2xl p-4 border border-yellow-400/50 text-center" style="box-shadow:0 0 30px rgba(255,180,0,0.4)">
                    <p class="font-orbitron font-bold text-yellow-400">â­ ${posLabels[position]} POT WON!</p>
                    <p class="text-white/70 text-sm mt-1">+${result.diamonds} â—† + ${formatNumber(result.chills)} Chills!</p></div>`;
                document.body.appendChild(t);
                setTimeout(() => { t.classList.add('toast-out'); setTimeout(() => t.remove(), 400); }, 5000);
            } else {
                alert(result?.msg || 'Could not claim â€” week may not be over or already claimed.');
            }
        }

        // â”€â”€ Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let lbActiveTab = 'chills';
        function setLeaderboardTab(tab) {
            lbActiveTab = tab;
            ['chills','diamonds','hq'].forEach(t => {
                const btn = document.getElementById('lbTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (!btn) return;
                if (t === tab) {
                    btn.className = 'flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-neon-cyan/50 bg-neon-cyan/20 text-neon-cyan transition-all';
                } else {
                    btn.className = 'flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-white/10 bg-white/5 text-white/40 transition-all';
                }
            });
            renderLeaderboard();
        }

        window.renderLeaderboard = function() {
            const container = document.getElementById('lbList');
            if (!container) return;
            const data = (window.fbLeaderboardData || {})[lbActiveTab] || [];
            if (!data.length) {
                container.innerHTML = '<div class="text-center text-white/30 text-sm py-8">No data yet â€” be the first!</div>';
                return;
            }
            const myUid = window.fbUid;
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const valFn = r => lbActiveTab === 'chills' ? formatNumber(r.totalChills) + ' Chills'
                             : lbActiveTab === 'diamonds' ? r.diamonds + ' â—†'
                             : r.achCount + ' trophies';
            container.innerHTML = data.map((r, i) => {
                const isMe = r.uid === myUid;
                return `<div class="glass rounded-xl px-4 py-3 flex items-center gap-3 ${isMe ? 'border border-neon-cyan/40' : 'border border-white/5'}">
                    <span class="font-orbitron text-sm font-bold ${i < 3 ? 'text-yellow-400' : 'text-white/30'} w-6 text-center">${medals[i] || '#' + (i + 1)}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-orbitron text-sm font-bold ${isMe ? 'text-neon-cyan' : 'text-white'} truncate">${r.username || 'Anonymous'}${isMe ? ' (you)' : ''}</p>
                        <p class="text-white/40 text-xs">${r.hqRank || 'Empty Lot'}</p>
                    </div>
                    <span class="text-xs font-bold ${lbActiveTab === 'diamonds' ? 'neon-text-gold' : lbActiveTab === 'chills' ? 'text-neon-cyan' : 'text-yellow-400'}">${valFn(r)}</span>
                </div>`;
            }).join('');
        };

        // â”€â”€ Visit Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function visitProfile() {
            const username = document.getElementById('visitUsername')?.value?.trim();
            if (!username) { alert('Enter a username!'); return; }
            if (!window.fbGetProfile) {
                let waited = 0;
                while (!window.fbGetProfile && waited < 5000) {
                    await new Promise(r => setTimeout(r, 200));
                    waited += 200;
                }
                if (!window.fbGetProfile) { alert('Not connected yet â€” try again shortly.'); return; }
            }
            const card = document.getElementById('visitedProfile');
            if (card) { card.classList.remove('hidden'); card.innerHTML = '<p class="text-white/40 text-center text-sm">Searching...</p>'; }
            const profile = await window.fbGetProfile(username);
            if (!profile) {
                if (card) card.innerHTML = '<p class="text-red-400 text-center text-sm font-orbitron">Player not found</p>';
                return;
            }
            const isMe = profile.uid === window.fbUid;
            if (card) card.innerHTML = `
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-white/50">Username</span><span class="text-neon-cyan font-bold font-orbitron">${profile.username}</span></div>
                    <div class="flex justify-between"><span class="text-white/50">HQ Rank</span><span class="text-neon-purple font-bold">${profile.hqRank || 'Empty Lot'}</span></div>
                    <div class="flex justify-between"><span class="text-white/50">Total Chills</span><span class="text-white/70">${formatNumber(profile.totalChills || 0)}</span></div>
                    <div class="flex justify-between"><span class="text-white/50">Diamonds</span><span class="neon-text-gold font-bold">${profile.diamonds || 0} â—†</span></div>
                    <div class="flex justify-between"><span class="text-white/50">NFTs</span><span class="text-neon-green font-bold">${profile.nftCount || 0}</span></div>
                    <div class="flex justify-between"><span class="text-white/50">Trophies</span><span class="text-yellow-400 font-bold">${profile.achCount || 0}</span></div>
                    ${!isMe ? `
                    <div class="flex gap-2 mt-3">
                        <button onclick="document.getElementById('giftUsername').value='${profile.username}';switchTab('Social');setTimeout(()=>document.getElementById('giftAmount').focus(),100)"
                            class="flex-1 py-2 rounded-xl border rounded-xl font-orbitron text-xs font-bold transition-all" style="background:rgba(255,215,0,0.15);border-color:rgba(255,215,0,0.4);color:#ffd700; transition-all">
                            ðŸŽ Gift
                        </button>
                        <button onclick="sendFriendRequest('${profile.username}')"
                            class="flex-1 py-2 rounded-xl bg-neon-cyan/20 border border-neon-cyan/40 text-neon-cyan font-orbitron text-xs font-bold hover:bg-neon-cyan/30 transition-all">
                            âž• Add Friend
                        </button>
                        <button onclick="initiateRaid('${profile.uid}','${profile.username}',${profile.totalChills||0},${profile.diamonds||0},'${profile.hqRank||'Empty Lot'}')"
                            class="flex-1 py-2 rounded-xl bg-red-500/20 border border-red-500/40 text-red-400 font-orbitron text-xs font-bold hover:bg-red-500/30 transition-all">
                            âš”ï¸ Raid
                        </button>
                    </div>` : '<p class="text-white/30 text-xs text-center mt-2">This is you!</p>'}
                </div>`;
        }

        async function sendFriendRequest(username) {
            if (!window.fbSendFriendRequest) { alert('Not connected'); return; }
            const result = await window.fbSendFriendRequest(username);
            showHQAlert(result.ok ? 'OK:Friend request sent to ' + username + '!' : result.msg || 'Failed');
        }

        // Local raid lock to prevent double-clicks bypassing Firestore check
        const _raidInProgress = new Set();

        async function initiateRaid(targetUid, targetName, targetChills, targetDiamonds, targetHqRank) {
            if (!window.fbCanRaid) { alert('Not connected'); return; }

            // Local double-click guard
            if (_raidInProgress.has(targetUid)) return;
            _raidInProgress.add(targetUid);

            try {
                const cost = 200e6;
                const dCost = 5;
                if (gameState.chills < cost) { showHQAlert('Need 200M Chills to raid!'); return; }
                if (gameState.diamonds < dCost) { showHQAlert('Need 5 Diamonds to raid!'); return; }
                if (getHQTotalTiers() < 1) { showHQAlert('You need at least 1 HQ room to raid!'); return; }

                const canRaid = await window.fbCanRaid(targetUid);
                if (!canRaid.ok) { showHQAlert(canRaid.msg || 'Cannot raid this player'); return; }

                if (!confirm(`âš”ï¸ Raid ${targetName}?\nCost: 200M Chills + 5 â—†\nYou can only raid them ONCE today.`)) return;

                // Deduct cost immediately and log to Firestore BEFORE calculating outcome
                // This prevents double-raid exploit â€” Firestore doc written first
                gameState.chills -= cost;
                gameState.diamonds -= dCost;
                saveGame(); updateUI();
                await window.fbLogRaid(targetUid, false, 0, targetName, targetHqRank, 0); // placeholder â€” updated below

                // Raid win calculation based on HQ tier comparison
                const rankToTier = { 'Empty Lot':0,'Starter Pad':1,'Chill Den':5,'Gang HQ':10,'Verse Fortress':15,'Diamond Empire':20,'Chill Legion':25,'ðŸ‘‘ THE VERSE THRONE':30 };
                const myTiers = getHQTotalTiers();
                const targetTiers = rankToTier[targetHqRank] || 5;
                const winChance = Math.min(0.85, Math.max(0.15, 0.5 + (myTiers - targetTiers) * 0.025));
                const won = Math.random() < winChance;

                let chillReward = 0;
                let diamondReward = 0;

                if (won) {
                    // Chills loot: up to 20% of target's total chills
                    const maxChillLoot = Math.floor((targetChills || 50e6) * 0.20);
                    chillReward = Math.floor(maxChillLoot * (0.5 + Math.random() * 0.5)); // 10â€“20%

                    // Diamond loot: random 0â€“15 diamonds, scaled by target's diamonds (max 15)
                    const maxDiaLoot = Math.min(15, Math.floor((targetDiamonds || 0) * 0.15));
                    diamondReward = maxDiaLoot > 0 ? Math.floor(Math.random() * (maxDiaLoot + 1)) : 0;

                    // Chill trap bonus
                    if (gameState.chillTrapActive) {
                        chillReward = Math.floor(chillReward * 1.05);
                        gameState.chillTrapActive = false;
                    }

                    gameState.chills += chillReward;
                    gameState.totalChills += chillReward;
                    if (diamondReward > 0) {
                        gameState.diamonds += diamondReward;
                        gameState.totalDiamonds = (gameState.totalDiamonds || 0) + diamondReward;
                    }
                } else {
                    // Neon armor reduces loss
                    if (gameState.neonArmorActive) {
                        gameState.neonArmorActive = false;
                        showHQAlert('ðŸ›¡ï¸ Neon Armor absorbed 50% of the loss!');
                    }
                }

                // Update Firestore log with actual result
                await window.fbLogRaid(targetUid, won, chillReward, targetName, targetHqRank, diamondReward);
                saveGame(); updateUI();

                // Show result toast
                const toast = document.createElement('div');
                toast.className = 'achievement-toast';
                toast.innerHTML = `<div class="glass-strong rounded-2xl p-4 border ${won ? 'border-neon-green/50' : 'border-red-500/50'} text-center">
                    <p class="font-orbitron font-bold text-lg ${won ? 'text-neon-green' : 'text-red-400'}">${won ? 'âš”ï¸ RAID SUCCESSFUL!' : 'ðŸ’€ RAID FAILED'}</p>
                    <p class="text-white/70 text-sm mt-1">${won
                        ? '+' + formatNumber(chillReward) + ' Chills' + (diamondReward > 0 ? ' +' + diamondReward + ' â—†' : '')
                        : 'Lost 200M Chills & 5 â—†'}</p>
                    <p class="text-white/30 text-xs mt-1">vs ${targetName}</p>
                </div>`;
                document.body.appendChild(toast);
                setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 5000);

                // Refresh profile tab raid history if open
                if (document.getElementById('tabProfile') && !document.getElementById('tabProfile').classList.contains('hidden')) loadRaidHistory();

            } finally {
                // Always release the lock
                _raidInProgress.delete(targetUid);
            }
        }

        // â”€â”€ My Profile update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateMyProfile() {
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            set('myProfName',   gameState.username || 'â€”');
            set('myProfHQ',     getHQRank(getHQTotalTiers()));
            set('myProfChills', formatNumber(gameState.totalChills || 0));
            set('myProfDia',    (gameState.diamonds || 0) + ' â—†');
            set('myProfNFT',    (gameState.ownedNfts || []).length);
            set('myProfAch',    Object.keys(gameState.achievements || {}).length);
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab' + tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('opacity-60');
            });
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) { activeBtn.classList.add('tab-active'); activeBtn.classList.remove('opacity-60'); }
            if (tabName === 'Social') {
                updateMyProfile();
                updateGiftLimitDisplay();
                if (window.renderPotUI) window.renderPotUI();
                if (window.loadIncomingGifts) window.loadIncomingGifts();
            }
            if (tabName === 'Leaderboard') renderLeaderboard();
            if (tabName === 'HQ') { renderHQRooms(); updateHQBonusSummary(); updateHQMineTimer(); renderHQItemsVault(); }
            if (tabName === 'Profile') { updateProfilePage(); loadFriendRequests(); loadFriendsList(); loadRaidHistory(); }
            if (tabName === 'BlackMarket') { loadMarketListings(); populateSellNFTSelect(); renderHQItemsShop(); }
            if (tabName === 'Diamonds') { setConvertTab('toChills'); }
        }

        // â”€â”€ PROFILE PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateProfilePage() {
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            const name = gameState.username || '?';
            set('profPageName', name);
            set('profileAvatar', name.charAt(0).toUpperCase());
            set('profPageHQ', getHQRank(getHQTotalTiers()));
            set('profPageChills', formatNumber(gameState.totalChills || 0));
            set('profPageDia', (gameState.diamonds || 0) + ' â—†');
            set('profPageNFT', (gameState.ownedNfts || []).length);
            set('profPageTrophies', Object.keys(gameState.achievements || {}).length);
            set('profPageAscensions', gameState.totalAscensions || 0);
            set('profPageRaidWins', gameState.raidWins || 0);
        }

        async function loadFriendRequests() {
            const el = document.getElementById('friendRequestsList');
            if (!el) return;
            if (!window.fbGetIncomingRequests) { el.innerHTML = '<p class="text-white/30 text-xs text-center">Not connected</p>'; return; }
            el.innerHTML = '<p class="text-white/30 text-xs text-center">Loading...</p>';
            const requests = await window.fbGetIncomingRequests();
            if (!requests.length) { el.innerHTML = '<p class="text-white/30 text-xs text-center">No pending requests</p>'; return; }
            el.innerHTML = requests.map(req => `
                <div class="flex items-center justify-between p-2 bg-white/5 rounded-xl">
                    <span class="text-white text-sm font-orbitron">${req.fromName || 'Unknown'}</span>
                    <div class="flex gap-2">
                        <button onclick="acceptFriend('${req.id}','${req.fromUid}','${req.fromName}')" class="px-3 py-1 rounded-lg bg-neon-green/20 border border-neon-green/40 text-neon-green text-xs font-orbitron hover:bg-neon-green/30 transition-all">âœ“ Accept</button>
                        <button onclick="declineFriend('${req.id}')" class="px-3 py-1 rounded-lg bg-red-500/20 border border-red-500/40 text-red-400 text-xs font-orbitron hover:bg-red-500/30 transition-all">âœ— Decline</button>
                    </div>
                </div>`).join('');
        }

        async function acceptFriend(reqId, fromUid, fromName) {
            if (!window.fbAcceptFriendRequest) return;
            await window.fbAcceptFriendRequest(reqId, fromUid, fromName);
            showHQAlert('OK:Now friends with ' + fromName + '!');
            loadFriendRequests(); loadFriendsList();
        }
        async function declineFriend(reqId) {
            if (!window.fbDeclineFriendRequest) return;
            await window.fbDeclineFriendRequest(reqId);
            loadFriendRequests();
        }

        async function loadFriendsList() {
            const el = document.getElementById('friendsList');
            if (!el) return;
            if (!window.fbGetFriends) { el.innerHTML = '<p class="text-white/30 text-xs text-center">Not connected</p>'; return; }
            const friends = await window.fbGetFriends();
            if (!friends.length) { el.innerHTML = '<p class="text-white/30 text-xs text-center">No friends yet â€” visit players to add them!</p>'; return; }
            el.innerHTML = friends.map(f => `
                <div class="flex items-center justify-between p-2 bg-white/5 rounded-xl">
                    <span class="text-neon-cyan text-sm font-orbitron">${f.username || 'Unknown'}</span>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('giftUsername').value='${f.username}';switchTab('Social')" class="px-3 py-1 rounded-lg border rounded-lg text-xs font-orbitron transition-all" style="background:rgba(255,215,0,0.15);border-color:rgba(255,215,0,0.4);color:#ffd700; transition-all">ðŸŽ Gift</button>
                        <button onclick="document.getElementById('visitUsername').value='${f.username}';switchTab('Social');setTimeout(visitProfile,100)" class="px-3 py-1 rounded-lg bg-neon-cyan/10 border border-neon-cyan/20 text-neon-cyan text-xs font-orbitron hover:bg-neon-cyan/20 transition-all">View</button>
                    </div>
                </div>`).join('');
        }

        async function loadRaidHistory() {
            const el = document.getElementById('profileRaidHistory');
            if (!el) return;
            if (!window.fbGetRaidHistory) { el.innerHTML = '<p class="text-white/30 text-xs text-center">Not connected</p>'; return; }
            const history = await window.fbGetRaidHistory();
            if (!history.length) { el.innerHTML = '<p class="text-white/30 text-xs text-center">No raids yet</p>'; return; }
            el.innerHTML = history.map(r => {
                const ts = r.timestamp?.toMillis?.() || r.timestamp?.seconds * 1000 || 0;
                const dateStr = ts ? new Date(ts).toLocaleDateString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : 'â€”';
                const defName = r.defenderName || r.defenderUid?.slice(0,8) || '?';
                const lootChills = r.won && r.reward ? '+' + formatNumber(r.reward) + ' C' : '';
                const lootDia   = r.won && r.diamondReward > 0 ? ' +' + r.diamondReward + '<svg style="width:10px;height:10px;display:inline;vertical-align:middle;margin-left:2px;" viewBox="0 0 24 24" fill="#ffd700"><path d="M6 2l-4 7 10 13 10-13-4-7z"/></svg>' : '';
                return `
                <div class="glass rounded-xl p-3 border ${r.won ? 'border-neon-green/20' : 'border-red-500/20'}">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${r.won ? 'sword' : 'skull'}" style="width:14px;height:14px;color:${r.won ? '#39ff14' : '#f87171'};"></i>
                            <span class="font-orbitron text-xs font-bold ${r.won ? 'text-neon-green' : 'text-red-400'}">${r.won ? 'RAID WIN' : 'RAID LOSS'}</span>
                        </div>
                        <span class="font-mono text-xs text-white/30">${dateStr}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/60 text-xs">Target: <span class="text-neon-cyan font-bold font-orbitron">${defName}</span></p>
                            <p class="text-white/30 text-xs">${r.defenderHqRank || ''}</p>
                        </div>
                        <div class="text-right">
                            ${r.won
                                ? `<p class="text-neon-green font-orbitron font-bold text-xs">${lootChills}</p>
                                   ${r.diamondReward > 0 ? `<p class="font-orbitron font-bold text-xs" style="color:#ffd700;">${lootDia}</p>` : ''}`
                                : `<p class="text-red-400 font-orbitron text-xs">-200M C &amp; -5 <svg style="width:9px;height:9px;display:inline;vertical-align:middle;" viewBox="0 0 24 24" fill="#ffd700"><path d="M6 2l-4 7 10 13 10-13-4-7z"/></svg></p>`
                            }
                        </div>
                    </div>
                </div>`;
            }).join('');
            // Re-init lucide icons after dynamic render
            if (window.lucide) window.lucide.createIcons();
        }

        // â”€â”€ BLACK MARKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const HQ_MARKET_ITEMS = [
            { id: 'shield_24h',   name: 'HQ Shield (24h)',    icon: 'shield',        desc: 'Protects your HQ from raids for 24 hours', costChills: 0, costDia: 15, category: 'protection' },
            { id: 'neon_sign',    name: 'Neon Sign',           icon: 'zap',           desc: '+1% CPS bonus for 2 hours', costChills: 50e6, costDia: 0, category: 'decor' },
            { id: 'chill_plant',  name: 'Chill Plant',         icon: 'leaf',          desc: 'Decorative. +0.5% CPS permanently', costChills: 200e6, costDia: 0, category: 'decor' },
            { id: 'power_cell',   name: 'Power Cell',          icon: 'battery-charging', desc: 'Doubles a room\'s bonus for 1 hour', costChills: 0, costDia: 25, category: 'boost' },
            { id: 'upgrade_kit',  name: 'Upgrade Kit',         icon: 'wrench',        desc: 'Reduces HQ room build time by 1 hour', costChills: 0, costDia: 30, category: 'utility' },
            { id: 'wall_mural',   name: 'Wall Mural',          icon: 'palette',       desc: 'Cosmetic art for your HQ rooms', costChills: 100e6, costDia: 0, category: 'decor' },
            { id: 'beacon',       name: 'Beacon',              icon: 'flashlight',    desc: '+50% Diamond Mine output for next payout', costChills: 0, costDia: 20, category: 'boost' },
            { id: 'chill_trap',   name: 'Chill Trap',          icon: 'crosshair',     desc: 'Steals 5% more Chills on your next raid win', costChills: 150e6, costDia: 0, category: 'combat' },
            { id: 'neon_armor',   name: 'Neon Armor',          icon: 'shield-check',  desc: 'Reduces raid losses by 50% once', costChills: 0, costDia: 40, category: 'protection' },
            { id: 'star_lantern', name: 'Star Lantern',        icon: 'lamp',          desc: 'Cosmetic room decoration for your HQ', costChills: 300e6, costDia: 0, category: 'decor' },
        ];

        let marketTab = 'browse';
        function setMarketTab(tab) {
            marketTab = tab;
            ['browse','sell','hqitems'].forEach(t => {
                const id = t === 'browse' ? 'mktTabBrowse' : t === 'sell' ? 'mktTabSell' : 'mktTabHQ';
                const panelId = t === 'browse' ? 'mktBrowsePanel' : t === 'sell' ? 'mktSellPanel' : 'mktHQPanel';
                const btn = document.getElementById(id);
                const panel = document.getElementById(panelId);
                if (btn) {
                    if (t === tab) { btn.className = 'flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-red-400/50 bg-red-400/20 text-red-400 transition-all'; }
                    else { btn.className = 'flex-1 py-2 rounded-xl font-orbitron text-xs font-bold border border-white/10 bg-white/5 text-white/40 transition-all'; }
                }
                if (panel) { panel.classList.toggle('hidden', t !== tab); }
            });
            if (tab === 'sell') populateSellNFTSelect();
            if (tab === 'hqitems') renderHQItemsShop();
        }

        async function loadMarketListings() {
            const el = document.getElementById('marketListings');
            if (!el) return;
            el.innerHTML = '<div class="text-center text-white/30 py-8"><p class="text-4xl mb-2">â³</p><p>Loading...</p></div>';
            if (!window.fbGetMarketListings) {
                el.innerHTML = '<div class="text-center text-white/30 py-8"><p class="text-sm">Not connected yet â€” try again shortly.</p></div>';
                return;
            }
            const listings = await window.fbGetMarketListings();
            if (!listings.length) {
                el.innerHTML = '<div class="text-center text-white/30 py-8"><p class="text-4xl mb-2">ðŸª</p><p class="text-sm">No listings yet â€” be the first to sell!</p></div>';
                return;
            }
            const rarityColors = { legend: 'border-yellow-400/60', rare: 'border-yellow-400/30', common: 'border-neon-cyan/30' };
            const rarityText   = { legend: 'text-yellow-400', rare: 'neon-text-gold', common: 'text-neon-cyan' };
            const now = Date.now();
            el.innerHTML = listings.map(l => {
                const isNFT = l.type === 'nft';
                const rarity = l.item?.rarity || 'common';
                const borderColor = rarityColors[rarity] || rarityColors.common;
                const textColor   = rarityText[rarity]   || rarityText.common;
                const isMyListing = l.sellerUid === window.fbUid;
                // Expiry countdown
                const expiresAt = l.expiresAt?.toMillis?.() || (l.listedAt || now) + 24 * 60 * 60 * 1000;
                const msLeft = expiresAt - now;
                const hLeft = Math.floor(msLeft / 3600000);
                const mLeft = Math.floor((msLeft % 3600000) / 60000);
                const expiryLabel = msLeft > 0 ? `â± ${hLeft}h ${mLeft}m left` : 'âš ï¸ Expiring soon';
                return `<div class="glass rounded-2xl p-4 border ${borderColor} ${isMyListing ? 'ring-1 ring-neon-cyan/40' : ''}">
                    <div class="flex items-start gap-3">
                        ${isNFT && l.item?.file
                            ? `<img src="${l.item.file}" class="w-16 h-16 rounded-xl object-cover flex-shrink-0" onerror="this.src='';this.className='w-16 h-16 rounded-xl bg-white/10 flex-shrink-0'">`
                            : `<div class="w-16 h-16 rounded-xl bg-white/10 flex items-center justify-center text-2xl flex-shrink-0">ðŸ–¼ï¸</div>`}
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="font-orbitron font-bold text-white text-sm truncate">${l.item?.name || 'NFT'}</p>
                                ${isMyListing ? `<span class="text-xs font-orbitron font-bold text-neon-cyan bg-neon-cyan/10 border border-neon-cyan/30 px-2 py-0.5 rounded-full">YOURS</span>` : ''}
                            </div>
                            <p class="text-xs ${textColor} uppercase font-bold">${rarity}</p>
                            <p class="text-xs text-white/50 mt-0.5">by <span class="text-white/80">${l.sellerName || 'Unknown'}</span></p>
                            <div class="flex gap-3 mt-2 flex-wrap items-center">
                                ${l.priceChills > 0 ? `<span class="text-xs text-neon-cyan font-bold">${formatNumber(l.priceChills)} C</span>` : ''}
                                ${l.priceDiamonds > 0 ? `<span class="text-xs neon-text-gold font-bold">${l.priceDiamonds} â—†</span>` : ''}
                                ${!l.priceChills && !l.priceDiamonds ? '<span class="text-xs text-neon-green font-bold">FREE</span>' : ''}
                                <span class="text-xs text-white/30">${expiryLabel}</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 flex-shrink-0">
                            ${isMyListing
                                ? `<button onclick="cancelMyListing('${l.id}')" class="px-3 py-2 rounded-xl bg-red-500/20 border border-red-500/40 text-red-400 font-orbitron text-xs hover:bg-red-500/30 transition-all">â†© Take Back</button>`
                                : `${l.priceChills > 0 ? `<button onclick="buyListing('${l.id}','chills')" class="px-3 py-2 rounded-xl bg-neon-cyan/20 border border-neon-cyan/40 text-neon-cyan font-orbitron text-xs hover:bg-neon-cyan/30 transition-all">Buy C</button>` : ''}
                                   ${l.priceDiamonds > 0 ? `<button onclick="buyListing('${l.id}','diamonds')" class="px-3 py-2 rounded-xl bg-yellow-400/10 border border-yellow-400/30 neon-text-gold font-orbitron text-xs hover:bg-yellow-400/10 transition-all">Buy â—†</button>` : ''}
                                   ${!l.priceChills && !l.priceDiamonds ? `<button onclick="buyListing('${l.id}','chills')" class="px-3 py-2 rounded-xl bg-neon-green/20 border border-neon-green/40 text-neon-green font-orbitron text-xs hover:bg-neon-green/30 transition-all">Claim</button>` : ''}`
                            }
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function buyListing(listingId, currency) {
            if (!window.fbBuyMarketItem) { alert('Not connected'); return; }
            // Get listing data first to check balance before committing
            const listings = window.fbGetMarketListings ? await window.fbGetMarketListings() : [];
            const listing = listings.find(l => l.id === listingId);
            if (!listing) { alert('Listing not found â€” may have been sold already.'); loadMarketListings(); return; }
            // Check balance BEFORE purchasing
            if (currency === 'chills' && listing.priceChills > 0) {
                if (gameState.chills < listing.priceChills) { alert('Not enough Chills! Need ' + formatNumber(listing.priceChills)); return; }
            } else if (currency === 'diamonds' && listing.priceDiamonds > 0) {
                if (gameState.diamonds < listing.priceDiamonds) { alert('Not enough Diamonds! Need ' + listing.priceDiamonds + ' â—†'); return; }
            }
            const result = await window.fbBuyMarketItem(listingId, currency);
            if (!result.ok) { alert(result.msg || 'Purchase failed'); return; }
            const item = result.item;
            // Deduct cost
            if (currency === 'chills' && item.priceChills > 0) gameState.chills -= item.priceChills;
            else if (currency === 'diamonds' && item.priceDiamonds > 0) gameState.diamonds -= item.priceDiamonds;
            // Add NFT to inventory
            if (item.type === 'nft' && item.item) {
                if (!gameState.ownedNfts) gameState.ownedNfts = [];
                gameState.ownedNfts.push({ ...item.item, mintedAt: Date.now(), id: Date.now(), boughtFrom: item.sellerName });
                gameState.nftCount = (gameState.nftCount || 0) + 1;
            }
            saveGame(); updateUI(); renderNFTCollection();
            showHQAlert('OK:' + (item.item?.name || 'Item') + ' purchased!');
            loadMarketListings();
        }

        async function cancelMyListing(listingId) {
            if (!window.fbCancelListing) return;
            // Find the listing data to return the item
            const listings = window.fbGetMarketListings ? await window.fbGetMarketListings() : [];
            const listing = listings.find(l => l.id === listingId);
            await window.fbCancelListing(listingId);
            // Return NFT to inventory
            if (listing?.item) {
                if (!gameState.ownedNfts) gameState.ownedNfts = [];
                gameState.ownedNfts.push({ ...listing.item, returnedAt: Date.now() });
                gameState.nftCount = (gameState.nftCount || 0) + 1;
                saveGame(); updateUI(); renderNFTCollection();
                showHQAlert('OK:' + (listing.item.name || 'NFT') + ' returned to your vault!');
            }
            loadMarketListings();
        }

        function populateSellNFTSelect() {
            const sel = document.getElementById('sellNFTSelect');
            if (!sel) return;
            const nfts = gameState.ownedNfts || [];
            sel.innerHTML = '<option value="">â€” Choose an NFT to sell â€”</option>' +
                nfts.map((n, i) => `<option value="${i}">${n.name} (${n.rarity})</option>`).join('');
        }

        async function listNFTForSale() {
            if (!window.fbListNFT) { alert('Not connected'); return; }
            const sel = document.getElementById('sellNFTSelect');
            const idx = parseInt(sel?.value);
            if (isNaN(idx)) { alert('Select an NFT!'); return; }
            const priceChills = Math.floor(parseFloat(document.getElementById('sellPriceChills')?.value || 0));
            const priceDia = Math.floor(parseFloat(document.getElementById('sellPriceDia')?.value || 0));
            const nft = (gameState.ownedNfts || [])[idx];
            if (!nft) { alert('NFT not found'); return; }
            // Remove from inventory temporarily (will be re-added if cancelled)
            gameState.ownedNfts.splice(idx, 1);
            gameState.nftCount = Math.max(0, (gameState.nftCount || 1) - 1);
            saveGame(); updateUI(); renderNFTCollection();
            const result = await window.fbListNFT(nft, priceChills, priceDia);
            if (result.ok) { showHQAlert('OK:NFT listed for sale!'); populateSellNFTSelect(); }
            else { gameState.ownedNfts.push(nft); gameState.nftCount++; saveGame(); alert('Failed to list'); }
        }

        function renderHQItemsVault() {
            const el = document.getElementById('hqItemsVault');
            if (!el) return;
            const owned = gameState.ownedHQItems || {};
            const items = HQ_MARKET_ITEMS.filter(i => (owned[i.id] || 0) > 0);
            if (!items.length) {
                el.innerHTML = '<p class="text-white/30 text-center text-xs">No items yet â€” buy from the Black Market</p>';
                return;
            }
            const categoryColors = {
                protection: 'text-neon-green border-neon-green/30',
                boost:      'text-neon-cyan border-neon-cyan/30',
                decor:      'text-neon-purple border-neon-purple/30',
                utility:    'text-yellow-400 border-yellow-400/30',
                combat:     'text-red-400 border-red-400/30',
            };
            el.innerHTML = items.map(item => {
                const count = owned[item.id] || 0;
                const cc = categoryColors[item.category] || 'text-white/60 border-white/10';
                // Active status for certain items
                let activeStatus = '';
                if (item.id === 'shield_24h') {
                    const shieldActive = gameState.hqShieldExpiry && gameState.hqShieldExpiry > Date.now();
                    if (shieldActive) {
                        const rem = gameState.hqShieldExpiry - Date.now();
                        const h = Math.floor(rem / 3600000), m = Math.floor((rem % 3600000) / 60000);
                        activeStatus = `<span class="text-neon-green text-xs font-bold">ðŸ›¡ï¸ ACTIVE â€” ${h}h ${m}m left</span>`;
                    }
                }
                if (item.id === 'beacon') activeStatus = gameState.hqMineBeaconActive ? '<span class="text-yellow-400 text-xs font-bold">âš¡ ACTIVE next payout</span>' : '';
                return `<div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border ${cc.split(' ')[1]}">
                    <div class="flex-1">
                        <p class="font-orbitron font-bold text-white text-xs">${item.name}</p>
                        <p class="text-white/40 text-xs mt-0.5">${item.desc}</p>
                        ${activeStatus ? `<p class="mt-1">${activeStatus}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0 ml-3">
                        <span class="font-orbitron font-bold text-xs ${cc.split(' ')[0]} bg-white/5 px-2 py-1 rounded-lg">Ã—${count}</span>
                        ${item.id !== 'shield_24h' && item.id !== 'chill_plant' && item.id !== 'beacon' ? 
                          `<button onclick="useHQItem('${item.id}')" class="px-2 py-1 rounded-lg bg-neon-cyan/20 border border-neon-cyan/30 text-neon-cyan text-xs font-orbitron hover:bg-neon-cyan/30 transition-all">USE</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function useHQItem(itemId) {
            const owned = gameState.ownedHQItems || {};
            if (!owned[itemId] || owned[itemId] < 1) { showHQAlert('No ' + itemId + ' left!'); return; }
            const item = HQ_MARKET_ITEMS.find(i => i.id === itemId);
            if (!item) return;
            // Apply effect
            if (itemId === 'neon_sign') {
                gameState.achievementCpsMult = (gameState.achievementCpsMult || 1) + 0.01;
                showHQAlert('OK:Neon Sign activated! +1% CPS for 2 hours');
            } else if (itemId === 'power_cell') {
                showHQAlert('OK:Power Cell activated! Current room bonus doubled for 1 hour');
            } else if (itemId === 'upgrade_kit') {
                // Reduce a building timer by 1 hour
                const timerKeys = Object.keys(gameState.hqBuildTimers || {});
                if (!timerKeys.length) { showHQAlert('No rooms currently building!'); return; }
                const roomId = timerKeys[0];
                gameState.hqBuildTimers[roomId].startTime -= 3600000;
                showHQAlert('OK:Build time reduced by 1 hour!');
                renderHQRooms();
            } else if (itemId === 'wall_mural') {
                showHQAlert('OK:Wall Mural applied! Your HQ looks legendary ðŸŽ¨');
            } else if (itemId === 'chill_trap') {
                gameState.chillTrapActive = true;
                showHQAlert('OK:Chill Trap set! +5% loot on next raid win');
            } else if (itemId === 'neon_armor') {
                gameState.neonArmorActive = true;
                showHQAlert('OK:Neon Armor equipped! Next raid loss reduced by 50%');
            } else if (itemId === 'star_lantern') {
                showHQAlert('OK:Star Lantern hung! Beautiful âœ¨');
            }
            gameState.ownedHQItems[itemId] = Math.max(0, (owned[itemId] || 1) - 1);
            saveGame(); renderHQItemsVault();
        }

        function renderHQItemsShop() {
            const el = document.getElementById('hqItemsShop');
            if (!el) return;
            if (!gameState.ownedHQItems) gameState.ownedHQItems = {};
            el.innerHTML = HQ_MARKET_ITEMS.map(item => {
                const owned = gameState.ownedHQItems[item.id] || 0;
                const canAffordC = item.costChills === 0 || gameState.chills >= item.costChills;
                const canAffordD = item.costDia === 0 || gameState.diamonds >= item.costDia;
                const canAfford = canAffordC && canAffordD;
                return `<div class="glass rounded-2xl p-4 border border-white/10">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex items-start gap-3 flex-1">
                            <i data-lucide="${item.icon}" style="width:20px;height:20px;color:#00f5ff;flex-shrink:0;margin-top:2px;"></i>
                            <div class="flex-1">
                                <p class="font-orbitron font-bold text-white text-sm">${item.name}</p>
                                <p class="text-white/40 text-xs mt-1">${item.desc}</p>
                                <div class="flex gap-2 mt-2">
                                    ${item.costChills > 0 ? `<span class="text-xs text-neon-cyan">${formatNumber(item.costChills)} C</span>` : ''}
                                    ${item.costDia > 0 ? `<span class="text-xs font-bold" style="color:#ffd700;">${item.costDia} â—†</span>` : ''}
                                    ${owned > 0 ? `<span class="text-xs text-neon-green font-bold">Owned: ${owned}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="buyHQItem('${item.id}')" class="flex-shrink-0 px-3 py-2 rounded-xl font-orbitron font-bold text-xs transition-all ${canAfford ? 'bg-red-400/20 border border-red-400/50 text-red-400 hover:bg-red-400/30' : 'bg-white/5 border border-white/10 text-white/30 cursor-not-allowed'}">BUY</button>
                    </div>
                </div>`;
            }).join('');
            if (window.lucide) window.lucide.createIcons();
        }

        function buyHQItem(itemId) {
            const item = HQ_MARKET_ITEMS.find(i => i.id === itemId);
            if (!item) return;
            if (item.costChills > 0 && gameState.chills < item.costChills) { alert('Not enough Chills!'); return; }
            if (item.costDia > 0 && gameState.diamonds < item.costDia) { alert('Not enough Diamonds!'); return; }
            if (item.costChills > 0) gameState.chills -= item.costChills;
            if (item.costDia > 0) { gameState.diamonds -= item.costDia; }
            if (!gameState.ownedHQItems) gameState.ownedHQItems = {};
            gameState.ownedHQItems[itemId] = (gameState.ownedHQItems[itemId] || 0) + 1;
            // Apply effects
            if (itemId === 'shield_24h' && window.fbActivateShield) {
                window.fbActivateShield();
                gameState.hqShieldExpiry = Date.now() + 24 * 60 * 60 * 1000;
            }
            if (itemId === 'chill_plant') {
                gameState.achievementCpsMult = (gameState.achievementCpsMult || 1) + 0.005;
            }
            if (itemId === 'beacon' && gameState.hqMineLastPayout) {
                gameState.hqMineBeaconActive = true;
            }
            saveGame(); updateUI(); renderHQItemsShop(); renderHQItemsVault();
            showHQAlert('OK:' + item.name + ' purchased!');
        }

        // â”€â”€ ARTEFACT DISCOUNT ON HQ ROOMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getArtefactDiscountForRoom(roomId) {
            if (!gameState.roomArtefacts) return 0;
            const artId = gameState.roomArtefacts[roomId];
            if (!artId) return 0;
            const art = ARTEFACTS.find(a => a.id === artId);
            if (!art) return 0;
            // Discount = artefact cost * 0.1 (10% of artefact value as flat reduction)
            return art.currency === 'chills' ? Math.floor(art.cost * 0.1) : 0;
        }

        function applyArtefactToRoom(roomId, artId) {
            if (!gameState.roomArtefacts) gameState.roomArtefacts = {};
            if (gameState.roomArtefacts[roomId]) { showHQAlert('Room already has an artefact applied!'); return; }
            // Check artefact is owned and not used
            if (!gameState.artefactsOwned[artId]) { showHQAlert('You don\'t own this artefact!'); return; }
            if (!gameState.artefactsOwned) gameState.artefactsOwned = {};
            const usedInRoom = Object.values(gameState.roomArtefacts || {});
            if (usedInRoom.includes(artId)) { showHQAlert('Artefact already applied to another room!'); return; }
            gameState.roomArtefacts[roomId] = artId;
            saveGame();
            renderHQRooms();
            showHQAlert('OK:Artefact applied! Room discount active.');
        }

        // â”€â”€ DAILY LEADERBOARD REWARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function checkDailyLeaderboardReward() {
            const today = new Date().toDateString();
            const lastCheck = localStorage.getItem('lbRewardCheck');
            if (lastCheck === today) return;
            localStorage.setItem('lbRewardCheck', today);
            if (window.fbCheckDailyLeaderboardReward) window.fbCheckDailyLeaderboardReward();
        }
        
        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            
            // Initialize Lucide icons
            if (window.lucide) window.lucide.createIcons();
            
            const hasSave = loadGame();
            
            if (hasSave && gameState.username) {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainGame').classList.remove('hidden');
                updateUI();
                updateWalletUI();
                // Check daily leaderboard reward after a short delay
                setTimeout(checkDailyLeaderboardReward, 3000);
            }
            
            // Enter button
            document.getElementById('enterBtn').addEventListener('click', () => {
                const username = document.getElementById('usernameInput').value.trim();
                const email = document.getElementById('emailInput').value.trim();
                
                if (!username) {
                    alert('Please enter your Chill Handle!');
                    return;
                }
                
                gameState.username = username;
                gameState.email = email;
                saveGame();
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainGame').classList.remove('hidden');
                updateUI();
                setTimeout(checkDailyLeaderboardReward, 3000);
            });
            
            // Tab buttons (all .tab-btn elements)
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                    // Close side menu when a nav item is clicked
                    closeSideMenu();
                });
            });

            // ===== SIDE MENU =====
            function openSideMenu() {
                document.getElementById('sideMenu').classList.remove('-translate-x-full');
                document.getElementById('menuOverlay').classList.remove('hidden');
            }
            function closeSideMenu() {
                document.getElementById('sideMenu').classList.add('-translate-x-full');
                document.getElementById('menuOverlay').classList.add('hidden');
            }
            document.getElementById('menuToggleBtn').addEventListener('click', () => {
                const isOpen = !document.getElementById('sideMenu').classList.contains('-translate-x-full');
                isOpen ? closeSideMenu() : openSideMenu();
            });
            document.getElementById('menuOverlay').addEventListener('click', closeSideMenu);

            // ===== SETTINGS DROPDOWN =====
            document.getElementById('settingsToggleBtn').addEventListener('click', () => {
                document.getElementById('settingsDropdown').classList.toggle('hidden');
            });
            
            // Chill Core â€” fires instantly on touchstart (mobile) or click (desktop)
            const coreBtn = document.getElementById('chillCore');
            let coreTouched = false;
            coreBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                coreTouched = true;
                clickChillCore(e);
            }, { passive: false });
            coreBtn.addEventListener('touchend', () => { coreTouched = false; }, { passive: true });
            coreBtn.addEventListener('touchcancel', () => { coreTouched = false; }, { passive: true });
            coreBtn.addEventListener('click', (e) => {
                // On desktop (no touch), fire on click. On mobile, touchstart already handled it.
                if (!coreTouched) clickChillCore(e);
                coreTouched = false;
            });
            
            // Ascend
            document.getElementById('ascendBtn').addEventListener('click', () => {
                if (calculateAscendDiamonds() <= 0) {
                    alert('You need at least 10,000 total Chills to ascend!');
                    return;
                }
                document.getElementById('ascendModal').classList.remove('hidden');
            });
            
            document.getElementById('cancelAscend').addEventListener('click', () => {
                document.getElementById('ascendModal').classList.add('hidden');
            });
            
            document.getElementById('confirmAscend').addEventListener('click', ascend);
            
            // Reset game
            document.getElementById('resetGameBtn').addEventListener('click', () => {
                document.getElementById('resetModal').classList.remove('hidden');
            });
            
            document.getElementById('cancelReset').addEventListener('click', () => {
                document.getElementById('resetModal').classList.add('hidden');
            });
            
            document.getElementById('confirmReset').addEventListener('click', resetGame);
            
            // Wallet
            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
            
            // NFT minting (old modal - keep for compatibility, but new system is in NFT tab)
            // New NFT mint buttons
            const startMintBtn = document.getElementById('startMintBtn');
            const cancelMintBtn = document.getElementById('cancelMintBtn');
            const claimNftBtn = document.getElementById('claimNftBtn');
            if (startMintBtn) startMintBtn.addEventListener('click', startMint);
            if (cancelMintBtn) cancelMintBtn.addEventListener('click', cancelMint);
            if (claimNftBtn) claimNftBtn.addEventListener('click', claimNFT);

            // Stake buttons
            const stakeBuyBtn = document.getElementById('stakeBuyBtn');
            const stakeSellBtn = document.getElementById('stakeSellBtn');
            if (stakeBuyBtn) stakeBuyBtn.addEventListener('click', () => placeStake('buy'));
            if (stakeSellBtn) stakeSellBtn.addEventListener('click', () => placeStake('sell'));

            // Render NFT and artefact views
            renderNFTCollection();
            renderArtefactsVault();
            renderStakeHistory();
            renderDiamondStakeHistory();
            initStakeChart();
            initDiamondChart();
            renderHQRooms();
            updateHQBonusSummary();
            updateMyProfile();
            updateGiftLimitDisplay();
            
            // Edit name (top bar button)
            document.getElementById('editNameBtn').addEventListener('click', () => {
                document.getElementById('newNameInput').value = gameState.username;
                document.getElementById('editNameModal').classList.remove('hidden');
            });
            
            // Change name (settings dropdown button)
            document.getElementById('changeNameBtn').addEventListener('click', () => {
                document.getElementById('newNameInput').value = gameState.username;
                document.getElementById('editNameModal').classList.remove('hidden');
            });
            
            document.getElementById('cancelEditName').addEventListener('click', () => {
                document.getElementById('editNameModal').classList.add('hidden');
            });
            
            document.getElementById('saveName').addEventListener('click', () => {
                const newName = document.getElementById('newNameInput').value.trim();
                if (newName) {
                    if (newName !== gameState.username) {
                        gameState.nameChanges = (gameState.nameChanges || 0) + 1;
                    }
                    gameState.username = newName;
                    saveGame();
                    updateUI();
                }
                document.getElementById('editNameModal').classList.add('hidden');
            });
            
            // Toggles
            document.getElementById('toggleOffline').addEventListener('click', function() {
                gameState.settings.offlineProgress = !gameState.settings.offlineProgress;
                this.classList.toggle('bg-neon-green/30');
                this.classList.toggle('bg-white/10');
                this.querySelector('span').classList.toggle('right-1');
                this.querySelector('span').classList.toggle('left-1');
                this.querySelector('span').classList.toggle('bg-neon-green');
                this.querySelector('span').classList.toggle('bg-white/30');
                saveGame();
            });
            
            document.getElementById('toggleParticles').addEventListener('click', function() {
                gameState.settings.particles = !gameState.settings.particles;
                this.classList.toggle('bg-neon-green/30');
                this.classList.toggle('bg-white/10');
                this.querySelector('span').classList.toggle('right-1');
                this.querySelector('span').classList.toggle('left-1');
                this.querySelector('span').classList.toggle('bg-neon-green');
                this.querySelector('span').classList.toggle('bg-white/30');
                saveGame();
            });
            
            // Set initial toggle states
            if (!gameState.settings.offlineProgress) {
                document.getElementById('toggleOffline').click();
            }
            if (!gameState.settings.particles) {
                document.getElementById('toggleParticles').click();
            }

            // ===== MUSIC =====
            const bgMusic = document.getElementById('bgMusic');
            bgMusic.volume = 0.4;

            function applyMusicState() {
                if (gameState.settings.music) {
                    const p = bgMusic.play();
                    if (p !== undefined) p.catch(() => {});
                } else {
                    bgMusic.pause();
                }
            }

            // Unlock on VERY FIRST user gesture (required by mobile browsers)
            let musicUnlocked = false;
            function unlockMusic() {
                if (musicUnlocked) return;
                musicUnlocked = true;
                ['touchstart','touchend','mousedown','click','keydown'].forEach(evt => {
                    document.removeEventListener(evt, unlockMusic, true);
                });
                applyMusicState();
            }
            ['touchstart','touchend','mousedown','click','keydown'].forEach(evt => {
                document.addEventListener(evt, unlockMusic, { capture: true, once: true });
            });

            // Try immediately (works on desktop, blocked silently on mobile until gesture)
            bgMusic.play().then(() => {
                if (!gameState.settings.music) bgMusic.pause();
                musicUnlocked = true;
            }).catch(() => {});

            // Re-attempt play every time the player returns to the tab / app
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    if (gameState.settings.music) {
                        bgMusic.play().then(() => { musicUnlocked = true; }).catch(() => {});
                    }
                    saveGame();
                } else {
                    saveGame();
                }
            });

            // Set initial music toggle visual state
            if (!gameState.settings.music) {
                const btn = document.getElementById('toggleMusic');
                btn.classList.remove('bg-neon-green/30');
                btn.classList.add('bg-white/10');
                btn.querySelector('span').classList.remove('right-1', 'bg-neon-green');
                btn.querySelector('span').classList.add('left-1', 'bg-white/30');
            }

            document.getElementById('toggleMusic').addEventListener('click', function() {
                gameState.settings.music = !gameState.settings.music;
                this.classList.toggle('bg-neon-green/30');
                this.classList.toggle('bg-white/10');
                this.querySelector('span').classList.toggle('right-1');
                this.querySelector('span').classList.toggle('left-1');
                this.querySelector('span').classList.toggle('bg-neon-green');
                this.querySelector('span').classList.toggle('bg-white/30');
                applyMusicState();
                saveGame();
            });
            
        // ==================== DIAMOND â†” CHILLS CONVERSION ====================
        const CONV_DIA_PER_DAY     = 500;   // max diamonds â†’ chills per day
        const CONV_CHILL_B_PER_DAY = 500;   // max chills (billions) â†’ diamonds per day
        // Rate: 10 diamonds = 1,000,000,000 chills (1B)
        // So 1 diamond = 100,000,000 chills (100M)
        const CONV_CHILLS_PER_DIAMOND = 100_000_000; // 100M chills per diamond

        function getConvServerDay() {
            const serverNow = window.getServerNow ? window.getServerNow() : Date.now();
            const d = new Date(serverNow);
            return d.getUTCFullYear() + '-' + (d.getUTCMonth() + 1) + '-' + d.getUTCDate();
        }

        function getConvState() {
            const today = getConvServerDay();
            if (!gameState.convDay || gameState.convDay !== today) {
                gameState.convDay       = today;
                gameState.convDiaUsed   = 0;
                gameState.convChillUsed = 0;
            }
            return {
                diaUsed:   gameState.convDiaUsed   || 0,
                chillUsed: gameState.convChillUsed || 0,
            };
        }

        function setConvertTab(tab) {
            const isToChills = tab === 'toChills';
            const btnC = document.getElementById('convTabToChills');
            const btnD = document.getElementById('convTabToDiamonds');
            const panC = document.getElementById('convPanelToChills');
            const panD = document.getElementById('convPanelToDiamonds');
            if (!btnC) return;

            if (isToChills) {
                btnC.style.cssText = 'flex:1;padding:8px;background:rgba(255,215,0,0.15);border:1px solid rgba(255,215,0,0.55);border-radius:8px;color:#ffd700;font-family:Orbitron,sans-serif;font-size:0.75rem;font-weight:700;cursor:pointer;';
                btnD.style.cssText = 'flex:1;padding:8px;background:rgba(0,245,255,0.05);border:1px solid rgba(0,245,255,0.15);border-radius:8px;color:rgba(0,245,255,0.4);font-family:Orbitron,sans-serif;font-size:0.75rem;font-weight:700;cursor:pointer;';
                panC.classList.remove('hidden');
                panD.classList.add('hidden');
            } else {
                btnD.style.cssText = 'flex:1;padding:8px;background:rgba(0,245,255,0.15);border:1px solid rgba(0,245,255,0.55);border-radius:8px;color:#00f5ff;font-family:Orbitron,sans-serif;font-size:0.75rem;font-weight:700;cursor:pointer;';
                btnC.style.cssText = 'flex:1;padding:8px;background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.15);border-radius:8px;color:rgba(255,215,0,0.4);font-family:Orbitron,sans-serif;font-size:0.75rem;font-weight:700;cursor:pointer;';
                panD.classList.remove('hidden');
                panC.classList.add('hidden');
            }
            updateConvLimitBars();
        }

        function updateConvLimitBars() {
            const { diaUsed, chillUsed } = getConvState();

            const diaBar   = document.getElementById('convDiaBar');
            const diaLabel = document.getElementById('convDiaUsedLabel');
            const cBar     = document.getElementById('convChillBar');
            const cLabel   = document.getElementById('convChillUsedLabel');

            if (diaBar)   diaBar.style.width  = Math.min(100, (diaUsed / CONV_DIA_PER_DAY) * 100) + '%';
            if (diaLabel) diaLabel.textContent = diaUsed + ' / ' + CONV_DIA_PER_DAY;
            if (cBar)     cBar.style.width     = Math.min(100, (chillUsed / CONV_CHILL_B_PER_DAY) * 100) + '%';
            if (cLabel)   cLabel.textContent   = chillUsed + 'B / ' + CONV_CHILL_B_PER_DAY + 'B';
        }

        function updateConvPreview(direction) {
            if (direction === 'toChills') {
                const dias     = Math.max(0, Math.floor(parseFloat(document.getElementById('convDiaInput')?.value) || 0));
                const chillOut = dias * CONV_CHILLS_PER_DIAMOND;
                const prev     = document.getElementById('convChillsPreview');
                if (prev) prev.textContent = dias > 0 ? formatNumber(chillOut) + ' Chills' : '0 Chills';
            } else {
                const billionsIn = Math.max(0, Math.floor(parseFloat(document.getElementById('convChillInput')?.value) || 0));
                // 1B chills = (1B / CONV_CHILLS_PER_DIAMOND) diamonds = 10 diamonds
                const diasOut    = Math.floor((billionsIn * 1e9) / CONV_CHILLS_PER_DIAMOND);
                const prev       = document.getElementById('convDiaPreview');
                if (prev) prev.textContent = billionsIn > 0 ? diasOut + ' Diamonds' : '0 Diamonds';
            }
        }

        function executeConvert(direction) {
            const { diaUsed, chillUsed } = getConvState();

            if (direction === 'toChills') {
                const dias = Math.floor(parseFloat(document.getElementById('convDiaInput')?.value) || 0);
                if (!dias || dias <= 0)          { showHQAlert('Enter how many Diamonds to convert!'); return; }
                if (dias > gameState.diamonds)    { showHQAlert('Not enough Diamonds! You have ' + gameState.diamonds + '.'); return; }
                const remaining = CONV_DIA_PER_DAY - diaUsed;
                if (dias > remaining)             { showHQAlert('Daily limit! ' + remaining + ' Diamonds left to convert today.'); return; }

                const chillsOut = dias * CONV_CHILLS_PER_DIAMOND;
                gameState.diamonds    -= dias;
                gameState.chills      += chillsOut;
                gameState.totalChills += chillsOut;
                gameState.convDiaUsed  = (gameState.convDiaUsed || 0) + dias;

                document.getElementById('convDiaInput').value = '';
                document.getElementById('convChillsPreview').textContent = '0 Chills';
                saveGame(); updateUI(); updateConvLimitBars();

                const toast = document.createElement('div');
                toast.className = 'achievement-toast';
                toast.innerHTML = `<div class="glass-strong rounded-2xl p-4 border text-center" style="border-color:rgba(255,215,0,0.4);box-shadow:0 0 20px rgba(255,215,0,0.2)">
                    <p class="font-orbitron font-bold" style="color:#ffd700;">â—† CONVERSION COMPLETE</p>
                    <p class="text-white/70 text-sm mt-1">-${dias} Diamonds â†’ +${formatNumber(chillsOut)} Chills</p></div>`;
                document.body.appendChild(toast);
                setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 4000);

            } else {
                const billionsIn = Math.floor(parseFloat(document.getElementById('convChillInput')?.value) || 0);
                if (!billionsIn || billionsIn <= 0) { showHQAlert('Enter how many Billions of Chills to convert!'); return; }
                const chillsIn = billionsIn * 1e9;
                if (chillsIn > gameState.chills)    { showHQAlert('Not enough Chills! You need ' + formatNumber(chillsIn) + '.'); return; }
                const remaining = CONV_CHILL_B_PER_DAY - chillUsed;
                if (billionsIn > remaining)          { showHQAlert('Daily limit! ' + remaining + 'B Chills left to convert today.'); return; }

                const diasOut = Math.floor(chillsIn / CONV_CHILLS_PER_DIAMOND);
                if (diasOut <= 0) { showHQAlert('Not enough Chills! Minimum is 100M Chills (= 1 Diamond).'); return; }

                gameState.chills         -= chillsIn;
                gameState.diamonds       += diasOut;
                gameState.totalDiamonds   = (gameState.totalDiamonds || 0) + diasOut;
                gameState.convChillUsed   = (gameState.convChillUsed || 0) + billionsIn;

                document.getElementById('convChillInput').value = '';
                document.getElementById('convDiaPreview').textContent = '0 Diamonds';
                saveGame(); updateUI(); updateConvLimitBars();

                const toast = document.createElement('div');
                toast.className = 'achievement-toast';
                toast.innerHTML = `<div class="glass-strong rounded-2xl p-4 border text-center" style="border-color:rgba(0,245,255,0.4);box-shadow:0 0 20px rgba(0,245,255,0.2)">
                    <p class="font-orbitron font-bold text-neon-cyan">â—† CONVERSION COMPLETE</p>
                    <p class="text-white/70 text-sm mt-1">-${formatNumber(chillsIn)} Chills â†’ +${diasOut} Diamonds</p></div>`;
                document.body.appendChild(toast);
                setTimeout(() => { toast.classList.add('toast-out'); setTimeout(() => toast.remove(), 400); }, 4000);
            }
        }

        // ==================== END CONVERSION ====================

            // Game loop (10x per second)
            setInterval(() => {
                const cps = getCPS();
                const increment = cps / 10;
                gameState.chills += increment;
                gameState.totalChills += increment;
                updateUI();
                updateMintUI();
                updateStakeUI();
                updateDiamondStakeUI();
                updateHQMineTimer();
            }, 100);

            // HQ rooms re-render every 5s (affordability + build timers)
            setInterval(() => {
                renderHQRooms();
                updateHQBonusSummary();
            }, 5000);

            // Stake chart updates (every 3 seconds)
            setInterval(updateStakeChart, 3000);
            setInterval(updateDiamondChart, 3000);
            
            // Auto save every 30 seconds
            setInterval(saveGame, 30000);
            
            // Save on tab close
            window.addEventListener('beforeunload', saveGame);
            
            // Dismiss offline progress on click
            document.getElementById('offlineProgress').addEventListener('click', () => {
                document.getElementById('offlineProgress').classList.add('hidden');
            });
        });
    </script>
</body>
</html>
